#!/usr/bin/env node
"use strict";var kr=Object.create;var Qt=Object.defineProperty;var Mr=Object.getOwnPropertyDescriptor;var Dr=Object.getOwnPropertyNames;var Ur=Object.getPrototypeOf,Br=Object.prototype.hasOwnProperty;var Fr=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of Dr(t))!Br.call(e,s)&&s!==n&&Qt(e,s,{get:()=>t[s],enumerable:!(r=Mr(t,s))||r.enumerable});return e};var N=(e,t,n)=>(n=e!=null?kr(Ur(e)):{},Fr(t||!e||!e.__esModule?Qt(n,"default",{value:e,enumerable:!0}):n,e));var pe=require("path"),Se=require("fs"),R=(0,pe.resolve)(__dirname,"..");for(;!(0,Se.existsSync)(`${R}/package.json`);){let e=(0,pe.resolve)(R,"..");if(e===R){R=process.cwd();break}R=e}var H,lt,ct,ut,ft,Fe,Yt={EXT_DIR:{type:"path",default:(0,pe.resolve)(R,"config/ext")},MONGODB_CONNECTION_URL:{type:"string",default:"mongodb://127.0.0.1/genieacs"},CWMP_WORKER_PROCESSES:{type:"int",default:0},CWMP_PORT:{type:"int",default:7547},CWMP_INTERFACE:{type:"string",default:"::"},CWMP_SSL_CERT:{type:"string",default:""},CWMP_SSL_KEY:{type:"string",default:""},CWMP_LOG_FILE:{type:"path",default:""},CWMP_ACCESS_LOG_FILE:{type:"path",default:""},NBI_WORKER_PROCESSES:{type:"int",default:0},NBI_PORT:{type:"int",default:7557},NBI_INTERFACE:{type:"string",default:"::"},NBI_SSL_CERT:{type:"string",default:""},NBI_SSL_KEY:{type:"string",default:""},NBI_LOG_FILE:{type:"path",default:""},NBI_ACCESS_LOG_FILE:{type:"path",default:""},FS_WORKER_PROCESSES:{type:"int",default:0},FS_PORT:{type:"int",default:7567},FS_INTERFACE:{type:"string",default:"::"},FS_SSL_CERT:{type:"string",default:""},FS_SSL_KEY:{type:"string",default:""},FS_URL_PREFIX:{type:"string",default:""},FS_LOG_FILE:{type:"path",default:""},FS_ACCESS_LOG_FILE:{type:"path",default:""},UI_WORKER_PROCESSES:{type:"int",default:0},UI_PORT:{type:"int",default:3e3},UI_INTERFACE:{type:"string",default:"::"},UI_SSL_CERT:{type:"string",default:""},UI_SSL_KEY:{type:"string",default:""},UI_LOG_FILE:{type:"path",default:""},UI_ACCESS_LOG_FILE:{type:"path",default:""},UI_JWT_SECRET:{type:"string",default:""},UDP_CONNECTION_REQUEST_PORT:{type:"int",default:0},FORWARDED_HEADER:{type:"string",default:""},DOWNLOAD_TIMEOUT:{type:"int",default:3600},EXT_TIMEOUT:{type:"int",default:3e3},MAX_CACHE_TTL:{type:"int",default:86400},DEBUG_FILE:{type:"path",default:""},DEBUG_FORMAT:{type:"string",default:"yaml"},DEBUG:{type:"bool",default:!1},RETRY_DELAY:{type:"int",default:300},SESSION_TIMEOUT:{type:"int",default:30},CONNECTION_REQUEST_TIMEOUT:{type:"int",default:2e3},GPN_NEXT_LEVEL:{type:"int",default:0},GPV_BATCH_SIZE:{type:"int",default:32},MAX_DEPTH:{type:"int",default:16},COOKIES_PATH:{type:"string"},LOG_FORMAT:{type:"string",default:"simple"},ACCESS_LOG_FORMAT:{type:"string",default:""},MAX_CONCURRENT_REQUESTS:{type:"int",default:20},DATETIME_MILLISECONDS:{type:"bool",default:!0},BOOLEAN_LITERAL:{type:"bool",default:!0},CONNECTION_REQUEST_ALLOW_BASIC_AUTH:{type:"bool",default:!1},MAX_COMMIT_ITERATIONS:{type:"int",default:32},DEVICE_ONLINE_THRESHOLD:{type:"int",default:4e3},XMPP_JID:{type:"string",default:""},XMPP_PASSWORD:{type:"string",default:""}},F={};function I(e,t,n=!1){if(F[e]!=null)return!0;(e==="CONFIG_DIR"||e==="config-dir")&&(H=H||(0,pe.resolve)(R,t)),(e==="CWMP_SSL"||e==="cwmp-ssl")&&(lt=lt||String(t).toLowerCase().trim()),(e==="NBI_SSL"||e==="nbi-ssl")&&(ct=ct||String(t).toLowerCase().trim()),(e==="FS_SSL"||e==="fs-ssl")&&(ut=ut||String(t).toLowerCase().trim()),(e==="UI_SSL"||e==="ui-ssl")&&(ft=ft||String(t).toLowerCase().trim()),(e==="FS_HOSTNAME"||e==="fs-hostname")&&(Fe=Fe||String(t).trim()),(e==="PRESETS_CACHE_DURATION"||e==="presets-cache-duration")&&I("MAX_CACHE_TTL",t),(e==="GET_PARAMETER_NAMES_DEPTH_THRESHOLD"||e==="get-parameter-names-depth-threshold")&&I("GPN_NEXT_LEVEL",t),(e==="TASK_PARAMETERS_BATCH_SIZE"||e==="task-parameters-batch-size")&&I("GPV_BATCH_SIZE",t),(e==="FS_IP"||e==="fs-ip")&&I("FS_HOSTNAME",t);function r(i,a){switch(a){case"int":return Number(i);case"bool":return["true","1"].includes(String(i).trim().toLowerCase());case"string":return String(i);case"path":return i?(0,pe.resolve)(i):"";default:return null}}let s=null;for(let[i,a]of Object.entries(Yt)){let o=i;if(n&&(o=o.toLowerCase().replace(/_/g,"-")),e===o?(s=r(t,a.type),o=i):e.startsWith(`${o}-`)&&(s=r(t,a.type),o=`${i}-${e.slice(i.length+1)}`),s!=null)return F[o]=s,process.env[`GENIEACS_${o}`]=s,!0}return!1}var at=process.argv.slice(2);for(;at.length;){let e=at.shift();if(e[0]==="-"){let t=at.shift();I(e.slice(2),t,!0)}}for(let[e,t]of Object.entries(process.env))e.startsWith("GENIEACS_")&&I(e.slice(9),t);var Zt=H?`${H}/config.json`:`${R}/config/config.json`;if((0,Se.existsSync)(Zt)){let e=JSON.parse((0,Se.readFileSync)(Zt).toString());for(let[t,n]of Object.entries(e))I(t,n)||(process.env[`GENIEACS_${t}`]=`${n}`)}H&&I("EXT_DIR",`${H}/ext`);if(["true","1"].includes(lt)){let e=H||`${R}/config`;I("CWMP_SSL_CERT",`${e}/cwmp.crt`),I("CWMP_SSL_KEY",`${e}/cwmp.key`)}if(["true","1"].includes(ct)){let e=H||`${R}/config`;I("NBI_SSL_CERT",`${e}/cwmp.crt`),I("NBI_SSL_KEY",`${e}/cwmp.key`)}if(["true","1"].includes(ut)){let e=H||`${R}/config`;I("FS_SSL_CERT",`${e}/cwmp.crt`),I("FS_SSL_KEY",`${e}/cwmp.key`)}if(["true","1"].includes(ft)){let e=H||`${R}/config`;I("UI_SSL_CERT",`${e}/cwmp.crt`),I("UI_SSL_KEY",`${e}/cwmp.key`)}if(Fe){let e=F.FS_PORT||7567,t=!!F.FS_SSL_CERT;I("FS_URL_PREFIX",(t?"https":"http")+`://${Fe}:${e}/`)}for(let[e,t]of Object.entries(Yt))t.default!=null&&I(e,t.default);function v(e,t){if(!t)return F[e];e=`${e}-${t}`;let n=F[e];if(n!=null)return n;let r=e.lastIndexOf("-");return n=F[e.slice(0,r)],n!=null||(r=e.lastIndexOf("-",r-1),n=F[e.slice(0,r)],n!=null)||(r=e.lastIndexOf("-",r-1),n=F[e.slice(0,r)],n!=null)||(r=e.lastIndexOf("-",r-1),r>0&&(n=F[e.slice(0,r)],n!=null))?n:null}var T=N(require("fs")),ie=N(require("os"));var _e=require("ipaddr.js");var mt=require("fs"),en=N(require("http")),tn=N(require("https")),pt=N(require("path"));var x,He,nn=!1;function Hr(e,t){if(!x)return void t();setTimeout(()=>{if(!t)return;x.removeListener("request",He),x.setTimeout(1);let n=t;t=null,setTimeout(n,1e3)},e).unref(),x.close(()=>{if(!t)return;let n=t;t=null,setTimeout(n,50)})}var rn=new WeakMap;function jr(e){return e.split(":").map(t=>(t=t.trim(),t.startsWith("-----BEGIN ")?Buffer.from(t):(0,mt.readFileSync)(pt.resolve(R,t))))}function Wr(e){return e.split(":").map(t=>(t=t.trim(),t.startsWith("-----BEGIN ")?Buffer.from(t):(0,mt.readFileSync)(pt.resolve(R,t))))}function sn(e,t){if(He=(n,r)=>{nn&&r.setHeader("Connection","close"),t(n,r).catch(s=>{try{r.socket.unref(),r.headersSent&&(r.writeHead(500,{Connection:"close"}),r.end(`${s.name}: ${s.message}`))}catch{}throw s})},e.ssl){let n={key:jr(e.ssl.key),cert:Wr(e.ssl.cert)};x=tn.createServer(n,He),e.onConnection&&x.on("secureConnection",e.onConnection)}else x=en.createServer(He),e.onConnection&&x.on("connection",e.onConnection);x.on("connection",n=>{rn.set(n,{localAddress:n.localAddress,localPort:n.localPort,remoteAddress:n.remoteAddress,remotePort:n.remotePort,remoteFamily:n.remoteFamily})}),e.onClientError&&x.on("clientError",(n,r)=>{n.code!=="ECONNRESET"&&r.writable&&r.end(`HTTP/1.1 400 Bad Request\r
Connection: close\r
\r
`),e.onClientError(n,r)}),x.timeout=e.timeout||0,e.keepAliveTimeout!=null&&(x.keepAliveTimeout=e.keepAliveTimeout),e.requestTimeout!=null&&(x.requestTimeout=e.requestTimeout),x.listen({port:e.port,host:e.host})}function je(e=!0){return nn=e,new Promise((t,n)=>{setTimeout(()=>{n(new Error("Could not close server in a timely manner"))},3e4).unref(),Hr(2e4,t)})}function dt(e){var t;return rn.get((t=e._parent)!=null?t:e)}var Gr=""+v("FORWARDED_HEADER"),on=new WeakMap,gt=[];for(let e of Gr.split(",").map(t=>t.trim()))try{gt.push((0,_e.parseCIDR)(e))}catch{try{let n=(0,_e.parse)(e);gt.push([n,n.toByteArray().length*8])}catch{}}function Vr(e){e=e.toLowerCase();let t={},n=0,r=-1,s;for(let i=0;i<e.length;++i){let a=e.charCodeAt(i);if(a===61)n>=0&&(s=e.slice(n,i).trim(),n=-1,r=i+1);else if(a===59)r>=0&&(t[s]=e.slice(r,i).trim()),r=-1,n=i+1;else{if(a===44)return r>=0&&(t[s]=e.slice(r,i).trim()),t;if(a===34&&r>=0){let o=i;if(!e.slice(r,o).trim())for(i=i+1;i<e.length;++i){let l=e.charCodeAt(i);if(l===92&&++i,l===34){t[s]=JSON.parse(e.slice(o,i+1).trim()),r=-1,n=i+1;break}}}}}return r>=0&&(t[s]=e.slice(r).trim()),t}function Ae(e){let t=on.get(e);if(!t){let n=e.socket,r=dt(n);t={localAddress:r.localAddress,localPort:r.localPort,remoteAddress:r.remoteAddress,remotePort:r.remotePort,host:e.headers.host,encrypted:!!e.socket.encrypted};let s=e.headers.forwarded;if(s){let i=(0,_e.parse)(r.remoteAddress);if(gt.some(a=>i.kind()===a[0].kind()&&i.match(a))){let a=Vr(s);if(a.proto==="https"?(t.encrypted=!0,t.localPort=443):a.proto==="http"&&(t.encrypted=!1,t.localPort=80),a.host){t.host=a.host;let[,o]=a.host.split(":",2);t.localPort=+o||t.localPort}if(a.for)if(a.for.startsWith("[")){let o=a.for.lastIndexOf("]");o>=0&&(t.remoteAddress=a.for.slice(1,o),t.remotePort=parseInt(a.for.slice(o+2))||t.remotePort)}else{let o=a.for.lastIndexOf(":");o>=0?(t.remoteAddress=a.for.slice(0,o),t.remotePort=parseInt(a.for.slice(o+1))||t.remotePort):t.remoteAddress=a.for}if(a.by)if(a.by.startsWith("[")){let o=a.by.lastIndexOf("]");o>=0&&(t.localAddress=a.by.slice(1,o),t.localPort=parseInt(a.by.slice(o+2))||t.localPort)}else{let o=a.by.lastIndexOf(":");o>=0?(t.localAddress=a.by.slice(0,o),t.localPort=parseInt(a.by.slice(o+1))||t.localPort):t.localAddress=a.by}}}on.set(e,t)}return t}var X=6e4,an=v("LOG_FORMAT"),Kr=v("ACCESS_LOG_FORMAT")||an,de={},ht=!1,wt=!1,re,se,G=T.createWriteStream(null,{fd:process.stderr.fd}),ge=T.fstatSync(G.fd),V=T.createWriteStream(null,{fd:process.stdout.fd}),he=T.fstatSync(V.fd);function We(){let e=1;re&&(++e,T.stat(re,(t,n)=>{if(t&&!t.message.startsWith("ENOENT:"))throw t;n&&n.dev===ge.dev&&n.ino===ge.ino||(G.end(),G=T.createWriteStream(null,{fd:T.openSync(re,"a")}),ge=T.fstatSync(G.fd)),--e===0&&setTimeout(We,X-Date.now()%X).unref()})),se&&(++e,T.stat(se,(t,n)=>{if(t&&!t.message.startsWith("ENOENT:"))throw t;n&&n.dev===he.dev&&n.ino===he.ino||(V.end(),V=T.createWriteStream(null,{fd:T.openSync(se,"a")}),he=T.fstatSync(V.fd)),--e===0&&setTimeout(We,X-Date.now()%X).unref()})),--e===0&&setTimeout(We,X-Date.now()%X).unref()}function ln(e,t){de.hostname=ie.hostname(),de.pid=process.pid,de.name=`genieacs-${e}`,de.version=t,re=v(`${e.toUpperCase()}_LOG_FILE`),se=v(`${e.toUpperCase()}_ACCESS_LOG_FILE`),re&&(G=T.createWriteStream(null,{fd:T.openSync(re,"a")}),ge=T.fstatSync(G.fd)),se&&(V=T.createWriteStream(null,{fd:T.openSync(se,"a")}),he=T.fstatSync(V.fd));let n=process.env.JOURNAL_STREAM;if(n){let[r,s]=n.split(":").map(parseInt);ht=ge.dev===r&&ge.ino===s,wt=he.dev===r&&he.ino===s}(re||se)&&setTimeout(We,X-Date.now()%X).unref()}function cn(){V.end(),G.end()}function Et(e){if(e.sessionContext){let t=e.sessionContext;e.deviceId=t.deviceId,e.remoteAddress=Ae(t.httpRequest).remoteAddress,delete e.sessionContext}if(e.exception){let t=e.exception;e.exceptionName=t.name,e.exceptionMessage=t.message,e.exceptionStack=t.stack,delete e.exception}if(e.task&&(e.taskId=e.task._id,delete e.task),e.rpc){let t=e.rpc;t.acsRequest?(e.acsRequestId=t.id,e.acsRequestName=t.acsRequest.name,t.acsRequest.commandKey&&(e.acsRequestCommandKey=t.acsRequest.commandKey)):t.cpeRequest?(e.cpeRequestId=t.id,t.cpeRequest.name==="Inform"?(e.informEvent=t.cpeRequest.event.join(","),e.informRetryCount=t.cpeRequest.retryCount):(e.cpeRequestName=t.cpeRequest.name,t.cpeRequest.commandKey&&(e.cpeRequestCommandKey=t.cpeRequest.commandKey))):t.cpeFault&&(e.acsRequestId=t.id,e.cpeFaultCode=t.cpeFault.detail.faultCode,e.cpeFaultString=t.cpeFault.detail.faultString),delete e.rpc}if(e.fault){let t=e.fault;e.faultCode=t.code,e.faultMessage=t.message,delete e.fault}e.context&&(e.remoteAddress=Ae(e.context.req).remoteAddress,e.context.state.user&&(e.user=e.context.state.user.username),delete e.context);for(let[t,n]of Object.entries(e))n==null&&delete e[t];return e}function un(e,t){if(t){let n="";return e.severity==="info"?n="<6>":e.severity==="warn"?n="<4>":e.severity==="error"&&(n="<3>"),`${n}${JSON.stringify(Et(e))}${ie.EOL}`}return`${JSON.stringify(Et(e))}${ie.EOL}`}function fn(e,t){let n={user:!0,remoteAddress:!0,severity:!0,timestamp:!0,message:!0,deviceId:!!e.sessionContext};Et(e);let r="";e.remoteAddress&&(e.deviceId&&n.deviceId?r=`${e.remoteAddress} ${e.deviceId}: `:e.user?r=`${e.user}@${e.remoteAddress}: `:r=`${e.remoteAddress}: `);let s=Object.keys(e),i="",a=[];for(let o of s)n[o]||a.push(`${o}=${JSON.stringify(e[o])}`);if(a.length&&(i=`; ${a.join(" ")}`),t){let o="";return e.severity==="info"?o="<6>":e.severity==="warn"?o="<4>":e.severity==="error"&&(o="<3>"),`${o}${r}${e.message}${i}${ie.EOL}`}return`${e.timestamp} [${e.severity.toUpperCase()}] ${r}${e.message}${i}${ie.EOL}`}function yt(e){e.timestamp=new Date().toISOString(),an==="json"?(e=Object.assign({},de,e),G.write(un(e,ht))):G.write(fn(e,ht))}function Q(e){e.severity="info",yt(e)}function mn(e){e.severity="warn",yt(e)}function oe(e){e.severity="error",yt(e)}function zr(e){e.timestamp=new Date().toISOString(),Kr==="json"?(Object.assign(e,de),V.write(un(e,wt))):V.write(fn(e,wt))}function pn(e){e.severity="info",zr(e)}var D=N(require("cluster")),dn=require("os");var qe=0,bt=[];function vt(){let e=D.default.fork();return e.on("error",t=>{if(t.code!=="EPIPE")throw t;setTimeout(()=>{if(!e.isDead())throw t},50)}),e}function St(e,t,n){let r={message:"Worker died",pid:e.process.pid,exitCode:null,signal:null};t!=null&&(r.exitCode=t),n!=null&&(r.signal=n),oe(r);let s=Date.now();bt.push(s);let i=0,a=0,o=0;if(bt=bt.filter(l=>{if(l>s-6e4)++i;else if(l>s-12e4)++a;else if(l>s-18e4)++o;else return!1;return!0}),i>5&&a>5&&o>5){process.exitCode=1,D.default.removeListener("exit",St);for(let l in D.default.workers)D.default.workers[l].kill();oe({message:"Too many crashes, exiting",pid:process.pid});return}if(qe=Math.max(s,qe+2e3),qe===s){vt();return}setTimeout(()=>{process.exitCode||vt()},qe-s)}function gn(e,t,n){D.default.on("listening",(r,s)=>{(s.addressType===4||s.addressType===6)&&s.address===n&&s.port===t&&Q({message:"Worker listening",pid:r.process.pid,address:s.address,port:s.port})}),D.default.on("exit",St),e||(e=Math.max(2,(0,dn.cpus)().length));for(let r=0;r<e;++r)vt()}function _t(){D.default.removeListener("exit",St);for(let e in D.default.workers)D.default.workers[e].kill()}var At=D.default.worker;var Jt=N(require("vm")),Ue=require("mongodb");var Re=N(require("crypto"));var Ve=require("mongodb");var we,E={devices:null,presets:null,objects:null,provisions:null,virtualParameters:null,faults:null,tasks:null,files:null,operations:null,permissions:null,users:null,config:null,cache:null,locks:null},Ge;async function hn(){Ge=Ve.MongoClient.connect(""+v("MONGODB_CONNECTION_URL"));let t=(await Ge).db();E.tasks=t.collection("tasks"),E.devices=t.collection("devices"),E.presets=t.collection("presets"),E.objects=t.collection("objects"),E.files=t.collection("fs.files"),E.provisions=t.collection("provisions"),E.virtualParameters=t.collection("virtualParameters"),E.faults=t.collection("faults"),E.operations=t.collection("operations"),E.permissions=t.collection("permissions"),E.users=t.collection("users"),E.config=t.collection("config"),E.cache=t.collection("cache"),E.locks=t.collection("locks"),we=new Ve.GridFSBucket(t),await Promise.all([E.tasks.createIndex({device:1,timestamp:1}),E.cache.createIndex({expire:1},{expireAfterSeconds:0}),E.locks.createIndex({expire:1},{expireAfterSeconds:0})])}async function wn(){Ge!=null&&await(await Ge).close()}var g=N(require("parsimmon"));function Qr(e){let t={b:"\b",f:"\f",n:`
`,r:"\r",t:"	"};return e.replace(/\\(u[0-9a-fA-F]{4}|[^u])/g,(n,r)=>{let s=r.charAt(0),i=r.slice(1);return s==="u"?String.fromCharCode(parseInt(i,16)):t.hasOwnProperty(s)?t[s]:s})}function Ee(e,t){if(!Array.isArray(e))return t(e);let n;for(let r=1;r<e.length;++r){let s=Ee(e[r],t);s!==e[r]&&(n=n||e.slice(),n[r]=s)}return t(n||e)}async function Tt(e,t){if(!Array.isArray(e))return t(e);let n;for(let r=1;r<e.length;++r){let s=await Tt(e[r],t);s!==e[r]&&(n=n||e.slice(),n[r]=s)}return t(n||e)}function Ce(e,t){return g.default.seqMap(t,g.default.seq(e,t).many(),(n,r)=>r.reduce((s,i)=>{let[a,o]=i;return Array.isArray(s)&&a===s[0]?s.concat([o]):[a,s,o]},n))}var Zr=g.default.createLanguage({ComparisonOperator:function(){return g.default.alt(g.default.string(">="),g.default.string("<>"),g.default.string("<="),g.default.string("="),g.default.string(">"),g.default.string("<")).skip(g.default.optWhitespace)},LikeOperator:function(){return g.default.alt(g.default.regexp(/like/i).result("LIKE").desc("LIKE"),g.default.regexp(/not\s+like/i).result("NOT LIKE").desc("NOT LIKE")).notFollowedBy(g.default.regexp(/[a-zA-Z0-9_]/)).skip(g.default.optWhitespace)},IsNullOperator:function(){return g.default.alt(g.default.regexp(/is\s+null/i).result("IS NULL").desc("IS NULL"),g.default.regexp(/is\s+not\s+null/i).result("IS NOT NULL").desc("IS NOT NULL")).notFollowedBy(g.default.regexp(/[a-zA-Z0-9_]/)).skip(g.default.optWhitespace)},NotOperator:function(){return g.default.regexp(/not/i).result("NOT").notFollowedBy(g.default.regexp(/[a-zA-Z0-9_]/)).skip(g.default.optWhitespace).desc("NOT")},AndOperator:function(){return g.default.regexp(/and/i).result("AND").notFollowedBy(g.default.regexp(/[a-zA-Z0-9_]/)).skip(g.default.optWhitespace).desc("AND")},OrOperator:function(){return g.default.regexp(/or/i).result("OR").notFollowedBy(g.default.regexp(/[a-zA-Z0-9_]/)).skip(g.default.optWhitespace).desc("OR")},Parameter:function(e){return g.default.alt(g.default.regexp(/[a-zA-Z0-9_.*-]+/),e.Expression.wrap(g.default.string("{").skip(g.default.optWhitespace),g.default.string("}"))).atLeast(1).map(t=>["PARAM",t.length>1?["||"].concat(t):t[0]]).skip(g.default.optWhitespace).desc("parameter")},StringValueSql:function(){return g.default.regexp(/'([^']*)'/,1).atLeast(1).skip(g.default.optWhitespace).map(e=>e.join("'")).desc("string")},StringValueJs:function(){return g.default.regexp(/"((?:\\.|.)*?)"/,1).skip(g.default.optWhitespace).map(Qr).desc("string")},NumberValue:function(){return g.default.regexp(/-?(0|[1-9][0-9]*)([.][0-9]+)?([eE][+-]?[0-9]+)?/).notFollowedBy(g.default.regexp(/[a-zA-Z0-9_]/)).skip(g.default.optWhitespace).map(Number).desc("number")},BooleanValue:function(){return g.default.alt(g.default.regexp(/true/i).result(!0).desc("TRUE"),g.default.regexp(/false/i).result(!1).desc("FALSE")).notFollowedBy(g.default.regexp(/[a-zA-Z0-9_]/)).skip(g.default.optWhitespace)},NullValue:function(){return g.default.regexp(/null/i).notFollowedBy(g.default.regexp(/[a-zA-Z0-9_]/)).skip(g.default.optWhitespace).result(null).desc("NULL")},FuncValue:function(e){return g.default.seqMap(g.default.regexp(/([a-zA-Z0-9_]+)/,1).skip(g.default.optWhitespace).desc("function"),e.ExpressionList.wrap(g.default.string("(").skip(g.default.optWhitespace),g.default.string(")").skip(g.default.optWhitespace)),(t,n)=>["FUNC",t.toUpperCase()].concat(n))},WhenPair:function(e){return g.default.seq(g.default.regexp(/when/i).notFollowedBy(g.default.regexp(/[a-zA-Z0-9_]/)).skip(g.default.optWhitespace).desc("WHEN").then(e.Expression),g.default.regexp(/then/i).notFollowedBy(g.default.regexp(/[a-zA-Z0-9_]/)).skip(g.default.optWhitespace).desc("THEN").then(e.Expression))},CaseStatement:function(e){return g.default.seqMap(g.default.regexp(/case/i).result("CASE").notFollowedBy(g.default.regexp(/[a-zA-Z0-9_]/)).skip(g.default.optWhitespace).desc("CASE"),e.WhenPair.many(),g.default.regexp(/else/i).notFollowedBy(g.default.regexp(/[a-zA-Z0-9_]/)).skip(g.default.optWhitespace).desc("ELSE").then(e.Expression).map(t=>[[!0,t]]).fallback(null).skip(g.default.regex(/end/i).notFollowedBy(g.default.regexp(/[a-zA-Z0-9_]/))).skip(g.default.optWhitespace),(...t)=>t.flat(2))},Value:function(e){return g.default.alt(e.NullValue,e.BooleanValue,e.NumberValue,e.StringValueSql,e.StringValueJs,e.FuncValue,e.CaseStatement)},ValueExpression:function(e){return Ce(g.default.string("||").skip(g.default.optWhitespace),Ce(g.default.alt(g.default.string("+"),g.default.string("-")).skip(g.default.optWhitespace),Ce(g.default.alt(g.default.string("*"),g.default.string("/"),g.default.string("%")).skip(g.default.optWhitespace),g.default.alt(e.Value,e.Parameter,e.Expression.wrap(g.default.string("(").skip(g.default.optWhitespace),g.default.string(")").skip(g.default.optWhitespace))))))},Comparison:function(e){return g.default.alt(g.default.seqMap(e.ValueExpression,e.IsNullOperator,(t,n)=>[n,t]),g.default.seqMap(e.ValueExpression,e.ComparisonOperator,e.ValueExpression,(t,n,r)=>[n,t,r]),g.default.seqMap(e.ValueExpression,e.LikeOperator,e.ValueExpression.skip(g.default.regexp(/escape/i).result("ESCAPE").skip(g.default.whitespace).desc("ESCAPE")),e.ValueExpression,(t,n,r,s)=>[n,t,r,s]),g.default.seqMap(e.ValueExpression,e.LikeOperator,e.ValueExpression,(t,n,r)=>[n,t,r]))},ExpressionList:function(e){return e.Expression.sepBy(g.default.string(",").skip(g.default.optWhitespace))},Expression:function(e){function t(n,r){return g.default.seq(n,r).or(r)}return Ce(e.OrOperator,Ce(e.AndOperator,t(e.NotOperator,e.Comparison.or(e.ValueExpression)))).trim(g.default.optWhitespace)}});function Ie(e){return e?Zr.Expression.tryParse(e):null}function Oe(e,t){let n=e.split("");for(let r=0;r<n.length;++r){let s=n[r];if(s===t)n[r]=n[r+1]||"",n[r+1]="";else if(s==="_")n[r]="\\_";else if(s==="%")for(n[r]="\\%";n[r+1]==="%";)n[++r]=""}return n.filter(r=>r)}var b=Array.isArray,Ke=new WeakMap,ae={};function ye(e,t){let n=!0;for(;n;){n=!1;for(let r=2;r<e.length;++r){let s=t(e[r-1],e[r],r-2);s!==ae&&(n=!0,e=e.slice(),e.splice(r-1,2,s))}}return e.length===2?e[1]:e}function En(e,t="",n=""){let r={"-":"\\-","/":"\\/","\\":"\\/","^":"\\^",$:"\\$","*":"\\*","+":"\\+","?":"\\?",".":"\\.","(":"\\(",")":"\\)","|":"\\|","[":"\\[","]":"\\]","{":"\\{","}":"\\}","\\%":".*","\\_":"."},s=Oe(e,t);if(!s.length)return new RegExp("^$",n);s=s.map(a=>r[a]||a),s[0]=s[0]===".*"?"":"^"+s[0];let i=s.length-1;return s[i]=[".*",""].includes(s[i])?"":s[i]+"$",new RegExp(s.join(""),n)}function be(e,t){return typeof e=="boolean"&&(e=+e),typeof t=="boolean"&&(t=+t),typeof e!=typeof t?typeof e=="string"?1:-1:e>t?1:e<t?-1:0}function k(e){switch(typeof e){case"number":return e;case"boolean":return+e;case"string":return parseFloat(e)||0}}function ze(e){switch(typeof e){case"string":return e;case"number":return e.toString();case"boolean":return(+e).toString()}}function Ct(e){if(!Array.isArray(e))return e;if(e[0]==="CASE"){for(let t=1;t<e.length;t+=2){if(Array.isArray(e[t]))return e;if(e[t])return e[t+1]}return null}else if(e[0]==="FUNC"){if(e[1]==="COALESCE"){let t=[];for(let n=2;n<e.length;++n){let r=e[n];if(r!=null&&(t.push(r),!Array.isArray(r)))break}return t.length?t.length===1?t[0]:["FUNC","COALESCE",...t]:null}else if(e[1]==="UPPER"){if(e[2]==null)return null;if(!b(e[2]))return ze(e[2]).toUpperCase()}else if(e[1]==="LOWER"){if(e[2]==null)return null;if(!b(e[2]))return ze(e[2]).toLowerCase()}else if(e[1]==="ROUND"){let t=e[2],n=e.length>3?e[3]:0;if(t==null||n==null)return null;if(!b(t)&&!b(n)){let r=10**n,s=t*r*(1+Number.EPSILON);return Math.round(s)/r}}}else if(e[0]==="PARAM"){if(e[1]==null)return null}else if(e[0]==="AND"){for(let n=1;n<e.length;++n)if(!Array.isArray(e[n])&&e[n]!=null&&!e[n])return!1;let t=[];for(let n=1;n<e.length;++n){let r=e[n];if(r==null)return null;Array.isArray(r)&&(r[0]==="AND"?t.push(...r.slice(1)):t.push(r))}return t.length?(t.length===1&&t.push(!0),["AND",...t]):!0}else if(e[0]==="OR"){let t=[];for(let n=1;n<e.length;++n){let r=e[n];if(Array.isArray(r))r[0]==="OR"?t.push(...r.slice(1)):t.push(r);else if(r)return!0}return t.length?(t.length===1&&t.push(!1),["OR",...t]):e.some(n=>n==null)?null:!1}else if(e[0]==="NOT"){if(e[1]==null)return null;if(b(e[1])){if(e[1][0]==="NOT")return e[1][1]}else return!e[1]}else{if(e[0]==="IS NULL")return b(e[1])?e:e[1]==null;if(e[0]==="IS NOT NULL")return b(e[1])?e:e[1]!=null;if(e[0]==="LIKE"){if(b(e[1])||b(e[2])||b(e[3]))return e;if(e[1]==null||e[2]==null||e.length>=4&&e[3]==null)return null;let t=Ke.get(e);return t||(t=En(e[2],e[3]),Ke.set(e,t)),t.test(e[1])}else if(e[0]==="NOT LIKE"){if(b(e[1])||b(e[2])||b(e[3]))return e;if(e[1]==null||e[2]==null||e.length>=4&&e[3]==null)return null;let t=Ke.get(e);return t||(t=En(e[2],e[3]),Ke.set(e,t)),!t.test(e[1])}else{if(e[0]==="=")return e[1]==null||e[2]==null?null:b(e[1])||b(e[2])?e:be(e[1],e[2])===0;if(e[0]==="<>")return e[1]==null||e[2]==null?null:b(e[1])||b(e[2])?e:be(e[1],e[2])!==0;if(e[0]===">")return e[1]==null||e[2]==null?null:b(e[1])||b(e[2])?e:be(e[1],e[2])>0;if(e[0]===">=")return e[1]==null||e[2]==null?null:b(e[1])||b(e[2])?e:be(e[1],e[2])>=0;if(e[0]==="<")return e[1]==null||e[2]==null?null:b(e[1])||b(e[2])?e:be(e[1],e[2])<0;if(e[0]==="<=")return e[1]==null||e[2]==null?null:b(e[1])||b(e[2])?e:be(e[1],e[2])<=0;if(e[0]==="*")return ye(e,(t,n)=>t==null||n==null?null:!b(t)&&!b(n)?k(t)*k(n):ae);if(e[0]==="/")return ye(e,(t,n,r)=>{if(t==null||n==null)return null;if(b(t)||b(n))return ae;let s=k(t),i=k(n);return r!==0?s*i:i===0?null:s/i});if(e[0]==="+")return ye(e,(t,n)=>t==null||n==null?null:!b(t)&&!b(n)?k(t)+k(n):ae);if(e[0]==="-")return ye(e,(t,n,r)=>t==null||n==null?null:!b(t)&&!b(n)?r===0?k(t)-k(n):k(t)+k(n):ae);if(e[0]==="%")return ye(e,(t,n,r)=>{if(t==null||n==null)return null;if(b(t)||b(n)||r!==0)return ae;let s=k(t),i=Math.trunc(k(n));return i===0?null:s%i});if(e[0]==="||")return ye(e,(t,n)=>t==null||n==null?null:!b(t)&&!b(n)?ze(t)+ze(n):ae)}}return e}function ve(e,t,n,r){return Ee(e,s=>{if(r&&(s=r(s)),!b(s))return s;if(s[0]==="FUNC"&&s[1]==="NOW"){if(n)return n}else if(s[0]==="PARAM"){if(s[1]==null)return null;if(t&&!b(s[1])){let i;return typeof t=="function"?i=t(s[1]):i=t[s[1]],i==null?null:(typeof i=="object"&&(i=i.value?i.value[0]:null),i)}}return Ct(s)})}async function yn(e,t,n,r){return Tt(e,async s=>{if(r&&(s=await r(s)),!b(s))return s;if(s[0]==="FUNC"){if(s[1]==="NOW"&&n)return n}else if(s[0]==="PARAM"){if(s[1]==null)return null;if(t&&!b(s[1])){let i=t[s[1]];return i==null?null:(typeof i=="object"&&(i=i.value?i.value[0]:null),i)}}return Ct(s)})}function It(e){return e.replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&")}function Ot(e){return encodeURIComponent(e).replace(/[!~*'().]/g,t=>"%"+t.charCodeAt(0).toString(16).toUpperCase()).replace(/0x(?=[0-9A-Z]{2})/g,"0%78").replace(/%/g,"0x")}function bn(e,t=!0){return new Promise(n=>{let r=setTimeout(n,e);t||r.unref()})}var ts=3e4,ns=+v("MAX_CACHE_TTL");async function vn(e){let t=await E.cache.findOne({_id:e});return t==null?void 0:t.value}async function j(e){await E.cache.deleteOne({_id:e})}async function Sn(e,t,n=ns){let r=new Date,s=new Date(r.getTime()+ts+n*1e3);await E.cache.replaceOne({_id:e},{value:t,expire:s,timestamp:r},{upsert:!0})}var An=3e4;async function W(e,t,n=0,r=Math.random().toString(36).slice(2)){try{let s=Date.now(),i=await E.locks.findOneAndUpdate({_id:e,value:r},{$set:{expire:new Date(s+t+An)},$currentDate:{timestamp:!0}},{upsert:!0,returnDocument:"after"});if(Math.abs(i.value.timestamp.getTime()-s)>An)throw new Error("Database clock skew too great")}catch(s){if(s.code!==11e3)throw s;if(!(n>0))return null;let i=50+Math.random()*50;return await new Promise(a=>setTimeout(a,i)),W(e,t,n-i,r)}return r}async function K(e,t){if((await E.locks.deleteOne({_id:e,value:t})).deletedCount!==1)throw new Error("Lock expired")}async function Rt(e){let t=await E.locks.findOne({_id:e});return t==null?void 0:t.value}var Je=5e3,rs=12e4,Xe=class{constructor(t,n){this.cacheKey=t;this.callback=n}nextRefresh=1;currentRevision=null;snapshots=new Map;async getRevision(){return Date.now()>this.nextRefresh&&await this.refresh(),this.currentRevision}hasRevision(t){return this.snapshots.has(t)}get(t){let n=this.snapshots.get(t);if(!n)throw new Error("Cache snapshot does not exist");return n}async refresh(){if(!this.nextRefresh){await bn(20),await this.refresh();return}let t=Date.now();if(t<this.nextRefresh)return;this.nextRefresh=0;let n=await vn(this.cacheKey);if(this.currentRevision&&n===this.currentRevision){this.nextRefresh=t+(Je-t%Je);return}let r=await W(this.cacheKey,5e3),[s,i]=await this.callback();if(this.currentRevision){let a=this.currentRevision,o=this.snapshots.get(a);setTimeout(()=>{this.snapshots.get(a)===o&&this.snapshots.delete(a)},rs).unref()}this.currentRevision=s,this.snapshots.set(s,i),r&&(s!==n&&await Sn(this.cacheKey,s,300),await K(this.cacheKey,r)),this.nextRefresh=t+(Je-t%Je)}};async function ss(){let e=await E.permissions.find().toArray();e.sort((r,s)=>r._id>s._id?1:-1);let t=Re.createHash("md5").update(JSON.stringify(e)).digest("hex"),n={};for(let r of e)n[r.role]||(n[r.role]={}),n[r.role][r.access]||(n[r.role][r.access]={}),n[r.role][r.access][r.resource]={access:r.access,filter:Ie(r.filter||"true")},r.validate&&(n[r.role][r.access][r.resource].validate=Ie(r.validate));return[t,n]}async function is(){let e=await E.users.find().toArray();e.sort((r,s)=>r._id>s._id?1:-1);let t=Re.createHash("md5").update(JSON.stringify(e)).digest("hex"),n={};for(let r of e)n[r._id]={password:r.password,salt:r.salt,roles:r.roles.split(",").map(s=>s.trim())};return[t,n]}async function os(){let e=await E.config.find().toArray();e.sort((s,i)=>s._id>i._id?1:-1);let t=Re.createHash("md5").update(JSON.stringify(e)).digest("hex"),n={filters:{},device:{},multiTabs:{},index:{},overview:{},pageSize:null},r={};for(let s of e){let i=ve(Ie(s.value));if(r[s._id]=i,s._id.startsWith("ui.")){let a=s._id.split(".");if(!(a[1]in n))continue;a.shift();let o=n;for(;a.length>1;){let l=a.shift();(o[l]==null||typeof o[l]!="object")&&(o[l]={}),o=o[l]}o[a[0]]=i}}return[t,r,n]}var Pt=new Xe("ui-local-cache-hash",as);async function as(){let e=await Promise.all([ss(),is(),os()]),t=Re.createHash("md5");for(let r of e)t.update(r[0]);let n={permissions:e[0][1],users:e[1][1],config:e[2][1],ui:e[2][2]};return[t.digest("hex"),n]}async function Qe(){return await Pt.getRevision()}function le(e,t,n,r,s){let i=Pt.get(e);if(!i)throw new Error("Cache snapshot does not exist");let a={"cwmp.downloadTimeout":"DOWNLOAD_TIMEOUT","cwmp.debug":"DEBUG","cwmp.retryDelay":"RETRY_DELAY","cwmp.sessionTimeout":"SESSION_TIMEOUT","cwmp.connectionRequestTimeout":"CONNECTION_REQUEST_TIMEOUT","cwmp.gpnNextLevel":"GPN_NEXT_LEVEL","cwmp.gpvBatchSize":"GPV_BATCH_SIZE","cwmp.cookiesPath":"COOKIES_PATH","cwmp.datetimeMilliseconds":"DATETIME_MILLISECONDS","cwmp.booleanLiteral":"BOOLEAN_LITERAL","cwmp.connectionRequestAllowBasicAuth":"CONNECTION_REQUEST_ALLOW_BASIC_AUTH","cwmp.maxCommitIterations":"MAX_COMMIT_ITERATIONS","cwmp.deviceOnlineThreshold":"DEVICE_ONLINE_THRESHOLD","cwmp.udpConnectionRequestPort":"UDP_CONNECTION_REQUEST_PORT"};if(!(t in i.config)){if(t in a){let l;return n!=null&&n.id?l=n.id:s&&(l=s(["PARAM","DeviceID.ID"]),Array.isArray(l)&&(l=null)),v(a[t],l)}return null}let o=ve(i.config[t],n,r,s);return Array.isArray(o)?null:o}function Tn(e,t){return Pt.get(e).config[t]}function Nt(e){if(e[""])return{"":e[""]};let t=Object.keys(e).sort();if(t.length<=1)return e;for(let n=1;n<t.length;++n){let r=t[n-1],s=t[n];s.startsWith(r)&&(s.charAt(r.length)==="."||s.charAt(r.length-1)===".")&&(delete e[s],t.splice(n--,1))}return e}function Cn(e){return Object.prototype.toString.call(e)==="[object Object]"}function ls(e,t){if(e.indexOf("*")===-1)return!1;let n=e.replace(/[[\]\\^$.|?+()]/,"\\$&");return n[0]==="*"?n=n.replace(/^\*+/g,""):n="^"+n,n[n.length-1]==="*"?n=n.replace(/\*+$/g,""):n=n+"$",n=n.replace(/[*]/,".*"),new RegExp(n,t)}function cs(e){if(typeof e=="string"){let t=[e],n=/^\/(.*?)\/(g?i?m?y?)$/.exec(e);n&&t.push({$regex:new RegExp(n[1],n[2])}),+e===parseFloat(e)&&t.push(+e);let r=new Date(e);e.length>=8&&r.getFullYear()>1983&&t.push(r);let s=ls(e);return s!==!1&&t.push({$regex:s}),t}return e}var us=new Set(["$eq","$gt","$gte","$in","$lt","$lte","$ne","$nin"]);function xt(e){if(Array.isArray(e)){let a=[];for(let o of e)a=a.concat(xt(o));return[a]}else if(!Cn(e)){let a=cs(e);return Array.isArray(a)?a:[a]}let t=[],n=[],r=[],s=[];for(let[a,o]of Object.entries(e))r.push(a),us.has(a)?s.push(xt(o)):s.push([o]),n.push(0);let i=0;for(;i<n.length;){let a={};for(let o=0;o<r.length;++o)a[r[o]]=s[o][n[o]];for(t.push(a),i=0;i<n.length&&(n[i]+=1,!(n[i]<s[i].length));++i)n[i]=0}return t}function fs(e,t){let n=[],r=xt(t);e[e.lastIndexOf(".")+1]!=="_"&&(e+="._value");for(let s of r){let i={};i[e]=s,n.push(i)}return n}function $t(e){let t={};for(let[n,r]of Object.entries(e))if(n[0]==="$")t[n]=r.map(s=>$t(s));else{let s=fs(n,r);if(s.length>1)if(t.$and=t.$and||[],r&&(r.$ne!=null||r.$not!=null)){if(Object.keys(r).length>1)throw new Error("Cannot mix $ne or $not with other operators");for(let i of s)t.$and.push(i)}else t.$and.push({$or:s});else Object.assign(t,s[0])}return t}function Ze(e,t){for(let[n,r]of Object.entries(e))if(n[0]==="$")for(let s of r)Ze(s,t);else if(n in t)if(Cn(r))for(let[s,i]of Object.entries(r))switch(s){case"$in":case"$nin":for(let a=0;a<i.length;++a)i[a]=t[n](i[a]);break;case"$eq":case"$gt":case"$gte":case"$lt":case"$lte":case"$ne":r[s]=t[n](i);break;case"$exists":case"$type":break;default:throw new Error("Operator not supported")}else e[n]=t[n](e[n]);return e}var mr=require("mongodb");var gs=require("bson");var _=require("espresso-iisojs");function Lt(e,t){return e+t}function z(e,t){return e*t}function Pe(e,t){return e/t}function In(e,t){return e**t}function On(e,t){return e%t}function kt(e){return Number(e)}function Mt(e,t){return e!==t}var J=BigInt;var Ut=J(0),Dt=J(1),ps=J(2),Pn=J(-1),ce=class e{constructor(t){this.map=new Map,t?(this.map.set(t,1),this.sortedKeys=[t]):this.sortedKeys=[]}reciprocal(){let t=new e;t.sortedKeys=this.sortedKeys,t.map=new Map;for(let[n,r]of this.map)t.map.set(n,0-r);return t}static multiply(t,n){let r=new e;r.sortedKeys=t.sortedKeys.slice(),r.map=new Map(t.map);for(let[s,i]of n.map){let a=r.map.get(s);if(!a)r.map.set(s,i),r.sortedKeys.push(s);else{let o=i+a;o?r.map.set(s,o):(r.map.delete(s),r.sortedKeys=r.sortedKeys.filter(l=>l!==s))}}return r.sortedKeys.sort((s,i)=>s.length!==i.length?i.length-s.length:s>i?1:s<i?-1:0),r}static compare(t,n){if(t.sortedKeys.length!==n.sortedKeys.length)return n.sortedKeys.length-t.sortedKeys.length;for(let r=0;r<t.sortedKeys.length;++r){let s=t.sortedKeys[r],i=t.map.get(s),a=n.sortedKeys[r],o=n.map.get(a);if(i!==o)return o-i;if(s.length>a.length)return-1;if(s.length<a.length)return 1;if(s>a)return 1;if(s<a)return-1}return 0}};function Nn(e,t){for(;Mt(t,Ut);){let n=t;t=On(e,t),e=n}return e}var Ye=class e{constructor(t){this.terms=t}static simplifyTerms(t){let n=t.slice().sort((r,s)=>ce.compare(r.indeterminates,s.indeterminates));for(let r=1;r<n.length;++r){let s=n[r-1],i=n[r];if(ce.compare(s.indeterminates,i.indeterminates)===0){let a=Lt(z(s.coefficientNumerator,i.coefficientDenominator),z(i.coefficientNumerator,s.coefficientDenominator)),o=z(s.coefficientDenominator,i.coefficientDenominator),l=Nn(a,o);n[r]={indeterminates:i.indeterminates,coefficientNumerator:Pe(a,l),coefficientDenominator:Pe(o,l)},n[r-1]={indeterminates:s.indeterminates,coefficientNumerator:Ut,coefficientDenominator:s.coefficientDenominator}}}return n.filter(r=>Mt(r.coefficientNumerator,Ut))}static fromIndeterminate(t){let r=[{indeterminates:new ce(JSON.stringify(t)),coefficientNumerator:Dt,coefficientDenominator:Dt}];return new e(r)}static fromConstant(t){let[n,r]=Math.abs(t).toString(2).split(".",2),s=J("0b"+n);t<0&&(s=z(s,Pn));let i=Dt;r&&(i=In(ps,J(r.length)),s=Lt(z(s,i),J("0b"+r)));let a=[{indeterminates:new ce,coefficientNumerator:s,coefficientDenominator:i}];return new e(a)}negation(){let t=this.terms.map(n=>({indeterminates:n.indeterminates,coefficientNumerator:z(n.coefficientNumerator,Pn),coefficientDenominator:n.coefficientDenominator}));return new e(t)}reciprocal(){let t=this.terms.map(n=>({indeterminates:n.indeterminates.reciprocal(),coefficientNumerator:n.coefficientDenominator,coefficientDenominator:n.coefficientNumerator}));return new e(t)}constant(){let t=this.terms.filter(n=>!n.indeterminates.sortedKeys.length);return new e(t)}add(t){return new e(e.simplifyTerms(this.terms.concat(t.terms)))}subtract(t){return this.add(t.negation())}multiply(t){let n=[];for(let r of this.terms)for(let s of t.terms){let i=z(r.coefficientNumerator,s.coefficientNumerator),a=z(r.coefficientDenominator,s.coefficientDenominator),o=Nn(i,a);n.push({indeterminates:ce.multiply(r.indeterminates,s.indeterminates),coefficientNumerator:Pe(i,o),coefficientDenominator:Pe(a,o)})}return new e(e.simplifyTerms(n))}divide(t){return this.multiply(t.reciprocal())}toString(){let t=[];for(let n of this.terms){let r=kt(n.coefficientNumerator)/kt(n.coefficientDenominator),s=[];if(n.indeterminates.sortedKeys.length){for(let i of n.indeterminates.sortedKeys){let a=n.indeterminates.map.get(i);for(let o=Math.abs(a);o>0;--o)a>0?s.push(i):s.push(`["/",1,${i}]`)}r!==1&&s.push(r.toString()),s.length>1?t.push(`["*",${s.join(",")}]`):t.push(s[0])}else t.push(r.toString())}return t.length?t.length===1?t[0]:`["+",${t.join(",")}]`:"0"}},vi=Ye.fromConstant(0),Si=Ye.fromConstant(1);var tt=class{variables=new Map;clauses=new Map;getVar(t){let n=t.toString(),r=this.variables.get(n);return r==null&&(r=this.variables.size,this.variables.set(n,r),this.clauses.set(r,t)),r}getClause(t){return this.clauses.get(t)}canRaise(t,n){return!0}canLower(t,n){return!0}bias(t,n){return(n^1)-(t^1)}sanitizeMinterms(t){return t}minimize(t,n=[]){t=this.sanitizeMinterms(t);let r=this.canRaise.bind(this),s=this.canLower.bind(this),i=this.bias.bind(this);return(0,_.espresso)(t,[...this.getDcSet([...t,...n]),...n],{canRaise:r,canLower:s,bias:i})}};function*et(e){if(!Array.isArray(e))return;let t=e[0];if(!(t==="IS NULL"||t==="IS NOT NULL")){if(t==="FUNC"){if(e[1]==="NOW")return;if(e[1]==="LOWER"||e[1]==="UPPER")yield*et(e[2]);else if(e[1]==="ROUND"){for(let n of e.slice(2,4))yield*et(n);return}}else if(t!=="PARAM"){for(let n of e.slice(1))yield*et(n);return}yield e}}var C=class e{_isNullable;_expression;expression(){if(this._expression!==void 0)return this._expression;let t=$n(),n=this.true(t),r=t.minimize(n);return this._expression=t.toExpression(r),this._expression}isBoolean(){return!0}isNullable(t){return this._isNullable||(this._isNullable=new Set([...this.getNullables()].map(n=>n.toString()))),this._isNullable.has(t.toString())}*getNullables(){let t=this.expression();for(let n of et(t))n===t?yield new e.IsNull(this):yield new e.IsNull(new e.Exp(n))}toString(){return JSON.stringify(this.expression())}};(u=>{class e extends u{constructor(c){super();this.operand=c}true(c){return this.operand.false(c)}false(c){return this.operand.true(c)}null(c){return this.operand.null(c)}}u.Not=e;class t extends u{constructor(c){super();this.operands=c}true(c){let f=[];for(let h of this.operands){let p=h.true(c);if(p.length===1&&!p[0].length)return[[]];f.push(...p)}return f}false(c){let f=[],h=[...this.operands];for(let p of h){if(p instanceof t){h.push(...p.operands);continue}let w=p.false(c);if(!w.length)return[];f.push(w)}return f.length?f.length===1?f[0]:(0,_.complement)(f.map(p=>(0,_.complement)(p)).flat()):[[]]}null(c){let f=[],h=[...this.operands];for(let w of h){if(w instanceof t){h.push(...w.operands);continue}let y=w.true(c);if(y.length===1&&!y[0].length)return[];f.push(...y)}let p=[];for(let w of h){let y=w.null(c);if(y.length===1&&!y[0].length&&!f.length)return[[]];p.push(...y)}return f.length?(0,_.complement)([...(0,_.complement)(p),...f]):p}}u.Or=t;class n extends u{constructor(c){super();this.operands=c}true(c){let f=[],h=[...this.operands];for(let p of h){if(p instanceof n){h.push(...p.operands);continue}let w=p.true(c);if(!w.length)return[];w.length===1&&!w[0].length||f.push(w)}return f.length?f.length===1?f[0]:(0,_.complement)(f.map(p=>(0,_.complement)(p)).flat()):[[]]}false(c){let f=[];for(let h of this.operands){let p=h.false(c);if(p.length===1&&!p[0].length)return[[]];f.push(...p)}return f}null(c){let f=[],h=[...this.operands];for(let w of h){if(w instanceof n){h.push(...w.operands);continue}let y=w.false(c);if(y.length===1&&!y[0].length)return[];f.push(...y)}let p=[];for(let w of h){let y=w.null(c);if(y.length===1&&!y[0].length&&!f.length)return[[]];p.push(...y)}return f.length?(0,_.complement)([...(0,_.complement)(p),...f]):p}}u.And=n;class r extends u{constructor(c){super();this.clauses=c}true(c){let f=[],h=[];for(let p=0;p<this.clauses.length;p+=2){let w=this.clauses[p].true(c),y=this.clauses[p+1].true(c);f.push(...(0,_.complement)([...h,...(0,_.complement)(w),...(0,_.complement)(y)])),p<this.clauses.length-2&&h.push(...(0,_.complement)([...this.clauses[p].false(c),...this.clauses[p].null(c)]))}return f}false(c){let f=[],h=[];for(let p=0;p<this.clauses.length;p+=2){let w=this.clauses[p].true(c),y=this.clauses[p+1].false(c);f.push(...(0,_.complement)([...h,...(0,_.complement)(w),...(0,_.complement)(y)])),p<this.clauses.length-2&&h.push(...(0,_.complement)([...this.clauses[p].false(c),...this.clauses[p].null(c)]))}return f}null(c){let f=[],h=[];for(let p=0;p<this.clauses.length;p+=2){let w=this.clauses[p].true(c),y=this.clauses[p+1].null(c);f.push(...(0,_.complement)([...h,...(0,_.complement)(w),...(0,_.complement)(y)])),h.push(...(0,_.complement)([...this.clauses[p].false(c),...this.clauses[p].null(c)]))}return f.push(...(0,_.complement)([...h])),f}expression(){if(this._expression!=null)return this._expression;if(this.isBoolean())return this._expression=new u.Not(new u.Not(this)).expression(),this._expression;let c=$n(),f=[];for(let h=0;h<this.clauses.length;h+=2){let p=this.clauses[h].true(c),w=this.clauses[h+1].expression();if(f.length&&JSON.stringify(w)===JSON.stringify(f[f.length-1].then)&&p.push(...f.pop().when),p=c.minimize(p,f.flatMap(y=>y.when)),!!p.length&&(f.push({when:p,then:w}),p.length===1&&!p[0].length))break}for(;f[f.length-1].then==null;)f.pop();return f.length?(this._expression=["CASE",...f.flatMap(h=>[c.toExpression(h.when),h.then])],this._expression):null}isBoolean(){for(let c=1;c<this.clauses.length;c+=2)if(!this.clauses[c].isBoolean())return!1;return!0}}u.Case=r;class s extends u{constructor(c){super();this.operand=c;this._boolean=new e(new e(this))}_boolean;true(c){return this.operand.null(c)}false(c){return(0,_.complement)(this.true(c))}null(){return[]}isBoolean(){return!0}*getNullables(){}expression(){let c=[...this.operand.getNullables()];return c.length===1&&c[0].operand===this.operand?["IS NULL",this.operand.expression()]:super.expression()}}u.IsNull=s;class i extends u{constructor(c){super();this.exp=c}true(c){return Array.isArray(this.exp)?c.getMinterms(this,!0):this.exp?[[]]:[]}false(c){return Array.isArray(this.exp)?c.getMinterms(this,!1):!this.exp&&this.exp!=null?[[]]:[]}null(c){return Array.isArray(this.exp)?c.getMinterms(this,null):this.exp==null?[[]]:[]}expression(){return this.exp}isBoolean(){return this.exp===!0||this.exp===!1||this.exp==null}}u.Exp=i;class a extends u{constructor(c,f,h){super();this.lhs=c;this.op=f;this.rhs=h}true(c){return c.getMinterms(this,!0)}false(c){return c.getMinterms(this,!1)}null(c){return this.lhs.null(c)}*getNullables(){yield*this.lhs.getNullables()}isBoolean(){return!0}expression(){return[this.op,this.lhs.expression(),this.rhs]}}u.Compare=a;class o extends u{constructor(c,f,h){super();this.rhs=f;this.esc=h;let p=c.expression(),w=!0,y=!1;if(Array.isArray(p)&&p[0]==="FUNC"){let P=p[1];(P==="UPPER"||P==="LOWER")&&((P==="UPPER"?f.toUpperCase():f.toLowerCase())===f?w=!1:y=!0,c=new i(p[2]))}this.lhs=c,this.pattern=Oe(f,h),this.caseSensitive=w,this.contradiction=y}caseSensitive;contradiction;pattern;lhs;true(c){return c.getMinterms(this,!0)}false(c){return c.getMinterms(this,!1)}null(c){return this.lhs.null(c)}isBoolean(){return!0}isNullable(c){return this.lhs.isNullable(c)}getNullables(){return this.lhs.getNullables()}expression(){let c=this.lhs.expression();return this.contradiction?this.rhs===this.rhs.toLocaleUpperCase()?c=["FUNC","LOWER",c]:c=["FUNC","UPPER",c]:this.caseSensitive||(this.rhs===this.rhs.toLocaleUpperCase()?c=["FUNC","UPPER",c]:c=["FUNC","LOWER",c]),["LIKE",c,this.rhs,...this.esc?[this.esc]:[]]}}u.Like=o;function l(m){return Ee(m,c=>{if(!Array.isArray(c))return new u.Exp(c);let f=c[0],h=!0;f==="NOT LIKE"?f="LIKE":f==="IS NOT NULL"?f="IS NULL":f==="<>"?f="=":f===">="?f="<":f==="<="?f=">":h=!1;let p;if(f==="IS NULL")p=new u.IsNull(c[1]);else if(f==="NOT")p=new u.Not(c[1]);else if(f==="OR")p=new u.Or(c.slice(1));else if(f==="AND")p=new u.And(c.slice(1));else if(f==="CASE")p=new u.Case(c.slice(1));else if(f==="LIKE"){let w=c[2]instanceof i?c[2].expression():null,y=c[3]instanceof i?c[3].expression():null;typeof w=="string"&&typeof y=="string"?p=new u.Like(c[1],w,y):typeof w=="string"&&y==null&&(p=new u.Like(c[1],w))}else if(f===">"||f==="<"||f==="="){let w=c[2]instanceof i?c[2].expression():null;["boolean","number","string"].includes(typeof w)&&(p=new u.Compare(c[1],f,w))}if(!p){let w=c.slice(1).map(y=>y.expression());p=new u.Exp([f,...w])}return h&&(p=new u.Not(p)),p})}u.fromExpression=l})(C||(C={}));function xn(e,t){let n=new Map;for(let r of e){let s=t(r),i=n.get(s);i||n.set(s,i=[]),i.push(r)}return n.entries()}var Bt=class extends tt{constructor(){super()}getMinterms(t,n){let r=this.getVar(t);return n===!0?[[r<<2^3]]:n===!1?[[r<<2^1]]:[[r<<2,r<<2^2]]}getDcSet(t){let n=[],r=new Set([...t.flat()].map(o=>o>>2)),s=[...r].map(o=>this.getClause(o)),i=s.filter(o=>o instanceof C.Compare);for(let[,o]of xn(i,l=>JSON.stringify(l.lhs))){let l=o[0].lhs,m=[...new Set(o.map(d=>d.rhs))].sort((d,c)=>{let f=typeof d,h=typeof c;return f===h?d>c?1:-1:f==="string"?1:h==="string"?-1:+d-+c});for(let[d,c]of m.entries()){let f=this.getVar(new C.Compare(l,"=",c)),h=this.getVar(new C.Compare(l,">",c)),p=this.getVar(new C.Compare(l,"<",c));n.push([f<<2^3,h<<2^3]),n.push([p<<2^3,h<<2^3]),n.push([p<<2^3,f<<2^3]),n.push([p<<2^1,f<<2^1,h<<2^1]);let w=[p,f,h].filter(y=>!r.has(y));w.length===1&&r.add(w[0]);for(let y=0;y<d;y++){let P=this.getVar(new C.Compare(l,"=",m[y])),S=this.getVar(new C.Compare(l,">",m[y])),A=this.getVar(new C.Compare(l,"<",m[y]));n.push([S<<2^1,p<<2^1]),n.push([P<<2^3,p<<2^1]),n.push([A<<2^3,p<<2^1]),n.push([S<<2^1,h<<2^3]),n.push([S<<2^1,f<<2^3]),n.push([P<<2^3,h<<2^3]),n.push([P<<2^3,f<<2^3]),n.push([A<<2^3,h<<2^3]),n.push([A<<2^3,f<<2^3])}}}let a=s.filter(o=>o instanceof C.Like);for(let[,o]of xn(a,l=>JSON.stringify(l.lhs)))for(let l=0;l<o.length;++l){let u=o[l];if(u.contradiction){n.push([this.getVar(u)<<2^3]);continue}for(let m=l+1;m<o.length;++m){let d=o[m];if(d.contradiction)continue;let c=u.pattern,f=d.pattern;(!u.caseSensitive||!d.caseSensitive)&&(c=c.map(h=>h.toLowerCase()),f=f.map(h=>h.toLowerCase())),Ln(c,f)?n.push([this.getVar(u)<<2^3,this.getVar(d)<<2^3]):(!u.caseSensitive||d.caseSensitive)&&Ft(c,f)?(n.push([this.getVar(u)<<2^2,this.getVar(d)<<2^3]),n.push([this.getVar(u)<<2^1,this.getVar(d)<<2^0])):(!d.caseSensitive||u.caseSensitive)&&Ft(f,c)&&(n.push([this.getVar(u)<<2^3,this.getVar(d)<<2^2]),n.push([this.getVar(u)<<2^0,this.getVar(d)<<2^1]))}}for(let o of r){let l=this.getClause(o),u=[...l.getNullables()].map(m=>this.getVar(m));if(u.length){n.push([...u.map(m=>m<<2^2),o<<2^0,o<<2^2]);for(let m of u)n.push([m<<2^3,o<<2^1]),n.push([m<<2^3,o<<2^3]),r.add(m)}if(l instanceof C.IsNull){let m=l.operand.toString();(m==='["PARAM","DeviceID.ID"]'||m==='["PARAM","_id"]')&&n.push([o<<2^3])}}return n.filter(o=>o.every(l=>r.has(l>>2)))}canRaise(t,n){let r=this.getClause(t>>2);if(r instanceof C.IsNull){for(let s of n){if(s===t||s&1)continue;if(this.getClause(s>>2).isNullable(r))return!1}return!0}return!(t&1)||!n.has(t^3)}canLower(t,n){return t&1||this.getClause(t>>2)instanceof C.IsNull?!0:n.has(t^3)||n.has(t^1)}bias(t,n){return(n&3^3)-(t&3^3)}sanitizeMinterms(t){let n=[];e:for(let r of t){let s=new Map;for(let l of r)s.set(l>>2,(s.get(l>>2)||0)|1<<(l&3));let i=[],a=[];for(let[l,u]of s){if((u&3)===3||(u&12)===12)continue e;let m=this.clauses.get(l);if(!m)throw new Error("Invalid literal");if(m instanceof C.IsNull){if(u===4)i.push(l<<2^2);else if(u===8)i.push(l<<2^3);else throw new Error("Invalid literal");continue}if((u&10)===10)continue e;let d=[...m.getNullables()].map(f=>this.getVar(f)),c=l<<2;u===5?d.length===1?i.push(d[0]<<2^3):a.push(d.map(f=>f<<2^3)):u===1?a.push([...d.map(f=>f<<2^3),c^3]):u===4?a.push([...d.map(f=>f<<2^3),c^1]):u&8?i.push(c^3):u&2&&i.push(c^1)}let o=[i];for(;a.length;){let l=[],u=a.pop();for(let m of u)l.push(...o.map(d=>[...d,m]));o=l}n.push(...o)}return n}toExpression(t){if(!t.length)return!1;let n=[];for(let r of t){if(!r.length)return!0;let s=[];for(let i of r){let a=this.getClause(i>>>2);if(!a)throw new Error("Invalid literal");if(a instanceof C.IsNull){if(!(i&2))throw new Error("Invalid literal")}else if(!(i&1)){let l=[...a.getNullables()].map(u=>this.getVar(u));s.push(this.toExpression([[i^3],...l.map(u=>[u<<2^3])]));continue}let o=a.expression();if(!(i&1)!=!(i&2)&&(o=["NOT",o]),Array.isArray(o)&&o[0]==="NOT"&&Array.isArray(o[1])){let l=o[1];l[0]==="IS NULL"?o=["IS NOT NULL",...l.slice(1)]:l[0]==="LIKE"?o=["NOT LIKE",...l.slice(1)]:l[0]==="="?o=["<>",...l.slice(1)]:l[0]==="<>"?o=["=",...l.slice(1)]:l[0]===">"?o=["<=",...l.slice(1)]:l[0]===">="?o=["<",...l.slice(1)]:l[0]==="<"?o=[">=",...l.slice(1)]:l[0]==="<="?o=[">",...l.slice(1)]:l[0]==="NOT"&&(o=l[1])}s.push(o)}s.length>1?n.push(["AND",...s]):n.push(s[0])}return n.length>1?["OR",...n]:n[0]}};function $n(){return new Bt}function Ft(e,t){let n=null;for(let r=0,s=0;;++r,++s){for(;r<e.length&&e[r]==="\\%";)n=[r++,s];if(s>=t.length)return r>=e.length;let i=r<e.length?e[r]:null;if(i!==t[s]&&i!=="\\_"){if(!n)return!1;[r,s]=n,++n[1]}}}function Ln(e,t){let n=e.indexOf("\\%"),r=t.indexOf("\\%"),s=e.lastIndexOf("\\%"),i=t.lastIndexOf("\\%"),a=e.slice(0,n!==-1?n:e.length),o=t.slice(0,r!==-1?r:t.length),l=e.slice(s!==-1?s+1:0).reverse(),u=t.slice(i!==-1?i+1:0).reverse();for(let m=0;m<Math.min(a.length,o.length);++m)if(a[m]!==o[m]&&a[m]!=="\\_"&&o[m]!=="\\_")return!0;for(let m=0;m<Math.min(l.length,u.length);++m)if(l[m]!==u[m]&&l[m]!=="\\_"&&u[m]!=="\\_")return!0;return e.length===a.length?t.filter(m=>m!=="\\%").length>e.length:t.length===o.length?e.filter(m=>m!=="\\%").length>t.length:!1}function nt(e){let t=+e;return isNaN(t)?""+e:t}function Ne(e){function t(s,i,a,o){for(let[l,u]of Object.entries(s)){if(!i){if(l==="_lastInform")a["Events.Inform"]={value:[nt(u),"xsd:dateTime"],valueTimestamp:o,writable:!1,writableTimestamp:o,object:!1,objectTimestamp:o};else if(l==="_registered")a["Events.Registered"]={value:[nt(u),"xsd:dateTime"],valueTimestamp:o,writable:!1,writableTimestamp:o,object:!1,objectTimestamp:o};else if(l==="_lastBoot")a["Events.1_BOOT"]={value:[nt(u),"xsd:dateTime"],valueTimestamp:o,writable:!1,writableTimestamp:o,object:!1,objectTimestamp:o};else if(l==="_lastBootstrap")a["Events.0_BOOTSTRAP"]={value:[nt(u),"xsd:dateTime"],valueTimestamp:o,writable:!1,writableTimestamp:o,object:!1,objectTimestamp:o};else if(l==="_id")a["DeviceID.ID"]={value:[u,"xsd:string"],valueTimestamp:o,writable:!1,writableTimestamp:o,object:!1,objectTimestamp:o};else if(l==="_deviceId")a["DeviceID.Manufacturer"]={value:[u._Manufacturer,"xsd:string"],valueTimestamp:o,writable:!1,writableTimestamp:o,object:!1,objectTimestamp:o},a["DeviceID.OUI"]={value:[u._OUI,"xsd:string"],valueTimestamp:o,writable:!1,writableTimestamp:o,object:!1,objectTimestamp:o},a["DeviceID.ProductClass"]={value:[u._ProductClass,"xsd:string"],valueTimestamp:o,writable:!1,writableTimestamp:o,object:!1,objectTimestamp:o},a["DeviceID.SerialNumber"]={value:[u._SerialNumber,"xsd:string"],valueTimestamp:o,writable:!1,writableTimestamp:o,object:!1,objectTimestamp:o};else if(l==="_tags"){a.Tags={writable:!1,writableTimestamp:o,object:!0,objectTimestamp:o};for(let f of u)a[`Tags.${Ot(f)}`]={value:[!0,"xsd:boolean"],valueTimestamp:o,writable:!0,writableTimestamp:o,object:!1,objectTimestamp:o}}}if(l.startsWith("_"))continue;let m=o;i?+s._timestamp>o&&(m=+s._timestamp):m=+(s._timestamp||1);let d={};u._value!=null?(d.value=[u._value instanceof Date?+u._value:u._value,u._type],d.valueTimestamp=+(u._timestamp||m),d.object=!1,d.objectTimestamp=m):u._object!=null&&(d.object=u._object,d.objectTimestamp=m),u._writable!=null&&(d.writable=u._writable,d.writableTimestamp=m),u._notification!=null&&(d.notification=u._notification,d.notificationTimestamp=+u._attributesTimestamp||1),u._accessList!=null&&(d.accessList=u._accessList,d.accessListTimestamp=+u._attributesTimestamp||1);let c=i?`${i}.${l}`:l;a[c]=d,(d.object||u.object==null)&&t(u,c,a,m)}}let n={},r=new Date(e._lastInform||1).getTime();return t(e,"",n,r),n}async function kn(e){await E.faults.deleteOne({_id:e})}async function Mn(e){await E.tasks.deleteOne({_id:e})}var Me=N(require("crypto")),lr=N(require("dgram")),it=N(require("http"));var Z=require("crypto");function hs(e){let t={},n=e.split(","),r;for(;(r=n.shift())!=null;){let s=r.split("=",1)[0];if(s.length===r.length){if(!r.trim())continue;throw new Error("Unable to parse auth header")}let i=r.slice(s.length+1);if(!/^\s*"/.test(i))i=i.trim();else{for(;!/[^\\]"\s*$/.test(i);){let a=n.shift();if(a==null)throw new Error("Unable to parse auth header");i+=","+a}try{i=JSON.parse(i)}catch{throw new Error("Unable to parse auth header")}}t[s.trim()]=i}return t}function Dn(e){e=e.trim();let t=e.split(" ",1)[0],n={method:t};return Object.assign(n,hs(e.slice(t.length+1))),n}function Un(e,t){return"Basic "+Buffer.from(`${e}:${t}`).toString("base64")}function ws(e,t,n,r,s,i,a,o,l,u){let m=(0,Z.createHash)("md5");m.update(e).update(":").update(t).update(":").update(n);let d=m.digest("hex"),c=(0,Z.createHash)("md5");if(c.update(s).update(":").update(i),a==="auth-int"){let p=(0,Z.createHash)("md5").update(o||"").digest("hex");c.update(":").update(p)}let f=c.digest("hex"),h=(0,Z.createHash)("md5");return h.update(d).update(":").update(r),a&&h.update(":").update(u).update(":").update(l).update(":").update(a),h.update(":").update(f),h.digest("hex")}function Bn(e,t,n,r,s,i){let a=(0,Z.randomBytes)(8).toString("hex"),o="00000001",l;i.qop&&(i.qop.indexOf(",")!==-1?l="auth":l=i.qop);let u=ws(e,i.realm,t,i.nonce,r,n,l,s,a,o),m=`Digest username="${e}"`;return m+=`,realm="${i.realm}"`,m+=`,nonce="${i.nonce}"`,m+=`,uri="${n}"`,i.algorithm&&(m+=`,algorithm=${i.algorithm}`),l&&(m+=`,qop=${l},nc=${o},cnonce="${a}"`),m+=`,response="${u}"`,i.opaque&&(m+=`,opaque="${i.opaque}"`),m}var Fn=require("child_process"),Hn=N(require("crypto")),Ht=N(require("readline"));var ys=+v("EXT_TIMEOUT"),U={},xe=new Map;function jn(e){return new Promise(t=>{let n=e[0],r=Hn.randomBytes(8).toString("hex");if(xe.set(r,t),!U[n]){let s=(0,Fn.spawn)(R+"/bin/genieacs-ext",[n],{stdio:["ignore","pipe","pipe","ipc"]});U[n]=s,s.on("error",o=>{U[n]===s&&(xe.delete(r)&&t({fault:{code:o.name,message:o.message},value:null}),Wn(U[n]),delete U[n])}),s.on("disconnect",()=>{U[n]===s&&delete U[n]}),s.on("message",o=>{let l=xe.get(o[0]);l&&(xe.delete(o[0]),setTimeout(()=>{l({fault:o[1],value:o[2]})}))}),Ht.default.createInterface(s.stdout).on("line",o=>{Q({message:`Ext ${n}(${s.pid}): ${o}`})}),Ht.default.createInterface(s.stderr).on("line",o=>{mn({message:`Ext ${n}(${s.pid}): ${o}`})})}return setTimeout(()=>{xe.delete(r)&&t({fault:{code:"timeout",message:"Extension timed out"},value:null})},ys),U[n].connected?U[n].send([r,e.slice(1)]):!1})}function Wn(e){return new Promise(t=>{let n=Date.now()+5e3;e.kill();let r=setInterval(()=>{e.connected?Date.now()>n&&(e.kill("SIGKILL"),clearInterval(r),t()):(clearInterval(r),t())},100)})}async function jt(){await Promise.all(Object.entries(U).map(([e,t])=>(delete U[e],Wn(t))))}var $=require("fs");var Y="  ",bs=new Set(["true","True","TRUE","false","False","FALSE","null","Null","NULL"]);function Gn(e){return!/[^\t\n\x20-\x7e\x85\u{a0}-\u{d7ff}\u{e000}-\u{fffd}\u{10000}-\u{10ffff}]/u.test(e)}function Wt(e){return!e||!Gn(e)||/^[\s-?:,[\]{}#&$!|>'"%@`]|: | #|[\n,[\]{}]|\s$/.test(e)?JSON.stringify(e):e}function vs(e){if(e.length<=80)return[e];if(e.startsWith(" "))return[e];let t=[],n=0,r=0;for(let s=1;s<e.length-1;++s){if(e[s]!==" ")continue;if(e[s+1]===" "){for(s+=2;e[s]===" ";)++s;continue}if(s<=n+80){r=s;continue}let i=r>n?r:s;t.push(e.slice(n,i)),n=i+1,r=s}return r>n&&e.length>n+80&&(t.push(e.slice(n,r)),n=r+1),t.push(e.slice(n)),t}function Ss(e,t,n,r){if(/^\s*$/.test(e)||bs.has(e)||!Gn(e)){t.push(n+JSON.stringify(e));return}r||(r=Y);let s=e.split(`
`);if(s.length>1){let i="",a="-";if((s.find(u=>u)||"").startsWith(" ")&&(i=`${Y.length}`),s[s.length-1]||(s.pop(),s[s.length-1]?a="":a="+"),/^\s+$/.test(s[s.length-1])){t.push(n+JSON.stringify(e));return}let o=!1,l=s.map(u=>{let m=vs(u);return m.length>1&&(o=!0),m});if(!o){t.push(`${n}|${i}${a}`,...s.map(u=>u&&r+u));return}t.push(`${n}>${i}${a}`),t.push(...l[0].map(u=>r+u));for(let u=1;u<l.length;++u)l[u-1][0]&&!l[u-1][0].startsWith(" ")&&t.push(""),t.push(...l[u].map(d=>r+d));return}if(/^[\s-?:,[\]{}#&$!|>'"%@`]|: | #|\s$/.test(e)||parseFloat(e)===+e){t.push(n+JSON.stringify(e));return}t.push(n+e)}function ue(e,t,n="",r=""){if(e==null){t.push(`${n}null`);return}if(typeof e=="number"||typeof e=="boolean"){t.push(`${n}${JSON.stringify(e)}`);return}if(e instanceof Date){t.push(`${n}${e.toJSON()}`);return}if(typeof e=="string"){Ss(e,t,n,r);return}if(Array.isArray(e)){if(!e.length){t.push(n+"[]");return}if(!n||n.endsWith("- ")){ue(e[0],t,n+"- ",r+Y),n=r+"- ",r=r+Y;for(let i=1;i<e.length;++i)ue(e[i],t,n,r)}else{t.push(n),n=r+"- ",r=r+Y;for(let i=0;i<e.length;++i)ue(e[i],t,n,r)}return}let s=Object.entries(e).filter(i=>i[1]!==void 0);if(!s.length){t.push(n+"{}");return}if(!n||n.endsWith("- ")){ue(s[0][1],t,n+`${Wt(s[0][0])}: `,r+Y),n=r,r=r+Y;for(let i=1;i<s.length;++i)ue(s[i][1],t,n+`${Wt(s[i][0])}: `,r)}else{t.push(n),n=r,r=r+Y;for(let i=0;i<s.length;++i)ue(s[i][1],t,n+`${Wt(s[i][0])}: `,r)}}function fe(e){if(e===void 0)return;let t=[];return ue(e,t),t.join(`
`)+`
`}var O=""+v("DEBUG_FILE"),M=""+v("DEBUG_FORMAT"),Vn=new WeakMap;function Kn(e){let t=Vn.get(e);return t||(t=new Date,Vn.set(e,t)),t}function zn(e,t,n,r,s){if(!O)return;let i=new Date,a=e.socket,o={event:"outgoing HTTP request",timestamp:i,remoteAddress:a.remoteAddress,deviceId:t,connection:Kn(a),remotePort:r.port,method:n,url:r.pathname+r.search,headers:e.getHeaders(),body:s};if(M==="yaml")(0,$.appendFileSync)(O,`---
`+fe(o));else if(M==="json")(0,$.appendFileSync)(O,JSON.stringify(o)+`
`);else throw new Error("Unrecognized DEBUG_FORMAT option")}function Jn(e,t,n,r,s){if(!O)return;let a={event:"outgoing HTTP request",timestamp:new Date,remoteAddress:r.hostname,deviceId:t,connection:null,remotePort:r.port,method:n,url:r.pathname+r.search,headers:e.getHeaders(),error:s.message};if(M==="yaml")(0,$.appendFileSync)(O,`---
`+fe(a));else if(M==="json")(0,$.appendFileSync)(O,JSON.stringify(a)+`
`);else throw new Error("Unrecognized DEBUG_FORMAT option")}function Xn(e,t,n){if(!O)return;let r=new Date,s=e.socket,i={event:"incoming HTTP response",timestamp:r,remoteAddress:s.remoteAddress,deviceId:t,connection:Kn(e.socket),statusCode:e.statusCode,headers:e.headers,body:n};if(M==="yaml")(0,$.appendFileSync)(O,`---
`+fe(i));else if(M==="json")(0,$.appendFileSync)(O,JSON.stringify(i)+`
`);else throw new Error("Unrecognized DEBUG_FORMAT option")}function Qn(e,t,n,r){if(!O)return;let i={event:"outgoing UDP message",timestamp:new Date,remoteAddress:e,deviceId:t,remotePort:n,body:r};if(M==="yaml")(0,$.appendFileSync)(O,`---
`+fe(i));else if(M==="json")(0,$.appendFileSync)(O,JSON.stringify(i)+`
`);else throw new Error("Unrecognized DEBUG_FORMAT option")}function Zn(e,t){if(!O)return;let r={event:"outgoing XMPP stanza",timestamp:new Date,deviceId:e,body:t};if(M==="yaml")(0,$.appendFileSync)(O,`---
`+fe(r));else if(M==="json")(0,$.appendFileSync)(O,JSON.stringify(r)+`
`);else throw new Error("Unrecognized DEBUG_FORMAT option")}function Yn(e,t){if(!O)return;let r={event:"incoming XMPP stanza",timestamp:new Date,deviceId:e,body:t};if(M==="yaml")(0,$.appendFileSync)(O,`---
`+fe(r));else if(M==="json")(0,$.appendFileSync)(O,JSON.stringify(r)+`
`);else throw new Error("Unrecognized DEBUG_FORMAT option")}var nr=N(require("net")),rr=N(require("tls")),sr=require("events"),L=require("crypto");function $e(e){let t=[],n=e.length,r=0,s="",i="",a="",o=0,l=0;for(let m=0;m<n;++m){let d=e.charCodeAt(m);switch(d){case 39:case 34:if(r===d){if(r=0,s){let c=e.slice(o+1,m),f={name:s,namespace:i,localName:a,value:c};t.push(f),s="",o=m+1}}else r=d,o=m;continue;case 58:if(r)continue;o>=l&&(l=m);continue;case 61:if(r)continue;if(s)throw new Error(`Unexpected character at ${m}`);s=e.slice(o,m).trim(),l>o?(i=e.slice(o,l).trim(),a=e.slice(l+1,m).trim()):(i="",a=s)}}if(s)throw new Error(`Attribute must have value at ${o}`);let u=e.slice(o);if(u.trim())throw new Error(`Unexpected string at ${n-u.length}`);return t}function qt(e){let t={"&":"&amp;",'"':"&quot;","'":"&apos;","<":"&lt;",">":"&gt;"};return e.replace(/[&"'<>]/g,n=>t[n])}function rt(e){let t=e.length,n=0,r=0,s=0,i=0,a={name:"root",namespace:"",localName:"root",attrs:"",text:"",bodyIndex:0,children:[]},o=[a];for(let l=0;l<t;++l)switch(e.charCodeAt(l)){case 39:switch(n&255){case 2:n=s,r=i,s=0;continue;case 1:s=n,i=r,n=2,r=l;continue}continue;case 34:switch(n&255){case 3:n=s,r=i,s=0;continue;case 1:s=n,i=r,n=3,r=l;continue}continue;case 60:n&255||(s=n,i=r,n=1,r=l);continue;case 58:(n&255)===1&&!(n>>8&255)&&(n^=(l-r&255)<<8);continue;case 32:case 9:case 13:case 10:(n&255)===1&&!(n>>16&255)&&(n^=(l-r&255)<<16);continue;case 62:if((n&255)===1){let u=e.charCodeAt(r+1),m=n>>16&255,d,c,f,h,p,w,y;switch(u){case 47:if(f=o.pop(),d=m===0?e.slice(r+2,l):e.slice(r+2,r+m),f.name!==d)throw new Error(`Unmatched closing tag at ${l}`);f.children.length||(f.text=e.slice(f.bodyIndex,r)),n=s,r=i,s=0;continue;case 33:if(e.startsWith("![CDATA[",r+1)){if(e.endsWith("]]",l))throw new Error(`CDATA nodes are not supported at ${l}`)}else e.startsWith("!--",r+1)&&e.endsWith("--",l)&&(n=s,r=i,s=0);continue;case 63:e.charCodeAt(l-1)===63&&(n=s,r=i,s=0);continue;default:p=+(e.charCodeAt(l-1)===47),h=o[o.length-1],c=n>>8&255,d=m===0?e.slice(r+1,l-p):e.slice(r+1,r+m),c&&(!m||c<m)?(w=d.slice(c),y=d.slice(0,c-1)):(w=d,y=""),f={name:d,namespace:y,localName:w,attrs:m?e.slice(r+m+1,l-p):"",text:"",bodyIndex:l+1,children:[]},h.children.push(f),p||o.push(f),n=s,r=i,s=0;continue}}continue}if(n)throw new Error(`Unclosed token at ${r}`);if(o.length>1){let l=o[o.length-1];throw new Error(`Unclosed XML element at ${l.bodyIndex}`)}return a.children.length||(a.text=e),a}function st(e){return Buffer.from(e).toString("base64")}function er(e){return Buffer.from(e,"base64").toString()}function As(e){let t=e.indexOf("<stream:stream");if(t<0)throw new Error("Cannot detect opening stream tag");let n=e.indexOf(">",t);if(n<0)throw new Error("Cannot detect opening stream tag");return n+1}function Ts(e,t){return new Promise((n,r)=>{let s=a=>{e.removeListener("error",s),r(a)};e.on("error",s);let i=a=>{try{let o=a.toString("utf8"),l=rt(o),{value:u,done:m}=t.next(l.children[0]);m&&(e.removeListener("error",s),e.removeListener("data",i),n(u))}catch(o){e.removeListener("error",s),e.removeListener("data",i),r(o)}};e.once("data",a=>{try{let o=a.toString("utf8"),l=As(o),u=o.slice(0,l),m=rt(u+"</stream:stream>");t.next(m.children[0]),a=a.slice(Buffer.byteLength(u)),a.length&&i(a),e.on("data",i)}catch(o){e.removeListener("error",s),e.removeListener("data",i),r(o)}});try{t.next()}catch(a){e.removeListener("error",s),e.removeListener("data",i),r(a)}})}var Cs=Buffer.from([0,0,0,1]),ee={password:"",iterationCount:0,saltBase64:"",salted:Buffer.allocUnsafe(0)};function Is(e,t,n){if(e===ee.password&&t===ee.saltBase64&&n===ee.iterationCount)return ee.salted;let r=(0,L.createHmac)("sha1",e).update(Buffer.concat([Buffer.from(t,"base64"),Cs])).digest(),s=r;for(let i=1;i<n;++i){s=(0,L.createHmac)("sha1",e).update(s).digest();for(let[a,o]of s.entries())r[a]^=o}return ee.saltBase64=t,ee.password=e,ee.iterationCount=n,ee.salted=r,r}function*Os(e,t,n){e.write(`<auth xmlns="urn:ietf:params:xml:ns:xmpp-sasl" mechanism="PLAIN">${st(`\0${t}\0${n}`)}</auth>`);let r=yield;if(r.name==="failure"&&r.children.some(s=>s.name==="not-authorized"))throw new Error("Not authorized");if(r.name!=="success")throw new Error(`Unexpected response ${r.name}`)}function*Rs(e,t,n){let r=(0,L.randomBytes)(8).toString("base64"),s="n,,",i=`n=${t},r=${r}`,a=s+i;e.write(`<auth xmlns="urn:ietf:params:xml:ns:xmpp-sasl" mechanism="SCRAM-SHA-1">${st(a)}</auth>`);let o=yield;if(o.name!=="challenge")throw new Error(`Unexpected element ${o.name}`);let l=er(o.text),u,m,d;for(let B of l.split(","))B.startsWith("i=")?u=parseInt(B.slice(2)):B.startsWith("s=")?m=B.slice(2):B.startsWith("r=")&&(d=B.slice(2));if(u==null||isNaN(u))throw new Error("Invalid iteration count");if(m==null)throw new Error("Missing salt");if(d==null)throw new Error("Missing nonce");let c=Is(n,m,u),f=(0,L.createHmac)("sha1",c).update("Client Key").digest(),h=(0,L.createHash)("sha1").update(f).digest(),p=`c=${st(s)},r=${d}`,w=`${i},${l},${p}`,y=(0,L.createHmac)("sha1",h).update(w).digest(),P=Buffer.from(f);for(let[B,Lr]of y.entries())P[B]^=Lr;let S=`${p},p=${P.toString("base64")}`;e.write(`<response xmlns="urn:ietf:params:xml:ns:xmpp-sasl">${st(S)}</response>`);let A=yield;if(A.name==="failure"&&A.children.some(B=>B.name==="not-authorized"))throw new Error("Not authorized");if(A.name!=="success")throw new Error(`Unexpected response ${A.name}`);let me=(0,L.createHmac)("sha1",c).update("Server Key").digest(),$r=(0,L.createHmac)("sha1",me).update(w).digest("base64");if(!er(A.text).endsWith($r))throw new Error("Invalid server