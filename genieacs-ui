#!/usr/bin/env node
"use strict";var Hs=Object.create;var Br=Object.defineProperty;var Vs=Object.getOwnPropertyDescriptor;var Ks=Object.getOwnPropertyNames;var Js=Object.getPrototypeOf,Xs=Object.prototype.hasOwnProperty;var Qs=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of Ks(t))!Xs.call(e,s)&&s!==r&&Br(e,s,{get:()=>t[s],enumerable:!(n=Vs(t,s))||n.enumerable});return e};var T=(e,t,r)=>(r=e!=null?Hs(Js(e)):{},Qs(t||!e||!e.__esModule?Br(r,"default",{value:e,enumerable:!0}):r,e));var $e=require("path"),Xe=require("fs"),M=(0,$e.resolve)(__dirname,"..");for(;!(0,Xe.existsSync)(`${M}/package.json`);){let e=(0,$e.resolve)(M,"..");if(e===M){M=process.cwd();break}M=e}var ee,Kt,Jt,Xt,Qt,ht,Fr={EXT_DIR:{type:"path",default:(0,$e.resolve)(M,"config/ext")},MONGODB_CONNECTION_URL:{type:"string",default:"mongodb://127.0.0.1/genieacs"},CWMP_WORKER_PROCESSES:{type:"int",default:0},CWMP_PORT:{type:"int",default:7547},CWMP_INTERFACE:{type:"string",default:"::"},CWMP_SSL_CERT:{type:"string",default:""},CWMP_SSL_KEY:{type:"string",default:""},CWMP_LOG_FILE:{type:"path",default:""},CWMP_ACCESS_LOG_FILE:{type:"path",default:""},NBI_WORKER_PROCESSES:{type:"int",default:0},NBI_PORT:{type:"int",default:7557},NBI_INTERFACE:{type:"string",default:"::"},NBI_SSL_CERT:{type:"string",default:""},NBI_SSL_KEY:{type:"string",default:""},NBI_LOG_FILE:{type:"path",default:""},NBI_ACCESS_LOG_FILE:{type:"path",default:""},FS_WORKER_PROCESSES:{type:"int",default:0},FS_PORT:{type:"int",default:7567},FS_INTERFACE:{type:"string",default:"::"},FS_SSL_CERT:{type:"string",default:""},FS_SSL_KEY:{type:"string",default:""},FS_URL_PREFIX:{type:"string",default:""},FS_LOG_FILE:{type:"path",default:""},FS_ACCESS_LOG_FILE:{type:"path",default:""},UI_WORKER_PROCESSES:{type:"int",default:0},UI_PORT:{type:"int",default:3e3},UI_INTERFACE:{type:"string",default:"::"},UI_SSL_CERT:{type:"string",default:""},UI_SSL_KEY:{type:"string",default:""},UI_LOG_FILE:{type:"path",default:""},UI_ACCESS_LOG_FILE:{type:"path",default:""},UI_JWT_SECRET:{type:"string",default:""},UDP_CONNECTION_REQUEST_PORT:{type:"int",default:0},FORWARDED_HEADER:{type:"string",default:""},DOWNLOAD_TIMEOUT:{type:"int",default:3600},EXT_TIMEOUT:{type:"int",default:3e3},MAX_CACHE_TTL:{type:"int",default:86400},DEBUG_FILE:{type:"path",default:""},DEBUG_FORMAT:{type:"string",default:"yaml"},DEBUG:{type:"bool",default:!1},RETRY_DELAY:{type:"int",default:300},SESSION_TIMEOUT:{type:"int",default:30},CONNECTION_REQUEST_TIMEOUT:{type:"int",default:2e3},GPN_NEXT_LEVEL:{type:"int",default:0},GPV_BATCH_SIZE:{type:"int",default:32},MAX_DEPTH:{type:"int",default:16},COOKIES_PATH:{type:"string"},LOG_FORMAT:{type:"string",default:"simple"},ACCESS_LOG_FORMAT:{type:"string",default:""},MAX_CONCURRENT_REQUESTS:{type:"int",default:20},DATETIME_MILLISECONDS:{type:"bool",default:!0},BOOLEAN_LITERAL:{type:"bool",default:!0},CONNECTION_REQUEST_ALLOW_BASIC_AUTH:{type:"bool",default:!1},MAX_COMMIT_ITERATIONS:{type:"int",default:32},DEVICE_ONLINE_THRESHOLD:{type:"int",default:4e3},XMPP_JID:{type:"string",default:""},XMPP_PASSWORD:{type:"string",default:""}},Y={};function $(e,t,r=!1){if(Y[e]!=null)return!0;(e==="CONFIG_DIR"||e==="config-dir")&&(ee=ee||(0,$e.resolve)(M,t)),(e==="CWMP_SSL"||e==="cwmp-ssl")&&(Kt=Kt||String(t).toLowerCase().trim()),(e==="NBI_SSL"||e==="nbi-ssl")&&(Jt=Jt||String(t).toLowerCase().trim()),(e==="FS_SSL"||e==="fs-ssl")&&(Xt=Xt||String(t).toLowerCase().trim()),(e==="UI_SSL"||e==="ui-ssl")&&(Qt=Qt||String(t).toLowerCase().trim()),(e==="FS_HOSTNAME"||e==="fs-hostname")&&(ht=ht||String(t).trim()),(e==="PRESETS_CACHE_DURATION"||e==="presets-cache-duration")&&$("MAX_CACHE_TTL",t),(e==="GET_PARAMETER_NAMES_DEPTH_THRESHOLD"||e==="get-parameter-names-depth-threshold")&&$("GPN_NEXT_LEVEL",t),(e==="TASK_PARAMETERS_BATCH_SIZE"||e==="task-parameters-batch-size")&&$("GPV_BATCH_SIZE",t),(e==="FS_IP"||e==="fs-ip")&&$("FS_HOSTNAME",t);function n(i,o){switch(o){case"int":return Number(i);case"bool":return["true","1"].includes(String(i).trim().toLowerCase());case"string":return String(i);case"path":return i?(0,$e.resolve)(i):"";default:return null}}let s=null;for(let[i,o]of Object.entries(Fr)){let a=i;if(r&&(a=a.toLowerCase().replace(/_/g,"-")),e===a?(s=n(t,o.type),a=i):e.startsWith(`${a}-`)&&(s=n(t,o.type),a=`${i}-${e.slice(i.length+1)}`),s!=null)return Y[a]=s,process.env[`GENIEACS_${a}`]=s,!0}return!1}var Vt=process.argv.slice(2);for(;Vt.length;){let e=Vt.shift();if(e[0]==="-"){let t=Vt.shift();$(e.slice(2),t,!0)}}for(let[e,t]of Object.entries(process.env))e.startsWith("GENIEACS_")&&$(e.slice(9),t);var Wr=ee?`${ee}/config.json`:`${M}/config/config.json`;if((0,Xe.existsSync)(Wr)){let e=JSON.parse((0,Xe.readFileSync)(Wr).toString());for(let[t,r]of Object.entries(e))$(t,r)||(process.env[`GENIEACS_${t}`]=`${r}`)}ee&&$("EXT_DIR",`${ee}/ext`);if(["true","1"].includes(Kt)){let e=ee||`${M}/config`;$("CWMP_SSL_CERT",`${e}/cwmp.crt`),$("CWMP_SSL_KEY",`${e}/cwmp.key`)}if(["true","1"].includes(Jt)){let e=ee||`${M}/config`;$("NBI_SSL_CERT",`${e}/cwmp.crt`),$("NBI_SSL_KEY",`${e}/cwmp.key`)}if(["true","1"].includes(Xt)){let e=ee||`${M}/config`;$("FS_SSL_CERT",`${e}/cwmp.crt`),$("FS_SSL_KEY",`${e}/cwmp.key`)}if(["true","1"].includes(Qt)){let e=ee||`${M}/config`;$("UI_SSL_CERT",`${e}/cwmp.crt`),$("UI_SSL_KEY",`${e}/cwmp.key`)}if(ht){let e=Y.FS_PORT||7567,t=!!Y.FS_SSL_CERT;$("FS_URL_PREFIX",(t?"https":"http")+`://${ht}:${e}/`)}for(let[e,t]of Object.entries(Fr))t.default!=null&&$(e,t.default);function A(e,t){if(!t)return Y[e];e=`${e}-${t}`;let r=Y[e];if(r!=null)return r;let n=e.lastIndexOf("-");return r=Y[e.slice(0,n)],r!=null||(n=e.lastIndexOf("-",n-1),r=Y[e.slice(0,n)],r!=null)||(n=e.lastIndexOf("-",n-1),r=Y[e.slice(0,n)],r!=null)||(n=e.lastIndexOf("-",n-1),n>0&&(r=Y[e.slice(0,n)],r!=null))?r:null}var P=T(require("fs")),Ce=T(require("os"));var Qe=require("ipaddr.js");var Zt=require("fs"),jr=T(require("http")),Gr=T(require("https")),Yt=T(require("path"));var F,vt,zr=!1;function Zs(e,t){if(!F)return void t();setTimeout(()=>{if(!t)return;F.removeListener("request",vt),F.setTimeout(1);let r=t;t=null,setTimeout(r,1e3)},e).unref(),F.close(()=>{if(!t)return;let r=t;t=null,setTimeout(r,50)})}var Hr=new WeakMap;function Ys(e){return e.split(":").map(t=>(t=t.trim(),t.startsWith("-----BEGIN ")?Buffer.from(t):(0,Zt.readFileSync)(Yt.resolve(M,t))))}function ei(e){return e.split(":").map(t=>(t=t.trim(),t.startsWith("-----BEGIN ")?Buffer.from(t):(0,Zt.readFileSync)(Yt.resolve(M,t))))}function Vr(e,t){if(vt=(r,n)=>{zr&&n.setHeader("Connection","close"),t(r,n).catch(s=>{try{n.socket.unref(),n.headersSent&&(n.writeHead(500,{Connection:"close"}),n.end(`${s.name}: ${s.message}`))}catch{}throw s})},e.ssl){let r={key:Ys(e.ssl.key),cert:ei(e.ssl.cert)};F=Gr.createServer(r,vt),e.onConnection&&F.on("secureConnection",e.onConnection)}else F=jr.createServer(vt),e.onConnection&&F.on("connection",e.onConnection);F.on("connection",r=>{Hr.set(r,{localAddress:r.localAddress,localPort:r.localPort,remoteAddress:r.remoteAddress,remotePort:r.remotePort,remoteFamily:r.remoteFamily})}),e.onClientError&&F.on("clientError",(r,n)=>{r.code!=="ECONNRESET"&&n.writable&&n.end(`HTTP/1.1 400 Bad Request\r
Connection: close\r
\r
`),e.onClientError(r,n)}),F.timeout=e.timeout||0,e.keepAliveTimeout!=null&&(F.keepAliveTimeout=e.keepAliveTimeout),e.requestTimeout!=null&&(F.requestTimeout=e.requestTimeout),F.listen({port:e.port,host:e.host})}function yt(e=!0){return zr=e,new Promise((t,r)=>{setTimeout(()=>{r(new Error("Could not close server in a timely manner"))},3e4).unref(),Zs(2e4,t)})}function er(e){var t;return Hr.get((t=e._parent)!=null?t:e)}var ri=""+A("FORWARDED_HEADER"),Kr=new WeakMap,tr=[];for(let e of ri.split(",").map(t=>t.trim()))try{tr.push((0,Qe.parseCIDR)(e))}catch{try{let r=(0,Qe.parse)(e);tr.push([r,r.toByteArray().length*8])}catch{}}function ni(e){e=e.toLowerCase();let t={},r=0,n=-1,s;for(let i=0;i<e.length;++i){let o=e.charCodeAt(i);if(o===61)r>=0&&(s=e.slice(r,i).trim(),r=-1,n=i+1);else if(o===59)n>=0&&(t[s]=e.slice(n,i).trim()),n=-1,r=i+1;else{if(o===44)return n>=0&&(t[s]=e.slice(n,i).trim()),t;if(o===34&&n>=0){let a=i;if(!e.slice(n,a).trim())for(i=i+1;i<e.length;++i){let l=e.charCodeAt(i);if(l===92&&++i,l===34){t[s]=JSON.parse(e.slice(a,i+1).trim()),n=-1,r=i+1;break}}}}}return n>=0&&(t[s]=e.slice(n).trim()),t}function rr(e){let t=Kr.get(e);if(!t){let r=e.socket,n=er(r);t={localAddress:n.localAddress,localPort:n.localPort,remoteAddress:n.remoteAddress,remotePort:n.remotePort,host:e.headers.host,encrypted:!!e.socket.encrypted};let s=e.headers.forwarded;if(s){let i=(0,Qe.parse)(n.remoteAddress);if(tr.some(o=>i.kind()===o[0].kind()&&i.match(o))){let o=ni(s);if(o.proto==="https"?(t.encrypted=!0,t.localPort=443):o.proto==="http"&&(t.encrypted=!1,t.localPort=80),o.host){t.host=o.host;let[,a]=o.host.split(":",2);t.localPort=+a||t.localPort}if(o.for)if(o.for.startsWith("[")){let a=o.for.lastIndexOf("]");a>=0&&(t.remoteAddress=o.for.slice(1,a),t.remotePort=parseInt(o.for.slice(a+2))||t.remotePort)}else{let a=o.for.lastIndexOf(":");a>=0?(t.remoteAddress=o.for.slice(0,a),t.remotePort=parseInt(o.for.slice(a+1))||t.remotePort):t.remoteAddress=o.for}if(o.by)if(o.by.startsWith("[")){let a=o.by.lastIndexOf("]");a>=0&&(t.localAddress=o.by.slice(1,a),t.localPort=parseInt(o.by.slice(a+2))||t.localPort)}else{let a=o.by.lastIndexOf(":");a>=0?(t.localAddress=o.by.slice(0,a),t.localPort=parseInt(o.by.slice(a+1))||t.localPort):t.localAddress=o.by}}}Kr.set(e,t)}return t}var me=6e4,Jr=A("LOG_FORMAT"),si=A("ACCESS_LOG_FORMAT")||Jr,ke={},nr=!1,sr=!1,Ae,Ie,oe=P.createWriteStream(null,{fd:process.stderr.fd}),Ue=P.fstatSync(oe.fd),ae=P.createWriteStream(null,{fd:process.stdout.fd}),xe=P.fstatSync(ae.fd);function wt(){let e=1;Ae&&(++e,P.stat(Ae,(t,r)=>{if(t&&!t.message.startsWith("ENOENT:"))throw t;r&&r.dev===Ue.dev&&r.ino===Ue.ino||(oe.end(),oe=P.createWriteStream(null,{fd:P.openSync(Ae,"a")}),Ue=P.fstatSync(oe.fd)),--e===0&&setTimeout(wt,me-Date.now()%me).unref()})),Ie&&(++e,P.stat(Ie,(t,r)=>{if(t&&!t.message.startsWith("ENOENT:"))throw t;r&&r.dev===xe.dev&&r.ino===xe.ino||(ae.end(),ae=P.createWriteStream(null,{fd:P.openSync(Ie,"a")}),xe=P.fstatSync(ae.fd)),--e===0&&setTimeout(wt,me-Date.now()%me).unref()})),--e===0&&setTimeout(wt,me-Date.now()%me).unref()}function Xr(e,t){ke.hostname=Ce.hostname(),ke.pid=process.pid,ke.name=`genieacs-${e}`,ke.version=t,Ae=A(`${e.toUpperCase()}_LOG_FILE`),Ie=A(`${e.toUpperCase()}_ACCESS_LOG_FILE`),Ae&&(oe=P.createWriteStream(null,{fd:P.openSync(Ae,"a")}),Ue=P.fstatSync(oe.fd)),Ie&&(ae=P.createWriteStream(null,{fd:P.openSync(Ie,"a")}),xe=P.fstatSync(ae.fd));let r=process.env.JOURNAL_STREAM;if(r){let[n,s]=r.split(":").map(parseInt);nr=Ue.dev===n&&Ue.ino===s,sr=xe.dev===n&&xe.ino===s}(Ae||Ie)&&setTimeout(wt,me-Date.now()%me).unref()}function Qr(){ae.end(),oe.end()}function ir(e){if(e.sessionContext){let t=e.sessionContext;e.deviceId=t.deviceId,e.remoteAddress=rr(t.httpRequest).remoteAddress,delete e.sessionContext}if(e.exception){let t=e.exception;e.exceptionName=t.name,e.exceptionMessage=t.message,e.exceptionStack=t.stack,delete e.exception}if(e.task&&(e.taskId=e.task._id,delete e.task),e.rpc){let t=e.rpc;t.acsRequest?(e.acsRequestId=t.id,e.acsRequestName=t.acsRequest.name,t.acsRequest.commandKey&&(e.acsRequestCommandKey=t.acsRequest.commandKey)):t.cpeRequest?(e.cpeRequestId=t.id,t.cpeRequest.name==="Inform"?(e.informEvent=t.cpeRequest.event.join(","),e.informRetryCount=t.cpeRequest.retryCount):(e.cpeRequestName=t.cpeRequest.name,t.cpeRequest.commandKey&&(e.cpeRequestCommandKey=t.cpeRequest.commandKey))):t.cpeFault&&(e.acsRequestId=t.id,e.cpeFaultCode=t.cpeFault.detail.faultCode,e.cpeFaultString=t.cpeFault.detail.faultString),delete e.rpc}if(e.fault){let t=e.fault;e.faultCode=t.code,e.faultMessage=t.message,delete e.fault}e.context&&(e.remoteAddress=rr(e.context.req).remoteAddress,e.context.state.user&&(e.user=e.context.state.user.username),delete e.context);for(let[t,r]of Object.entries(e))r==null&&delete e[t];return e}function Zr(e,t){if(t){let r="";return e.severity==="info"?r="<6>":e.severity==="warn"?r="<4>":e.severity==="error"&&(r="<3>"),`${r}${JSON.stringify(ir(e))}${Ce.EOL}`}return`${JSON.stringify(ir(e))}${Ce.EOL}`}function Yr(e,t){let r={user:!0,remoteAddress:!0,severity:!0,timestamp:!0,message:!0,deviceId:!!e.sessionContext};ir(e);let n="";e.remoteAddress&&(e.deviceId&&r.deviceId?n=`${e.remoteAddress} ${e.deviceId}: `:e.user?n=`${e.user}@${e.remoteAddress}: `:n=`${e.remoteAddress}: `);let s=Object.keys(e),i="",o=[];for(let a of s)r[a]||o.push(`${a}=${JSON.stringify(e[a])}`);if(o.length&&(i=`; ${o.join(" ")}`),t){let a="";return e.severity==="info"?a="<6>":e.severity==="warn"?a="<4>":e.severity==="error"&&(a="<3>"),`${a}${n}${e.message}${i}${Ce.EOL}`}return`${e.timestamp} [${e.severity.toUpperCase()}] ${n}${e.message}${i}${Ce.EOL}`}function or(e){e.timestamp=new Date().toISOString(),Jr==="json"?(e=Object.assign({},ke,e),oe.write(Zr(e,nr))):oe.write(Yr(e,nr))}function de(e){e.severity="info",or(e)}function en(e){e.severity="warn",or(e)}function le(e){e.severity="error",or(e)}function tn(e){e.timestamp=new Date().toISOString(),si==="json"?(Object.assign(e,ke),ae.write(Zr(e,sr))):ae.write(Yr(e,sr))}function x(e){e.severity="info",tn(e)}function ge(e){e.severity="warn",tn(e)}var J=T(require("cluster")),rn=require("os");var Et=0,ar=[];function lr(){let e=J.default.fork();return e.on("error",t=>{if(t.code!=="EPIPE")throw t;setTimeout(()=>{if(!e.isDead())throw t},50)}),e}function cr(e,t,r){let n={message:"Worker died",pid:e.process.pid,exitCode:null,signal:null};t!=null&&(n.exitCode=t),r!=null&&(n.signal=r),le(n);let s=Date.now();ar.push(s);let i=0,o=0,a=0;if(ar=ar.filter(l=>{if(l>s-6e4)++i;else if(l>s-12e4)++o;else if(l>s-18e4)++a;else return!1;return!0}),i>5&&o>5&&a>5){process.exitCode=1,J.default.removeListener("exit",cr);for(let l in J.default.workers)J.default.workers[l].kill();le({message:"Too many crashes, exiting",pid:process.pid});return}if(Et=Math.max(s,Et+2e3),Et===s){lr();return}setTimeout(()=>{process.exitCode||lr()},Et-s)}function nn(e,t,r){J.default.on("listening",(n,s)=>{(s.addressType===4||s.addressType===6)&&s.address===r&&s.port===t&&de({message:"Worker listening",pid:n.process.pid,address:s.address,port:s.port})}),J.default.on("exit",cr),e||(e=Math.max(2,(0,rn.cpus)().length));for(let n=0;n<e;++n)lr()}function ur(){J.default.removeListener("exit",cr);for(let e in J.default.workers)J.default.workers[e].kill()}var fr=J.default.worker;var mt=require("zlib"),$s=T(require("koa")),ks=T(require("koa-router")),Us=T(require("jsonwebtoken")),xs=T(require("koa-static")),qs=T(require("koa-compress")),Bs=T(require("koa-bodyparser")),Ws=T(require("koa-jwt"));var Mr=require("stream"),Is=T(require("koa-router")),Cs=require("mongodb");var Ar=require("vm");function pr(e){return e.replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&")}function Be(e){return encodeURIComponent(e).replace(/[!~*'().]/g,t=>"%"+t.charCodeAt(0).toString(16).toUpperCase()).replace(/0x(?=[0-9A-Z]{2})/g,"0%78").replace(/%/g,"0x")}function Ze(e){return decodeURIComponent(e.replace(/0x(?=[0-9A-Z]{2})/g,"%"))}function sn(e,t=!0){return new Promise(r=>{let n=setTimeout(r,e);t||n.unref()})}var h=T(require("parsimmon"));function ai(e){let t={b:"\b",f:"\f",n:`
`,r:"\r",t:"	"};return e.replace(/\\(u[0-9a-fA-F]{4}|[^u])/g,(r,n)=>{let s=n.charAt(0),i=n.slice(1);return s==="u"?String.fromCharCode(parseInt(i,16)):t.hasOwnProperty(s)?t[s]:s})}function he(e,t){if(!Array.isArray(e))return t(e);let r;for(let n=1;n<e.length;++n){let s=he(e[n],t);s!==e[n]&&(r=r||e.slice(),r[n]=s)}return t(r||e)}async function mr(e,t){if(!Array.isArray(e))return t(e);let r;for(let n=1;n<e.length;++n){let s=await mr(e[n],t);s!==e[n]&&(r=r||e.slice(),r[n]=s)}return t(r||e)}function Ye(e,t){return h.default.seqMap(t,h.default.seq(e,t).many(),(r,n)=>n.reduce((s,i)=>{let[o,a]=i;return Array.isArray(s)&&o===s[0]?s.concat([a]):[o,s,a]},r))}var on=h.default.createLanguage({ComparisonOperator:function(){return h.default.alt(h.default.string(">="),h.default.string("<>"),h.default.string("<="),h.default.string("="),h.default.string(">"),h.default.string("<")).skip(h.default.optWhitespace)},LikeOperator:function(){return h.default.alt(h.default.regexp(/like/i).result("LIKE").desc("LIKE"),h.default.regexp(/not\s+like/i).result("NOT LIKE").desc("NOT LIKE")).notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace)},IsNullOperator:function(){return h.default.alt(h.default.regexp(/is\s+null/i).result("IS NULL").desc("IS NULL"),h.default.regexp(/is\s+not\s+null/i).result("IS NOT NULL").desc("IS NOT NULL")).notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace)},NotOperator:function(){return h.default.regexp(/not/i).result("NOT").notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace).desc("NOT")},AndOperator:function(){return h.default.regexp(/and/i).result("AND").notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace).desc("AND")},OrOperator:function(){return h.default.regexp(/or/i).result("OR").notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace).desc("OR")},Parameter:function(e){return h.default.alt(h.default.regexp(/[a-zA-Z0-9_.*-]+/),e.Expression.wrap(h.default.string("{").skip(h.default.optWhitespace),h.default.string("}"))).atLeast(1).map(t=>["PARAM",t.length>1?["||"].concat(t):t[0]]).skip(h.default.optWhitespace).desc("parameter")},StringValueSql:function(){return h.default.regexp(/'([^']*)'/,1).atLeast(1).skip(h.default.optWhitespace).map(e=>e.join("'")).desc("string")},StringValueJs:function(){return h.default.regexp(/"((?:\\.|.)*?)"/,1).skip(h.default.optWhitespace).map(ai).desc("string")},NumberValue:function(){return h.default.regexp(/-?(0|[1-9][0-9]*)([.][0-9]+)?([eE][+-]?[0-9]+)?/).notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace).map(Number).desc("number")},BooleanValue:function(){return h.default.alt(h.default.regexp(/true/i).result(!0).desc("TRUE"),h.default.regexp(/false/i).result(!1).desc("FALSE")).notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace)},NullValue:function(){return h.default.regexp(/null/i).notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace).result(null).desc("NULL")},FuncValue:function(e){return h.default.seqMap(h.default.regexp(/([a-zA-Z0-9_]+)/,1).skip(h.default.optWhitespace).desc("function"),e.ExpressionList.wrap(h.default.string("(").skip(h.default.optWhitespace),h.default.string(")").skip(h.default.optWhitespace)),(t,r)=>["FUNC",t.toUpperCase()].concat(r))},WhenPair:function(e){return h.default.seq(h.default.regexp(/when/i).notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace).desc("WHEN").then(e.Expression),h.default.regexp(/then/i).notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace).desc("THEN").then(e.Expression))},CaseStatement:function(e){return h.default.seqMap(h.default.regexp(/case/i).result("CASE").notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace).desc("CASE"),e.WhenPair.many(),h.default.regexp(/else/i).notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace).desc("ELSE").then(e.Expression).map(t=>[[!0,t]]).fallback(null).skip(h.default.regex(/end/i).notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/))).skip(h.default.optWhitespace),(...t)=>t.flat(2))},Value:function(e){return h.default.alt(e.NullValue,e.BooleanValue,e.NumberValue,e.StringValueSql,e.StringValueJs,e.FuncValue,e.CaseStatement)},ValueExpression:function(e){return Ye(h.default.string("||").skip(h.default.optWhitespace),Ye(h.default.alt(h.default.string("+"),h.default.string("-")).skip(h.default.optWhitespace),Ye(h.default.alt(h.default.string("*"),h.default.string("/"),h.default.string("%")).skip(h.default.optWhitespace),h.default.alt(e.Value,e.Parameter,e.Expression.wrap(h.default.string("(").skip(h.default.optWhitespace),h.default.string(")").skip(h.default.optWhitespace))))))},Comparison:function(e){return h.default.alt(h.default.seqMap(e.ValueExpression,e.IsNullOperator,(t,r)=>[r,t]),h.default.seqMap(e.ValueExpression,e.ComparisonOperator,e.ValueExpression,(t,r,n)=>[r,t,n]),h.default.seqMap(e.ValueExpression,e.LikeOperator,e.ValueExpression.skip(h.default.regexp(/escape/i).result("ESCAPE").skip(h.default.whitespace).desc("ESCAPE")),e.ValueExpression,(t,r,n,s)=>[r,t,n,s]),h.default.seqMap(e.ValueExpression,e.LikeOperator,e.ValueExpression,(t,r,n)=>[r,t,n]))},ExpressionList:function(e){return e.Expression.sepBy(h.default.string(",").skip(h.default.optWhitespace))},Expression:function(e){function t(r,n){return h.default.seq(r,n).or(n)}return Ye(e.OrOperator,Ye(e.AndOperator,t(e.NotOperator,e.Comparison.or(e.ValueExpression)))).trim(h.default.optWhitespace)}});function H(e){return e?on.Expression.tryParse(e):null}function an(e){return e?on.ExpressionList.tryParse(e):[]}function q(e,t=0){if(!Array.isArray(e))return JSON.stringify(e);let r={OR:10,AND:11,NOT:12,"=":20,"<>":20,">":20,">=":20,"<":20,"<=":20,LIKE:20,"NOT LIKE":20,"IS NULL":20,"IS NOT NULL":20,"||":30,"+":31,"-":31,"*":32,"/":32,"%":32},n=e[0].toUpperCase();function s(i){return r[n]<=t?`(${i})`:i}if(n==="FUNC")return s(`${e[1]}(${e.slice(2).map(i=>q(i)).join(", ")})`);if(n==="PARAM")return typeof e[1]=="string"?s(e[1]):Array.isArray(e[1])&&e[1][0]==="||"?s(e[1].slice(1).map(i=>typeof i=="string"?i:`{${q(i)}}`).join("")):s(`{${q(e[1])}}`);if(n==="IS NULL"||n==="IS NOT NULL")return s(`${q(e[1],r[n])} ${n}`);if(n==="LIKE"||n==="NOT LIKE")return e[3]?s(`${q(e[1],r[n])} ${n} ${q(e[2],r[n])} ESCAPE ${q(e[3],r[n])}`):s(`${q(e[1],r[n])} ${n} ${q(e[2],r[n])}`);if(n==="CASE"){let i=["CASE"];for(let o=1;o<e.length-1;o+=2){if(!Array.isArray(e[o])&&e[o]){e[o+1]!=null&&i.push("ELSE",q(e[o+1]));break}i.push("WHEN",q(e[o]),"THEN",q(e[o+1]))}return i.push("END"),i.join(" ")}else if(n in r){let i=e.slice(1).map((o,a)=>q(o,r[e[0]]+Math.min(a-1,0)));return s(n==="NOT"?`${n} ${i[0]}`:i.join(` ${n} `))}else throw new Error(`Unrecognized operator ${e[0]}`)}function We(e,t){let r=e.split("");for(let n=0;n<r.length;++n){let s=r[n];if(s===t)r[n]=r[n+1]||"",r[n+1]="";else if(s==="_")r[n]="\\_";else if(s==="%")for(r[n]="\\%";r[n+1]==="%";)r[++n]=""}return r.filter(n=>n)}var b=Array.isArray,bt=new WeakMap,Te={};function Fe(e,t){let r=!0;for(;r;){r=!1;for(let n=2;n<e.length;++n){let s=t(e[n-1],e[n],n-2);s!==Te&&(r=!0,e=e.slice(),e.splice(n-1,2,s))}}return e.length===2?e[1]:e}function ln(e,t="",r=""){let n={"-":"\\-","/":"\\/","\\":"\\/","^":"\\^",$:"\\$","*":"\\*","+":"\\+","?":"\\?",".":"\\.","(":"\\(",")":"\\)","|":"\\|","[":"\\[","]":"\\]","{":"\\{","}":"\\}","\\%":".*","\\_":"."},s=We(e,t);if(!s.length)return new RegExp("^$",r);s=s.map(o=>n[o]||o),s[0]=s[0]===".*"?"":"^"+s[0];let i=s.length-1;return s[i]=[".*",""].includes(s[i])?"":s[i]+"$",new RegExp(s.join(""),r)}function je(e,t){return typeof e=="boolean"&&(e=+e),typeof t=="boolean"&&(t=+t),typeof e!=typeof t?typeof e=="string"?1:-1:e>t?1:e<t?-1:0}function V(e){switch(typeof e){case"number":return e;case"boolean":return+e;case"string":return parseFloat(e)||0}}function St(e){switch(typeof e){case"string":return e;case"number":return e.toString();case"boolean":return(+e).toString()}}function _t(e){if(!Array.isArray(e))return e;if(e[0]==="CASE"){for(let t=1;t<e.length;t+=2){if(Array.isArray(e[t]))return e;if(e[t])return e[t+1]}return null}else if(e[0]==="FUNC"){if(e[1]==="COALESCE"){let t=[];for(let r=2;r<e.length;++r){let n=e[r];if(n!=null&&(t.push(n),!Array.isArray(n)))break}return t.length?t.length===1?t[0]:["FUNC","COALESCE",...t]:null}else if(e[1]==="UPPER"){if(e[2]==null)return null;if(!b(e[2]))return St(e[2]).toUpperCase()}else if(e[1]==="LOWER"){if(e[2]==null)return null;if(!b(e[2]))return St(e[2]).toLowerCase()}else if(e[1]==="ROUND"){let t=e[2],r=e.length>3?e[3]:0;if(t==null||r==null)return null;if(!b(t)&&!b(r)){let n=10**r,s=t*n*(1+Number.EPSILON);return Math.round(s)/n}}}else if(e[0]==="PARAM"){if(e[1]==null)return null}else if(e[0]==="AND"){for(let r=1;r<e.length;++r)if(!Array.isArray(e[r])&&e[r]!=null&&!e[r])return!1;let t=[];for(let r=1;r<e.length;++r){let n=e[r];if(n==null)return null;Array.isArray(n)&&(n[0]==="AND"?t.push(...n.slice(1)):t.push(n))}return t.length?(t.length===1&&t.push(!0),["AND",...t]):!0}else if(e[0]==="OR"){let t=[];for(let r=1;r<e.length;++r){let n=e[r];if(Array.isArray(n))n[0]==="OR"?t.push(...n.slice(1)):t.push(n);else if(n)return!0}return t.length?(t.length===1&&t.push(!1),["OR",...t]):e.some(r=>r==null)?null:!1}else if(e[0]==="NOT"){if(e[1]==null)return null;if(b(e[1])){if(e[1][0]==="NOT")return e[1][1]}else return!e[1]}else{if(e[0]==="IS NULL")return b(e[1])?e:e[1]==null;if(e[0]==="IS NOT NULL")return b(e[1])?e:e[1]!=null;if(e[0]==="LIKE"){if(b(e[1])||b(e[2])||b(e[3]))return e;if(e[1]==null||e[2]==null||e.length>=4&&e[3]==null)return null;let t=bt.get(e);return t||(t=ln(e[2],e[3]),bt.set(e,t)),t.test(e[1])}else if(e[0]==="NOT LIKE"){if(b(e[1])||b(e[2])||b(e[3]))return e;if(e[1]==null||e[2]==null||e.length>=4&&e[3]==null)return null;let t=bt.get(e);return t||(t=ln(e[2],e[3]),bt.set(e,t)),!t.test(e[1])}else{if(e[0]==="=")return e[1]==null||e[2]==null?null:b(e[1])||b(e[2])?e:je(e[1],e[2])===0;if(e[0]==="<>")return e[1]==null||e[2]==null?null:b(e[1])||b(e[2])?e:je(e[1],e[2])!==0;if(e[0]===">")return e[1]==null||e[2]==null?null:b(e[1])||b(e[2])?e:je(e[1],e[2])>0;if(e[0]===">=")return e[1]==null||e[2]==null?null:b(e[1])||b(e[2])?e:je(e[1],e[2])>=0;if(e[0]==="<")return e[1]==null||e[2]==null?null:b(e[1])||b(e[2])?e:je(e[1],e[2])<0;if(e[0]==="<=")return e[1]==null||e[2]==null?null:b(e[1])||b(e[2])?e:je(e[1],e[2])<=0;if(e[0]==="*")return Fe(e,(t,r)=>t==null||r==null?null:!b(t)&&!b(r)?V(t)*V(r):Te);if(e[0]==="/")return Fe(e,(t,r,n)=>{if(t==null||r==null)return null;if(b(t)||b(r))return Te;let s=V(t),i=V(r);return n!==0?s*i:i===0?null:s/i});if(e[0]==="+")return Fe(e,(t,r)=>t==null||r==null?null:!b(t)&&!b(r)?V(t)+V(r):Te);if(e[0]==="-")return Fe(e,(t,r,n)=>t==null||r==null?null:!b(t)&&!b(r)?n===0?V(t)-V(r):V(t)+V(r):Te);if(e[0]==="%")return Fe(e,(t,r,n)=>{if(t==null||r==null)return null;if(b(t)||b(r)||n!==0)return Te;let s=V(t),i=Math.trunc(V(r));return i===0?null:s%i});if(e[0]==="||")return Fe(e,(t,r)=>t==null||r==null?null:!b(t)&&!b(r)?St(t)+St(r):Te)}}return e}function j(e,t,r,n){return he(e,s=>{if(n&&(s=n(s)),!b(s))return s;if(s[0]==="FUNC"&&s[1]==="NOW"){if(r)return r}else if(s[0]==="PARAM"){if(s[1]==null)return null;if(t&&!b(s[1])){let i;return typeof t=="function"?i=t(s[1]):i=t[s[1]],i==null?null:(typeof i=="object"&&(i=i.value?i.value[0]:null),i)}}return _t(s)})}async function cn(e,t,r,n){return mr(e,async s=>{if(n&&(s=await n(s)),!b(s))return s;if(s[0]==="FUNC"){if(s[1]==="NOW"&&r)return r}else if(s[0]==="PARAM"){if(s[1]==null)return null;if(t&&!b(s[1])){let i=t[s[1]];return i==null?null:(typeof i=="object"&&(i=i.value?i.value[0]:null),i)}}return _t(s)})}function k(e,t){if(e!=null&&!e||t!=null&&!t)return!1;if(!Array.isArray(e)&&!Array.isArray(t))return e==null||t==null?null:!0;if(!Array.isArray(t)&&e[0]==="AND")return e;if(!Array.isArray(e)&&t[0]==="AND")return t;let r=["AND"];return Array.isArray(e)&&e[0]==="AND"?r.push(...e.slice(1)):r.push(e),Array.isArray(t)&&t[0]==="AND"?r.push(...t.slice(1)):r.push(t),r}function un(e,t){if(!Array.isArray(e)&&e||!Array.isArray(t)&&t)return!0;if(!Array.isArray(e)&&!Array.isArray(t))return e==null||t==null?null:!1;if(!Array.isArray(t)&&e[0]==="OR")return e;if(!Array.isArray(e)&&t[0]==="OR")return t;let r=["OR"];return Array.isArray(e)&&e[0]==="OR"?r.push(...e.slice(1)):r.push(e),Array.isArray(t)&&t[0]==="OR"?r.push(...t.slice(1)):r.push(t),r}function fn(e){let t=new Set;return he(e,r=>(b(r)&&r[0]==="PARAM"&&t.add(r[1]),r)),Array.from(t)}var It=require("mongodb");var et,w={devices:null,presets:null,objects:null,provisions:null,virtualParameters:null,faults:null,tasks:null,files:null,operations:null,permissions:null,users:null,config:null,cache:null,locks:null},At;async function pn(){At=It.MongoClient.connect(""+A("MONGODB_CONNECTION_URL"));let t=(await At).db();w.tasks=t.collection("tasks"),w.devices=t.collection("devices"),w.presets=t.collection("presets"),w.objects=t.collection("objects"),w.files=t.collection("fs.files"),w.provisions=t.collection("provisions"),w.virtualParameters=t.collection("virtualParameters"),w.faults=t.collection("faults"),w.operations=t.collection("operations"),w.permissions=t.collection("permissions"),w.users=t.collection("users"),w.config=t.collection("config"),w.cache=t.collection("cache"),w.locks=t.collection("locks"),et=new It.GridFSBucket(t),await Promise.all([w.tasks.createIndex({device:1,timestamp:1}),w.cache.createIndex({expire:1},{expireAfterSeconds:0}),w.locks.createIndex({expire:1},{expireAfterSeconds:0})])}async function mn(){At!=null&&await(await At).close()}function dn(e){if(e[""])return{"":e[""]};let t=Object.keys(e).sort();if(t.length<=1)return e;for(let r=1;r<t.length;++r){let n=t[r-1],s=t[r];s.startsWith(n)&&(s.charAt(n.length)==="."||s.charAt(n.length-1)===".")&&(delete e[s],t.splice(r--,1))}return e}function gn(e){function t(r){let n=[];for(let[s,i]of Object.entries(r))if(s[0]==="$")if(s==="$and"){let o=["AND"];for(let a of Object.values(i))o.push(t(a));n.push(o)}else if(s==="$or"){let o=["OR"];for(let a of Object.values(i))o.push(t(a));n.push(o)}else throw new Error(`Operator ${s} not supported`);else if(s==="_tags")if(typeof i=="object"){if(Array.isArray(i))throw new Error("Invalid type");let o=[];for(let[a,l]of Object.entries(i))if(a==="$ne"){if(typeof i.$ne!="string")throw new Error("Only string values are allowed for _tags");o.push(["IS NULL",["PARAM",`Tags.${Be(l)}`]])}else if(a==="$eq"){if(typeof i.$eq!="string")throw new Error("Only string values are allowed for _tags");o.push(["IS NOT NULL",["PARAM",`Tags.${Be(l)}`]])}else throw new Error("Invalid tag query");o.length===1?n.push(o[0]):o.length>1&&n.push(["AND",...o])}else n.push(["IS NOT NULL",["PARAM",`Tags.${Be(i)}`]]);else if(s.startsWith("Tags.")){let o;if(typeof i=="boolean")o=i;else if(i.hasOwnProperty("$eq"))o=!!i.$eq;else if(i.hasOwnProperty("$ne"))o=!i.$ne;else if(i.hasOwnProperty("$exists"))o=!!i.$exists;else throw new Error("Invalid tag query");n.push([o?"IS NOT NULL":"IS NULL",["PARAM",s]])}else if(typeof i=="object"){if(Array.isArray(i))throw new Error("Invalid type");let o=[];for(let[a,l]of Object.entries(i)){if(a==="$eq")o.push(["=",["PARAM",s],l]);else if(a==="$ne")o.push(["OR",["<>",["PARAM",s],l],["IS NULL",["PARAM",s]]]);else if(a==="$lt")o.push(["<",["PARAM",s],l]);else if(a==="$lte")o.push(["<=",["PARAM",s],l]);else if(a==="$gt")o.push([">",["PARAM",s],l]);else if(a==="$gte")o.push([">=",["PARAM",s],l]);else throw new Error(`Operator ${a} not supported`);if(!["string","number","boolean"].includes(typeof l))throw new Error(`Invalid value for ${a} operator`)}if(o.length===1)n.push(o[0]);else if(o.length>1){let a=["AND"];n.push(a.concat(o))}}else n.push(["=",["PARAM",s],i]);return n.length===1?n[0]:n.length===0?!0:["AND",...n]}return Object.keys(e).length?t(e):!0}var In=require("bson");var C=require("espresso-iisojs");function dr(e,t){return e+t}function ce(e,t){return e*t}function tt(e,t){return e/t}function hn(e,t){return e**t}function vn(e,t){return e%t}function gr(e){return Number(e)}function hr(e,t){return e!==t}function vr(e,t){return e<t}var X=BigInt;var rt=X(0),yr=X(1),ui=X(2),wn=X(-1),ve=class e{constructor(t){this.map=new Map,t?(this.map.set(t,1),this.sortedKeys=[t]):this.sortedKeys=[]}reciprocal(){let t=new e;t.sortedKeys=this.sortedKeys,t.map=new Map;for(let[r,n]of this.map)t.map.set(r,0-n);return t}static multiply(t,r){let n=new e;n.sortedKeys=t.sortedKeys.slice(),n.map=new Map(t.map);for(let[s,i]of r.map){let o=n.map.get(s);if(!o)n.map.set(s,i),n.sortedKeys.push(s);else{let a=i+o;a?n.map.set(s,a):(n.map.delete(s),n.sortedKeys=n.sortedKeys.filter(l=>l!==s))}}return n.sortedKeys.sort((s,i)=>s.length!==i.length?i.length-s.length:s>i?1:s<i?-1:0),n}static compare(t,r){if(t.sortedKeys.length!==r.sortedKeys.length)return r.sortedKeys.length-t.sortedKeys.length;for(let n=0;n<t.sortedKeys.length;++n){let s=t.sortedKeys[n],i=t.map.get(s),o=r.sortedKeys[n],a=r.map.get(o);if(i!==a)return a-i;if(s.length>o.length)return-1;if(s.length<o.length)return 1;if(s>o)return 1;if(s<o)return-1}return 0}};function En(e,t){for(;hr(t,rt);){let r=t;t=vn(e,t),e=r}return e}var N=class e{constructor(t){this.terms=t}static simplifyTerms(t){let r=t.slice().sort((n,s)=>ve.compare(n.indeterminates,s.indeterminates));for(let n=1;n<r.length;++n){let s=r[n-1],i=r[n];if(ve.compare(s.indeterminates,i.indeterminates)===0){let o=dr(ce(s.coefficientNumerator,i.coefficientDenominator),ce(i.coefficientNumerator,s.coefficientDenominator)),a=ce(s.coefficientDenominator,i.coefficientDenominator),l=En(o,a);r[n]={indeterminates:i.indeterminates,coefficientNumerator:tt(o,l),coefficientDenominator:tt(a,l)},r[n-1]={indeterminates:s.indeterminates,coefficientNumerator:rt,coefficientDenominator:s.coefficientDenominator}}}return r.filter(n=>hr(n.coefficientNumerator,rt))}static fromIndeterminate(t){let n=[{indeterminates:new ve(JSON.stringify(t)),coefficientNumerator:yr,coefficientDenominator:yr}];return new e(n)}static fromConstant(t){let[r,n]=Math.abs(t).toString(2).split(".",2),s=X("0b"+r);t<0&&(s=ce(s,wn));let i=yr;n&&(i=hn(ui,X(n.length)),s=dr(ce(s,i),X("0b"+n)));let o=[{indeterminates:new ve,coefficientNumerator:s,coefficientDenominator:i}];return new e(o)}negation(){let t=this.terms.map(r=>({indeterminates:r.indeterminates,coefficientNumerator:ce(r.coefficientNumerator,wn),coefficientDenominator:r.coefficientDenominator}));return new e(t)}reciprocal(){let t=this.terms.map(r=>({indeterminates:r.indeterminates.reciprocal(),coefficientNumerator:r.coefficientDenominator,coefficientDenominator:r.coefficientNumerator}));return new e(t)}constant(){let t=this.terms.filter(r=>!r.indeterminates.sortedKeys.length);return new e(t)}add(t){return new e(e.simplifyTerms(this.terms.concat(t.terms)))}subtract(t){return this.add(t.negation())}multiply(t){let r=[];for(let n of this.terms)for(let s of t.terms){let i=ce(n.coefficientNumerator,s.coefficientNumerator),o=ce(n.coefficientDenominator,s.coefficientDenominator),a=En(i,o);r.push({indeterminates:ve.multiply(n.indeterminates,s.indeterminates),coefficientNumerator:tt(i,a),coefficientDenominator:tt(o,a)})}return new e(e.simplifyTerms(r))}divide(t){return this.multiply(t.reciprocal())}toString(){let t=[];for(let r of this.terms){let n=gr(r.coefficientNumerator)/gr(r.coefficientDenominator),s=[];if(r.indeterminates.sortedKeys.length){for(let i of r.indeterminates.sortedKeys){let o=r.indeterminates.map.get(i);for(let a=Math.abs(o);a>0;--a)o>0?s.push(i):s.push(`["/",1,${i}]`)}n!==1&&s.push(n.toString()),s.length>1?t.push(`["*",${s.join(",")}]`):t.push(s[0])}else t.push(n.toString())}return t.length?t.length===1?t[0]:`["+",${t.join(",")}]`:"0"}},fi=N.fromConstant(0),pi=N.fromConstant(1),mi={"=":"=","<>":"<>",">":"<",">=":"<=","<":">","<=":">="};function Ct(e){if(!Array.isArray(e))return e;let t=e[0];if(t==="FUNC"&&e[1]==="COALESCE"){let s=["CASE"];for(let i=2;i<e.length;++i)s.push(Ct(["IS NOT NULL",e[i]]),e[i]);return Ct(s)}if(t==="CASE"){let s=[];for(let i=1;i<e.length;i+=2){let o=e[i];if(o instanceof N&&(o=JSON.parse(o.toString())),!Array.isArray(o)&&!o)continue;let a=e[i+1];if(!Array.isArray(a)||a[0]!=="CASE"){s.push([o,a]);continue}for(let l=1;l<a.length;l+=2)s.push([k(o,a[l]),a[l+1]]);if(s.push([o,null]),!Array.isArray(o)&&o)break}for(;s[s.length-1][1]==null;)s.pop();return["CASE",...s.flat()]}let r=new Map;for(let[s,i]of e.entries()){if(!Array.isArray(i)||i[0]!=="CASE")continue;let o=[];for(let a=1;a<i.length;a+=2)o.push([i[a],i[a+1]]);o.push([!0,null]),r.set(s,o)}if(r.size){let s=[[!0,e]];for(let[i,o]of r){let a=[];for(let[l,u]of o)if(a.push(...s.map(p=>{let m=p[1].slice();return m[i]=u,[k(l,p[0]),m]})),!Array.isArray(l)&&l)break;s=a}for(let i of s)i[1]=Ct(i[1]);if(s[0][0]===!0)return s[0][1];for(;s[s.length-1][1]==null;)s.pop();return["CASE",...s.flat()]}function n(s){return s==null?null:s instanceof N?s:typeof s=="number"?N.fromConstant(s):typeof s=="string"?N.fromConstant(parseFloat(s)||0):typeof s=="boolean"?N.fromConstant(+s):N.fromIndeterminate(s)}if(t==="+"){let s=[];for(let i=1;i<e.length;++i){let o=n(e[i]);if(o==null)return null;s.push(o)}return s.reduce((i,o)=>i.add(o),fi)}else if(t==="*"){let s=[];for(let i=1;i<e.length;++i){let o=n(e[i]);if(o==null)return null;s.push(o)}return s.reduce((i,o)=>i.multiply(o),pi)}else if(t==="-"){let s=[];for(let i=1;i<e.length;++i){let o=n(e[i]);if(o==null)return null;s.push(o)}return s.reduce((i,o)=>i.subtract(o))}else if(t==="/"){let s=[];for(let i=1;i<e.length;++i){let o=n(e[i]);if(o==null)return null;s.push(o)}return s.reduce((i,o)=>i.divide(o))}else if(["=","<>",">",">=","<","<="].includes(t)){if(e[1]==null||e[2]==null)return null;let s,i;if(e[1]instanceof N?s=e[1]:typeof e[1]=="number"&&(s=N.fromConstant(e[1])),e[2]instanceof N?i=e[2]:typeof e[2]=="number"&&(i=N.fromConstant(e[2])),s||i)if(s||(s=N.fromIndeterminate(e[1])),i||(i=N.fromIndeterminate(e[2])),s=s.subtract(i),i=s.constant().negation(),s=s.add(i),s.terms.length){let o=1,a=s.terms[0].coefficientNumerator,l=s.terms[0].coefficientDenominator;(vr(a,rt)||vr(l,rt))&&(o*=-1);let u=new N([{indeterminates:new ve,coefficientNumerator:l,coefficientDenominator:a}]);s=s.multiply(u),i=i.multiply(u);let p=s.terms[0].indeterminates.sortedKeys,m=s.terms[0].indeterminates.map.get(p[0])<0?-1:0;for(let c of s.terms)for(let f of c.indeterminates.map.values())m+=f;m<0&&(o*=-1,s=s.reciprocal(),i=i.reciprocal()),o<0?e=[mi[t],s,i]:e=[t,s,i]}else{if(e=[t,JSON.parse(s.toString()),JSON.parse(i.toString())],t==="=")return e[1]===e[2];if(t==="<>")return e[1]!==e[2];if(t===">")return e[1]>e[2];if(t===">=")return e[1]>=e[2];if(t==="<")return e[1]<e[2];if(t==="<=")return e[1]<=e[2]}}return e=e.map(s=>s instanceof N?JSON.parse(s.toString()):s),e=_t(e),e}function nt(e){return e=he(e,Ct),e instanceof N?e=JSON.parse(e.toString()):Array.isArray(e)&&e[0]==="CASE"&&(e=e.map(t=>t instanceof N?JSON.parse(t.toString()):t)),e}var st=class{variables=new Map;clauses=new Map;getVar(t){let r=t.toString(),n=this.variables.get(r);return n==null&&(n=this.variables.size,this.variables.set(r,n),this.clauses.set(n,t)),n}getClause(t){return this.clauses.get(t)}canRaise(t,r){return!0}canLower(t,r){return!0}bias(t,r){return(r^1)-(t^1)}sanitizeMinterms(t){return t}minimize(t,r=[]){t=this.sanitizeMinterms(t);let n=this.canRaise.bind(this),s=this.canLower.bind(this),i=this.bias.bind(this);return(0,C.espresso)(t,[...this.getDcSet([...t,...r]),...r],{canRaise:n,canLower:s,bias:i})}};function*Tt(e){if(!Array.isArray(e))return;let t=e[0];if(!(t==="IS NULL"||t==="IS NOT NULL")){if(t==="FUNC"){if(e[1]==="NOW")return;if(e[1]==="LOWER"||e[1]==="UPPER")yield*Tt(e[2]);else if(e[1]==="ROUND"){for(let r of e.slice(2,4))yield*Tt(r);return}}else if(t!=="PARAM"){for(let r of e.slice(1))yield*Tt(r);return}yield e}}var D=class e{_isNullable;_expression;expression(){if(this._expression!==void 0)return this._expression;let t=Sn(),r=this.true(t),n=t.minimize(r);return this._expression=t.toExpression(n),this._expression}isBoolean(){return!0}isNullable(t){return this._isNullable||(this._isNullable=new Set([...this.getNullables()].map(r=>r.toString()))),this._isNullable.has(t.toString())}*getNullables(){let t=this.expression();for(let r of Tt(t))r===t?yield new e.IsNull(this):yield new e.IsNull(new e.Exp(r))}toString(){return JSON.stringify(this.expression())}};(u=>{class e extends u{constructor(c){super();this.operand=c}true(c){return this.operand.false(c)}false(c){return this.operand.true(c)}null(c){return this.operand.null(c)}}u.Not=e;class t extends u{constructor(c){super();this.operands=c}true(c){let f=[];for(let g of this.operands){let d=g.true(c);if(d.length===1&&!d[0].length)return[[]];f.push(...d)}return f}false(c){let f=[],g=[...this.operands];for(let d of g){if(d instanceof t){g.push(...d.operands);continue}let y=d.false(c);if(!y.length)return[];f.push(y)}return f.length?f.length===1?f[0]:(0,C.complement)(f.map(d=>(0,C.complement)(d)).flat()):[[]]}null(c){let f=[],g=[...this.operands];for(let y of g){if(y instanceof t){g.push(...y.operands);continue}let v=y.true(c);if(v.length===1&&!v[0].length)return[];f.push(...v)}let d=[];for(let y of g){let v=y.null(c);if(v.length===1&&!v[0].length&&!f.length)return[[]];d.push(...v)}return f.length?(0,C.complement)([...(0,C.complement)(d),...f]):d}}u.Or=t;class r extends u{constructor(c){super();this.operands=c}true(c){let f=[],g=[...this.operands];for(let d of g){if(d instanceof r){g.push(...d.operands);continue}let y=d.true(c);if(!y.length)return[];y.length===1&&!y[0].length||f.push(y)}return f.length?f.length===1?f[0]:(0,C.complement)(f.map(d=>(0,C.complement)(d)).flat()):[[]]}false(c){let f=[];for(let g of this.operands){let d=g.false(c);if(d.length===1&&!d[0].length)return[[]];f.push(...d)}return f}null(c){let f=[],g=[...this.operands];for(let y of g){if(y instanceof r){g.push(...y.operands);continue}let v=y.false(c);if(v.length===1&&!v[0].length)return[];f.push(...v)}let d=[];for(let y of g){let v=y.null(c);if(v.length===1&&!v[0].length&&!f.length)return[[]];d.push(...v)}return f.length?(0,C.complement)([...(0,C.complement)(d),...f]):d}}u.And=r;class n extends u{constructor(c){super();this.clauses=c}true(c){let f=[],g=[];for(let d=0;d<this.clauses.length;d+=2){let y=this.clauses[d].true(c),v=this.clauses[d+1].true(c);f.push(...(0,C.complement)([...g,...(0,C.complement)(y),...(0,C.complement)(v)])),d<this.clauses.length-2&&g.push(...(0,C.complement)([...this.clauses[d].false(c),...this.clauses[d].null(c)]))}return f}false(c){let f=[],g=[];for(let d=0;d<this.clauses.length;d+=2){let y=this.clauses[d].true(c),v=this.clauses[d+1].false(c);f.push(...(0,C.complement)([...g,...(0,C.complement)(y),...(0,C.complement)(v)])),d<this.clauses.length-2&&g.push(...(0,C.complement)([...this.clauses[d].false(c),...this.clauses[d].null(c)]))}return f}null(c){let f=[],g=[];for(let d=0;d<this.clauses.length;d+=2){let y=this.clauses[d].true(c),v=this.clauses[d+1].null(c);f.push(...(0,C.complement)([...g,...(0,C.complement)(y),...(0,C.complement)(v)])),g.push(...(0,C.complement)([...this.clauses[d].false(c),...this.clauses[d].null(c)]))}return f.push(...(0,C.complement)([...g])),f}expression(){if(this._expression!=null)return this._expression;if(this.isBoolean())return this._expression=new u.Not(new u.Not(this)).expression(),this._expression;let c=Sn(),f=[];for(let g=0;g<this.clauses.length;g+=2){let d=this.clauses[g].true(c),y=this.clauses[g+1].expression();if(f.length&&JSON.stringify(y)===JSON.stringify(f[f.length-1].then)&&d.push(...f.pop().when),d=c.minimize(d,f.flatMap(v=>v.when)),!!d.length&&(f.push({when:d,then:y}),d.length===1&&!d[0].length))break}for(;f[f.length-1].then==null;)f.pop();return f.length?(this._expression=["CASE",...f.flatMap(g=>[c.toExpression(g.when),g.then])],this._expression):null}isBoolean(){for(let c=1;c<this.clauses.length;c+=2)if(!this.clauses[c].isBoolean())return!1;return!0}}u.Case=n;class s extends u{constructor(c){super();this.operand=c;this._boolean=new e(new e(this))}_boolean;true(c){return this.operand.null(c)}false(c){return(0,C.complement)(this.true(c))}null(){return[]}isBoolean(){return!0}*getNullables(){}expression(){let c=[...this.operand.getNullables()];return c.length===1&&c[0].operand===this.operand?["IS NULL",this.operand.expression()]:super.expression()}}u.IsNull=s;class i extends u{constructor(c){super();this.exp=c}true(c){return Array.isArray(this.exp)?c.getMinterms(this,!0):this.exp?[[]]:[]}false(c){return Array.isArray(this.exp)?c.getMinterms(this,!1):!this.exp&&this.exp!=null?[[]]:[]}null(c){return Array.isArray(this.exp)?c.getMinterms(this,null):this.exp==null?[[]]:[]}expression(){return this.exp}isBoolean(){return this.exp===!0||this.exp===!1||this.exp==null}}u.Exp=i;class o extends u{constructor(c,f,g){super();this.lhs=c;this.op=f;this.rhs=g}true(c){return c.getMinterms(this,!0)}false(c){return c.getMinterms(this,!1)}null(c){return this.lhs.null(c)}*getNullables(){yield*this.lhs.getNullables()}isBoolean(){return!0}expression(){return[this.op,this.lhs.expression(),this.rhs]}}u.Compare=o;class a extends u{constructor(c,f,g){super();this.rhs=f;this.esc=g;let d=c.expression(),y=!0,v=!1;if(Array.isArray(d)&&d[0]==="FUNC"){let E=d[1];(E==="UPPER"||E==="LOWER")&&((E==="UPPER"?f.toUpperCase():f.toLowerCase())===f?y=!1:v=!0,c=new i(d[2]))}this.lhs=c,this.pattern=We(f,g),this.caseSensitive=y,this.contradiction=v}caseSensitive;contradiction;pattern;lhs;true(c){return c.getMinterms(this,!0)}false(c){return c.getMinterms(this,!1)}null(c){return this.lhs.null(c)}isBoolean(){return!0}isNullable(c){return this.lhs.isNullable(c)}getNullables(){return this.lhs.getNullables()}expression(){let c=this.lhs.expression();return this.contradiction?this.rhs===this.rhs.toLocaleUpperCase()?c=["FUNC","LOWER",c]:c=["FUNC","UPPER",c]:this.caseSensitive||(this.rhs===this.rhs.toLocaleUpperCase()?c=["FUNC","UPPER",c]:c=["FUNC","LOWER",c]),["LIKE",c,this.rhs,...this.esc?[this.esc]:[]]}}u.Like=a;function l(p){return he(p,c=>{if(!Array.isArray(c))return new u.Exp(c);let f=c[0],g=!0;f==="NOT LIKE"?f="LIKE":f==="IS NOT NULL"?f="IS NULL":f==="<>"?f="=":f===">="?f="<":f==="<="?f=">":g=!1;let d;if(f==="IS NULL")d=new u.IsNull(c[1]);else if(f==="NOT")d=new u.Not(c[1]);else if(f==="OR")d=new u.Or(c.slice(1));else if(f==="AND")d=new u.And(c.slice(1));else if(f==="CASE")d=new u.Case(c.slice(1));else if(f==="LIKE"){let y=c[2]instanceof i?c[2].expression():null,v=c[3]instanceof i?c[3].expression():null;typeof y=="string"&&typeof v=="string"?d=new u.Like(c[1],y,v):typeof y=="string"&&v==null&&(d=new u.Like(c[1],y))}else if(f===">"||f==="<"||f==="="){let y=c[2]instanceof i?c[2].expression():null;["boolean","number","string"].includes(typeof y)&&(d=new u.Compare(c[1],f,y))}if(!d){let y=c.slice(1).map(v=>v.expression());d=new u.Exp([f,...y])}return g&&(d=new u.Not(d)),d})}u.fromExpression=l})(D||(D={}));function bn(e,t){let r=new Map;for(let n of e){let s=t(n),i=r.get(s);i||r.set(s,i=[]),i.push(n)}return r.entries()}var wr=class extends st{constructor(){super()}getMinterms(t,r){let n=this.getVar(t);return r===!0?[[n<<2^3]]:r===!1?[[n<<2^1]]:[[n<<2,n<<2^2]]}getDcSet(t){let r=[],n=new Set([...t.flat()].map(a=>a>>2)),s=[...n].map(a=>this.getClause(a)),i=s.filter(a=>a instanceof D.Compare);for(let[,a]of bn(i,l=>JSON.stringify(l.lhs))){let l=a[0].lhs,p=[...new Set(a.map(m=>m.rhs))].sort((m,c)=>{let f=typeof m,g=typeof c;return f===g?m>c?1:-1:f==="string"?1:g==="string"?-1:+m-+c});for(let[m,c]of p.entries()){let f=this.getVar(new D.Compare(l,"=",c)),g=this.getVar(new D.Compare(l,">",c)),d=this.getVar(new D.Compare(l,"<",c));r.push([f<<2^3,g<<2^3]),r.push([d<<2^3,g<<2^3]),r.push([d<<2^3,f<<2^3]),r.push([d<<2^1,f<<2^1,g<<2^1]);let y=[d,f,g].filter(v=>!n.has(v));y.length===1&&n.add(y[0]);for(let v=0;v<m;v++){let E=this.getVar(new D.Compare(l,"=",p[v])),S=this.getVar(new D.Compare(l,">",p[v])),_=this.getVar(new D.Compare(l,"<",p[v]));r.push([S<<2^1,d<<2^1]),r.push([E<<2^3,d<<2^1]),r.push([_<<2^3,d<<2^1]),r.push([S<<2^1,g<<2^3]),r.push([S<<2^1,f<<2^3]),r.push([E<<2^3,g<<2^3]),r.push([E<<2^3,f<<2^3]),r.push([_<<2^3,g<<2^3]),r.push([_<<2^3,f<<2^3])}}}let o=s.filter(a=>a instanceof D.Like);for(let[,a]of bn(o,l=>JSON.stringify(l.lhs)))for(let l=0;l<a.length;++l){let u=a[l];if(u.contradiction){r.push([this.getVar(u)<<2^3]);continue}for(let p=l+1;p<a.length;++p){let m=a[p];if(m.contradiction)continue;let c=u.pattern,f=m.pattern;(!u.caseSensitive||!m.caseSensitive)&&(c=c.map(g=>g.toLowerCase()),f=f.map(g=>g.toLowerCase())),Er(c,f)?r.push([this.getVar(u)<<2^3,this.getVar(m)<<2^3]):(!u.caseSensitive||m.caseSensitive)&&it(c,f)?(r.push([this.getVar(u)<<2^2,this.getVar(m)<<2^3]),r.push([this.getVar(u)<<2^1,this.getVar(m)<<2^0])):(!m.caseSensitive||u.caseSensitive)&&it(f,c)&&(r.push([this.getVar(u)<<2^3,this.getVar(m)<<2^2]),r.push([this.getVar(u)<<2^0,this.getVar(m)<<2^1]))}}for(let a of n){let l=this.getClause(a),u=[...l.getNullables()].map(p=>this.getVar(p));if(u.length){r.push([...u.map(p=>p<<2^2),a<<2^0,a<<2^2]);for(let p of u)r.push([p<<2^3,a<<2^1]),r.push([p<<2^3,a<<2^3]),n.add(p)}if(l instanceof D.IsNull){let p=l.operand.toString();(p==='["PARAM","DeviceID.ID"]'||p==='["PARAM","_id"]')&&r.push([a<<2^3])}}return r.filter(a=>a.every(l=>n.has(l>>2)))}canRaise(t,r){let n=this.getClause(t>>2);if(n instanceof D.IsNull){for(let s of r){if(s===t||s&1)continue;if(this.getClause(s>>2).isNullable(n))return!1}return!0}return!(t&1)||!r.has(t^3)}canLower(t,r){return t&1||this.getClause(t>>2)instanceof D.IsNull?!0:r.has(t^3)||r.has(t^1)}bias(t,r){return(r&3^3)-(t&3^3)}sanitizeMinterms(t){let r=[];e:for(let n of t){let s=new Map;for(let l of n)s.set(l>>2,(s.get(l>>2)||0)|1<<(l&3));let i=[],o=[];for(let[l,u]of s){if((u&3)===3||(u&12)===12)continue e;let p=this.clauses.get(l);if(!p)throw new Error("Invalid literal");if(p instanceof D.IsNull){if(u===4)i.push(l<<2^2);else if(u===8)i.push(l<<2^3);else throw new Error("Invalid literal");continue}if((u&10)===10)continue e;let m=[...p.getNullables()].map(f=>this.getVar(f)),c=l<<2;u===5?m.length===1?i.push(m[0]<<2^3):o.push(m.map(f=>f<<2^3)):u===1?o.push([...m.map(f=>f<<2^3),c^3]):u===4?o.push([...m.map(f=>f<<2^3),c^1]):u&8?i.push(c^3):u&2&&i.push(c^1)}let a=[i];for(;o.length;){let l=[],u=o.pop();for(let p of u)l.push(...a.map(m=>[...m,p]));a=l}r.push(...a)}return r}toExpression(t){if(!t.length)return!1;let r=[];for(let n of t){if(!n.length)return!0;let s=[];for(let i of n){let o=this.getClause(i>>>2);if(!o)throw new Error("Invalid literal");if(o instanceof D.IsNull){if(!(i&2))throw new Error("Invalid literal")}else if(!(i&1)){let l=[...o.getNullables()].map(u=>this.getVar(u));s.push(this.toExpression([[i^3],...l.map(u=>[u<<2^3])]));continue}let a=o.expression();if(!(i&1)!=!(i&2)&&(a=["NOT",a]),Array.isArray(a)&&a[0]==="NOT"&&Array.isArray(a[1])){let l=a[1];l[0]==="IS NULL"?a=["IS NOT NULL",...l.slice(1)]:l[0]==="LIKE"?a=["NOT LIKE",...l.slice(1)]:l[0]==="="?a=["<>",...l.slice(1)]:l[0]==="<>"?a=["=",...l.slice(1)]:l[0]===">"?a=["<=",...l.slice(1)]:l[0]===">="?a=["<",...l.slice(1)]:l[0]==="<"?a=[">=",...l.slice(1)]:l[0]==="<="?a=[">",...l.slice(1)]:l[0]==="NOT"&&(a=l[1])}s.push(a)}s.length>1?r.push(["AND",...s]):r.push(s[0])}return r.length>1?["OR",...r]:r[0]}};function Sn(){return new wr}function it(e,t){let r=null;for(let n=0,s=0;;++n,++s){for(;n<e.length&&e[n]==="\\%";)r=[n++,s];if(s>=t.length)return n>=e.length;let i=n<e.length?e[n]:null;if(i!==t[s]&&i!=="\\_"){if(!r)return!1;[n,s]=r,++r[1]}}}function Er(e,t){let r=e.indexOf("\\%"),n=t.indexOf("\\%"),s=e.lastIndexOf("\\%"),i=t.lastIndexOf("\\%"),o=e.slice(0,r!==-1?r:e.length),a=t.slice(0,n!==-1?n:t.length),l=e.slice(s!==-1?s+1:0).reverse(),u=t.slice(i!==-1?i+1:0).reverse();for(let p=0;p<Math.min(o.length,a.length);++p)if(o[p]!==a[p]&&o[p]!=="\\_"&&a[p]!=="\\_")return!0;for(let p=0;p<Math.min(l.length,u.length);++p)if(l[p]!==u[p]&&l[p]!=="\\_"&&u[p]!=="\\_")return!0;return e.length===o.length?t.filter(p=>p!=="\\%").length>e.length:t.length===a.length?e.filter(p=>p!=="\\%").length>t.length:!1}function br(e,t){if(!Array.isArray(e))throw new Error("Left-hand operand must be a parameter");if(e[0]!=="PARAM")throw new Error("Left-hand operand must be a parameter");if(typeof e[1]!="string")throw new Error("Left-hand operand must be a parameter");let r=e[1];if(t==="devices"){if(r==="DeviceID.ID")return"_id";if(r==="DeviceID")return"_deviceId";if(r.startsWith("DeviceID."))return"_deviceId._"+r.slice(9);if(r==="Events.Inform")return"_lastInform";if(r==="Events.Registered")return"_registered";if(r==="Events.0_BOOTSTRAP")return"_lastBootstrap";if(r==="Events.1_BOOT")return"_lastBoot";if(!r.endsWith("._value")&&!r.startsWith("Tags."))return`${r}._value`}return r}function _n(e,t){if(t==="devices"){if(e==="_id")return["string"];if(e==="_lastInform")return["date"];if(e==="_registered")return["date"];if(e==="_lastBootstrap")return["date"];if(e==="_lastBoot")return["date"];if(e.startsWith("_deviceId."))return["string"];if(e==="Reboot._value")return["date"];if(e==="FactoryReset._value")return["date"];if(e.endsWith("_timestamp"))return["date"];if(e.startsWith("Downloads.")){if(e.endsWith("Download._value"))return["date"];if(e.endsWith("Time._value"))return["date"];if(e.endsWith("Name._value"))return["string"];if(e.endsWith("Type._value"))return["string"]}if(e.endsWith("_value"))return["bool","number","date","string"]}else if(t==="tasks"){if(e==="_id")return["oid"];if(e==="timestamp")return["date"];if(e==="expiry")return["date"];if(e==="name")return["string"];if(e==="device")return["string"]}else if(t==="faults"){if(e==="_id")return["string"];if(e==="timestamp")return["date"];if(e==="expiry")return["date"];if(e==="code")return["string"];if(e==="retries")return["number"];if(e==="channel")return["string"];if(e==="device")return["string"];if(e==="message")return["string"]}else if(t==="users"){if(e==="_id")return["string"];if(e==="roles")return["string"];if(e==="password")throw new Error("Cannot query restricted parameters");if(e==="salt")throw new Error("Cannot query restricted parameters")}else if(t==="config"){if(e==="_id")return["string"];if(e==="value")return["string"]}else if(t==="files"){if(e==="_id")return["string"];if(e==="metadata.fileType")return["string"];if(e==="metadata.oui")return["string"];if(e==="metadata.productClass")return["string"];if(e==="metadata.version")return["string"]}else if(t==="permissions"){if(e==="_id")return["string"];if(e==="role")return["string"];if(e==="resource")return["devices"];if(e==="access")return["number"];if(e==="filter")return["string"];if(e==="validate")return["string"]}else if(t==="presets"){if(e==="_id")return["string"];if(e==="weight")return["number"];if(e==="channel")return["string"];if(e==="precondition")return["string"];if(e.startsWith("events."))return["bool"]}else if(t==="provisions"){if(e==="_id")return["string"];if(e==="script")return["string"]}else if(t==="virtualParameters"){if(e==="_id")return["string"];if(e==="script")return["string"]}return e==="_id"?["oid","string"]:["bool","number","date","string"]}function di(e,t){var o,a;let r=((a=(o=e.match(/^[0-9a-f]*/))==null?void 0:o[0])!=null?a:"").slice(0,24),n=X("0x0"+r),s=0;e.length>r.length&&(s+=e.charCodeAt(r.length)),r.length<24&&(s-=48),s>0&&t&&n++,n<<=X(4*(24-r.length)),s<0&&!t&&--n;let i=n.toString(16);return i.length>24||i.startsWith("-")?null:i.padStart(24,"0")}function An(e,t){let r=new Map;for(let n of e){let s=t(n),i=r.get(s);i||r.set(s,i=[]),i.push(n)}return r.entries()}var Ge=class{toString(){return JSON.stringify(this.toQuery(!0))}},Ot=class extends Ge{constructor(r,n){super();this.parameter=r;this.value=n}toQuery(r){return r?{[this.parameter]:{$eq:this.value}}:{[this.parameter]:{$ne:this.value}}}},I=class extends Ge{constructor(r,n,s,i){super();this.parameter=r;this.op=n;this.value=s;this.type=i}toQuery(r){let n=this.value;return this.type==="date"&&typeof n=="number"&&(n={$date:new Date(n).toISOString()}),this.type==="oid"&&typeof n=="string"&&(n={$oid:n}),r?{[this.parameter]:{[this.op]:n}}:this.op==="$eq"?{[this.parameter]:{$ne:n}}:{[this.parameter]:{$not:{[this.op]:n}}}}},Oe=class extends Ge{constructor(r,n){super();this.parameter=r;this.type=n}toQuery(r){return r?{[this.parameter]:{$type:this.type}}:{[this.parameter]:{$not:{$type:this.type}}}}},Pt=class extends Ge{constructor(r,n,s,i){super();this.parameter=r;this.caseSensitive=i;this.pattern=We(n,s)}pattern;toQuery(r){let n={"-":"\\-","/":"\\/","\\":"\\/","^":"\\^",$:"\\$","*":"\\*","+":"\\+","?":"\\?",".":"\\.","(":"\\(",")":"\\)","|":"\\|","[":"\\[","]":"\\]","{":"\\{","}":"\\}","\\%":".*","\\_":"."},s=this.pattern.map(l=>{var u;return(u=n[l])!=null?u:l});s[0]=s[0]===".*"?"":"^"+s[0];let i=s.length-1;s[i]=[".*",""].includes(s[i])?"":s[i]+"$";let o=s.join(""),a=this.caseSensitive?"s":"is";return r?{[this.parameter]:{$regularExpression:{options:a,pattern:o}}}:{[this.parameter]:{$not:{$regularExpression:{options:a,pattern:o}}}}}},Sr=class extends st{constructor(r){super();this.collection=r}getMinterms(r,n){let s=r.expression();if(!Array.isArray(s))throw new Error("Invalid query expression");if(n===null){let i=[];for(let o of r.getNullables()){let a=o.operand.expression(),l=br(a,this.collection);if(l.startsWith("Tags.")&&this.collection==="devices"){let p=Ze(l.slice(5)),m=new Ot("_tags",p);i.push([this.getVar(m)<<1]);continue}let u=new I(l,"$eq",null,"");i.push([this.getVar(u)<<1^1])}return i}if([">","<","="].includes(s[0])){let i=br(s[1],this.collection),o=s[2];if(typeof o=="boolean")o=+o;else if(typeof o!="string"&&typeof o!="number")throw new Error("Right-hand operand must be a literal value");if(i.startsWith("Tags.")&&this.collection==="devices"&&s[0]==="="){let p=Ze(i.slice(5)),m=new Ot("_tags",p);if(typeof o=="string"&&(o=2),s[0]==="="){if(o===1!==n)return[]}else if(s[0]===">"){if(n&&o>=1||!n&&o<1)return[]}else if(s[0]==="<"&&(n&&o<=1||!n&&o>1))return[];return[[this.getVar(m)<<1^1]]}let a;s[0]==="="?a="$eq":s[0]===">"?a=n?"$gt":"$lte":s[0]==="<"&&(a=n?"$lt":"$gte");let l=new Set(_n(i,this.collection)),u=[];if(typeof o=="number")l.has("number")&&u.push(new I(i,a,o,"number")),l.has("date")&&u.push(new I(i,a,o,"date")),l.has("bool")&&(o===0||o===1)&&u.push(new I(i,a,!!o,"bool"));else if(typeof o=="string"&&(l.has("string")&&u.push(new I(i,a,o,"string")),l.has("oid"))){let p=di(o,a==="$lt"||a==="$lte");p&&(a!=="$eq"||p===o)&&u.push(new I(i,a,p,"oid"))}return a==="$eq"&&!n?(u.push(new I(i,"$eq",null,"")),[u.map(p=>this.getVar(p)<<1)]):(typeof o=="number"?(l.has("bool")&&(o>1&&(a==="$lt"||a==="$lte")||o<0&&(a==="$gt"||a==="$gte"))&&u.push(new I(i,"$gte",!1,"bool")),(a==="$gt"||a==="$gte")&&(l.has("string")&&u.push(new I(i,"$gte","","string")),l.has("oid")&&u.push(new I(i,"$gte","000000000000000000000000","oid")))):typeof o=="string"&&(a==="$lt"||a==="$lte")&&(l.has("bool")&&u.push(new I(i,"$gte",!1,"bool")),l.has("number")&&(u.push(new I(i,"$gte",0,"number")),u.push(new I(i,"$lt",0,"number"))),l.has("date")&&(u.push(new I(i,"$gte",0,"date")),u.push(new I(i,"$lt",0,"date")))),u.map(p=>[this.getVar(p)<<1^1]))}else if(s[0]==="LIKE"){let i=s[2];if(typeof i!="string")throw new Error("Right-hand operand of 'LIKE' must be a string");let o=s[1],a=!0;if(Array.isArray(o)&&o[0]==="FUNC"&&["UPPER","LOWER"].includes(o[1])){if(o[1]==="UPPER"&&i!==i.toUpperCase())return n?[]:[[]];if(o[1]==="LOWER"&&i!==i.toLowerCase())return n?[]:[[]];a=!1,o=o[2]}let l=br(o,this.collection),u=new Pt(l,i,s[3],a);if(n)return[[this.getVar(u)<<1^1]];let p=new Oe(l,"string");return[[this.getVar(u)<<1,this.getVar(p)<<1^1]]}else throw new Error("Invalid query expression")}getDcSet(r){let n=[],s=new Set(r.flat().map(o=>o>>1)),i=Array.from(s).map(o=>this.getClause(o));for(let[o,a]of An(i,l=>l.parameter)){let l=a.filter(c=>c instanceof I&&c.value!==null);for(let[c,f]of An(l,g=>g.type)){let g=this.getVar(new Oe(o,c)),d=new Set(f.map(v=>v.value)),y=Array.from(d).sort((v,E)=>v>E?1:-1);for(let[v,E]of y.entries()){let S=this.getVar(new I(o,"$eq",E,c)),_=this.getVar(new I(o,"$gt",E,c)),O=this.getVar(new I(o,"$lt",E,c)),pe=this.getVar(new I(o,"$gte",E,c)),W=this.getVar(new I(o,"$lte",E,c));if(c==="bool"?E===!1?n.push([O<<1^1]):E===!0&&n.push([_<<1^1]):c==="string"?E===""&&n.push([O<<1^1]):c==="oid"&&(E<"000000000000000000000000"?n.push([W<<1^1]):E==="000000000000000000000000"?n.push([O<<1^1]):E>"ffffffffffffffffffffffff"?n.push([pe<<1^1]):E==="ffffffffffffffffffffffff"&&n.push([_<<1^1])),n.push([O<<1^1,pe<<1^1]),n.push([_<<1^1,pe<<1^0]),n.push([S<<1^0,O<<1^0,W<<1^1]),n.push([S<<1^1,pe<<1^0]),n.push([S<<1^1,_<<1^1]),v===0)n.push([g<<1^0,pe<<1^1]),n.push([g<<1^0,O<<1^1]);else{let gt=this.getVar(new I(o,"$gt",y[v-1],c)),zs=this.getVar(new I(o,"$lte",y[v-1],c));n.push([gt<<1^0,pe<<1^1]),n.push([gt<<1^0,zs<<1^0,O<<1^1])}v===y.length-1&&n.push([g<<1^1,_<<1^0,W<<1^0])}}let u=a.filter(c=>c instanceof Pt);if(u.length){let c=this.getVar(new Oe(o,"string"));for(let f=0;f<u.length;++f){let g=u[f],d=g.pattern;n.push([this.getVar(g)<<1^1,c<<1^0]);for(let y=f+1;y<u.length;++y){let v=u[y],E=v.pattern;(!g.caseSensitive||!v.caseSensitive)&&(d=d.map(S=>S.toLowerCase()),E=E.map(S=>S.toLowerCase())),Er(d,E)?n.push([this.getVar(g)<<1^1,this.getVar(v)<<1^1]):(!g.caseSensitive||v.caseSensitive)&&it(d,E)?n.push([this.getVar(g)<<1^0,this.getVar(v)<<1^1]):(!v.caseSensitive||g.caseSensitive)&&it(E,d)&&n.push([this.getVar(g)<<1^1,this.getVar(v)<<1^0])}}}let p=this.getVar(new I(o,"$eq",null,"")),m=_n(o,this.collection).map(c=>this.getVar(new Oe(o,c)));n.push([p<<1^0,...m.map(c=>c<<1^0)]);for(let c=0;c<m.length;++c){let f=m[c];n.push([f<<1^1,p<<1^1]);for(let g=c+1;g<m.length;++g){let d=m[g];n.push([f<<1^1,d<<1^1])}}o==="_id"&&n.push([p<<1^1])}return n}canRaise(r,n){if(!(r&1))return!0;let s=this.getClause(r>>1);if(s instanceof I)for(let i of n){if(i===r)continue;let o=this.getClause(i>>1);if(o.parameter===s.parameter&&(!(i&1)||o instanceof Oe))return!1}return!0}toQuery(r){var i,o;let n=[],s=["$oid","$date","$regularExpression"];for(let a of r){let l={};e:for(let u of a){if(!a.length)return{};let p=!!(u&1),c=this.getClause(u>>1).toQuery(p);if(Object.keys(c).length!==1)throw new Error("Invalid query expression");let[f,g]=Object.entries(c)[0],d=[l,...(i=l.$and)!=null?i:[]];for(let y of d){if(!(f in y)){y[f]=g;continue e}let v=g,E=y[f];if(Object.getPrototypeOf(v).constructor!==Object||Object.getPrototypeOf(E).constructor!==Object)continue;let S=Object.keys(v),_=Object.keys(E);if([...S,..._].every(O=>O==="$not")){if(v=v.$not,E=E.$not,Object.getPrototypeOf(v).constructor!==Object||Object.getPrototypeOf(E).constructor!==Object)continue;S=Object.keys(v),_=Object.keys(E)}if(!S.some(O=>_.includes(O))&&!S.some(O=>s.includes(O))&&!_.some(O=>s.includes(O))){Object.assign(E,v);continue e}}(o=l.$and)!=null||(l.$and=[]),l.$and.push({[f]:g})}n.push(l)}return n.length===1?n[0]:{$or:n}}};function _r(e,t){e=nt(e);let r=D.fromExpression(nt(e)),n=new Sr(t),s=r.true(n),i=n.minimize(s);return i.length?In.EJSON.deserialize(n.toQuery(i)):!1}function gi(e){if(!e)return e;let t={};for(let[r,n]of Object.entries(e))r==="DeviceID.ID"?t._id=1:r.startsWith("DeviceID")?(t["_deviceId._SerialNumber"]=n,t["_deviceId._OUI"]=n,t["_deviceId._ProductClass"]=n,t["_deviceId._Manufacturer"]=n):r.startsWith("Tags")?t._tags=n:r.startsWith("Events")?(t._lastInform=n,t._registered=n,t._lastBoot=n,t._lastBootstrap=n):t[r]=n;return t}function hi(e){if(!e)return e;let t={};for(let[r,n]of Object.entries(e))r==="DeviceID.ID"?t._id=n:r.startsWith("DeviceID.")?t[`_deviceId._${r.slice(9)}`]=n:r==="Events.Inform"?t._lastInform=n:r==="Events.Registered"?t._registered=n:r==="Events.1_BOOT"?t._lastBoot=n:r==="Events.0_BOOTSTRAP"?t._lastBootstrap=n:t[`${r}._value`]=n;return t}function Rt(e){let t=+e;return isNaN(t)?""+e:t}function Ir(e){function t(s,i,o,a){for(let[l,u]of Object.entries(s)){if(!i){if(l==="_lastInform")o["Events.Inform"]={value:[Rt(u),"xsd:dateTime"],valueTimestamp:a,writable:!1,writableTimestamp:a,object:!1,objectTimestamp:a};else if(l==="_registered")o["Events.Registered"]={value:[Rt(u),"xsd:dateTime"],valueTimestamp:a,writable:!1,writableTimestamp:a,object:!1,objectTimestamp:a};else if(l==="_lastBoot")o["Events.1_BOOT"]={value:[Rt(u),"xsd:dateTime"],valueTimestamp:a,writable:!1,writableTimestamp:a,object:!1,objectTimestamp:a};else if(l==="_lastBootstrap")o["Events.0_BOOTSTRAP"]={value:[Rt(u),"xsd:dateTime"],valueTimestamp:a,writable:!1,writableTimestamp:a,object:!1,objectTimestamp:a};else if(l==="_id")o["DeviceID.ID"]={value:[u,"xsd:string"],valueTimestamp:a,writable:!1,writableTimestamp:a,object:!1,objectTimestamp:a};else if(l==="_deviceId")o["DeviceID.Manufacturer"]={value:[u._Manufacturer,"xsd:string"],valueTimestamp:a,writable:!1,writableTimestamp:a,object:!1,objectTimestamp:a},o["DeviceID.OUI"]={value:[u._OUI,"xsd:string"],valueTimestamp:a,writable:!1,writableTimestamp:a,object:!1,objectTimestamp:a},o["DeviceID.ProductClass"]={value:[u._ProductClass,"xsd:string"],valueTimestamp:a,writable:!1,writableTimestamp:a,object:!1,objectTimestamp:a},o["DeviceID.SerialNumber"]={value:[u._SerialNumber,"xsd:string"],valueTimestamp:a,writable:!1,writableTimestamp:a,object:!1,objectTimestamp:a};else if(l==="_tags"){o.Tags={writable:!1,writableTimestamp:a,object:!0,objectTimestamp:a};for(let f of u)o[`Tags.${Be(f)}`]={value:[!0,"xsd:boolean"],valueTimestamp:a,writable:!0,writableTimestamp:a,object:!1,objectTimestamp:a}}}if(l.startsWith("_"))continue;let p=a;i?+s._timestamp>a&&(p=+s._timestamp):p=+(s._timestamp||1);let m={};u._value!=null?(m.value=[u._value instanceof Date?+u._value:u._value,u._type],m.valueTimestamp=+(u._timestamp||p),m.object=!1,m.objectTimestamp=p):u._object!=null&&(m.object=u._object,m.objectTimestamp=p),u._writable!=null&&(m.writable=u._writable,m.writableTimestamp=p),u._notification!=null&&(m.notification=u._notification,m.notificationTimestamp=+u._attributesTimestamp||1),u._accessList!=null&&(m.accessList=u._accessList,m.accessListTimestamp=+u._attributesTimestamp||1);let c=i?`${i}.${l}`:l;o[c]=m,(m.object||u.object==null)&&t(u,c,o,p)}}let r={},n=new Date(e._lastInform||1).getTime();return t(e,"",r,n),r}function vi(e){let t=Object.assign({},e);return t.timestamp&&(t.timestamp=+t.timestamp),t.expiry&&(t.expiry=+t.expiry),t}function yi(e){let t=Object.assign({},e);return t._id=""+t._id,t.timestamp&&(t.timestamp=+t.timestamp),t.expiry&&(t.expir