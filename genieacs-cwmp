#!/usr/bin/env node
"use strict";var Ns=Object.create;var ir=Object.defineProperty;var Ls=Object.getOwnPropertyDescriptor;var $s=Object.getOwnPropertyNames;var Ms=Object.getPrototypeOf,Fs=Object.prototype.hasOwnProperty;var js=(e,t)=>{for(var r in t)ir(e,r,{get:t[r],enumerable:!0})},Us=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of $s(t))!Fs.call(e,s)&&s!==r&&ir(e,s,{get:()=>t[s],enumerable:!(n=Ls(t,s))||n.enumerable});return e};var V=(e,t,r)=>(r=e!=null?Ns(Ms(e)):{},Us(t||!e||!e.__esModule?ir(r,"default",{value:e,enumerable:!0}):r,e));var Ue=require("path"),xe=require("fs"),G=(0,Ue.resolve)(__dirname,"..");for(;!(0,xe.existsSync)(`${G}/package.json`);){let e=(0,Ue.resolve)(G,"..");if(e===G){G=process.cwd();break}G=e}var se,cr,lr,ur,fr,gt,Cr={EXT_DIR:{type:"path",default:(0,Ue.resolve)(G,"config/ext")},MONGODB_CONNECTION_URL:{type:"string",default:"mongodb://127.0.0.1/genieacs"},CWMP_WORKER_PROCESSES:{type:"int",default:0},CWMP_PORT:{type:"int",default:7547},CWMP_INTERFACE:{type:"string",default:"::"},CWMP_SSL_CERT:{type:"string",default:""},CWMP_SSL_KEY:{type:"string",default:""},CWMP_LOG_FILE:{type:"path",default:""},CWMP_ACCESS_LOG_FILE:{type:"path",default:""},NBI_WORKER_PROCESSES:{type:"int",default:0},NBI_PORT:{type:"int",default:7557},NBI_INTERFACE:{type:"string",default:"::"},NBI_SSL_CERT:{type:"string",default:""},NBI_SSL_KEY:{type:"string",default:""},NBI_LOG_FILE:{type:"path",default:""},NBI_ACCESS_LOG_FILE:{type:"path",default:""},FS_WORKER_PROCESSES:{type:"int",default:0},FS_PORT:{type:"int",default:7567},FS_INTERFACE:{type:"string",default:"::"},FS_SSL_CERT:{type:"string",default:""},FS_SSL_KEY:{type:"string",default:""},FS_URL_PREFIX:{type:"string",default:""},FS_LOG_FILE:{type:"path",default:""},FS_ACCESS_LOG_FILE:{type:"path",default:""},UI_WORKER_PROCESSES:{type:"int",default:0},UI_PORT:{type:"int",default:3e3},UI_INTERFACE:{type:"string",default:"::"},UI_SSL_CERT:{type:"string",default:""},UI_SSL_KEY:{type:"string",default:""},UI_LOG_FILE:{type:"path",default:""},UI_ACCESS_LOG_FILE:{type:"path",default:""},UI_JWT_SECRET:{type:"string",default:""},UDP_CONNECTION_REQUEST_PORT:{type:"int",default:0},FORWARDED_HEADER:{type:"string",default:""},DOWNLOAD_TIMEOUT:{type:"int",default:3600},EXT_TIMEOUT:{type:"int",default:3e3},MAX_CACHE_TTL:{type:"int",default:86400},DEBUG_FILE:{type:"path",default:""},DEBUG_FORMAT:{type:"string",default:"yaml"},DEBUG:{type:"bool",default:!1},RETRY_DELAY:{type:"int",default:300},SESSION_TIMEOUT:{type:"int",default:30},CONNECTION_REQUEST_TIMEOUT:{type:"int",default:2e3},GPN_NEXT_LEVEL:{type:"int",default:0},GPV_BATCH_SIZE:{type:"int",default:32},MAX_DEPTH:{type:"int",default:16},COOKIES_PATH:{type:"string"},LOG_FORMAT:{type:"string",default:"simple"},ACCESS_LOG_FORMAT:{type:"string",default:""},MAX_CONCURRENT_REQUESTS:{type:"int",default:20},DATETIME_MILLISECONDS:{type:"bool",default:!0},BOOLEAN_LITERAL:{type:"bool",default:!0},CONNECTION_REQUEST_ALLOW_BASIC_AUTH:{type:"bool",default:!1},MAX_COMMIT_ITERATIONS:{type:"int",default:32},DEVICE_ONLINE_THRESHOLD:{type:"int",default:4e3},XMPP_JID:{type:"string",default:""},XMPP_PASSWORD:{type:"string",default:""}},ne={};function j(e,t,r=!1){if(ne[e]!=null)return!0;(e==="CONFIG_DIR"||e==="config-dir")&&(se=se||(0,Ue.resolve)(G,t)),(e==="CWMP_SSL"||e==="cwmp-ssl")&&(cr=cr||String(t).toLowerCase().trim()),(e==="NBI_SSL"||e==="nbi-ssl")&&(lr=lr||String(t).toLowerCase().trim()),(e==="FS_SSL"||e==="fs-ssl")&&(ur=ur||String(t).toLowerCase().trim()),(e==="UI_SSL"||e==="ui-ssl")&&(fr=fr||String(t).toLowerCase().trim()),(e==="FS_HOSTNAME"||e==="fs-hostname")&&(gt=gt||String(t).trim()),(e==="PRESETS_CACHE_DURATION"||e==="presets-cache-duration")&&j("MAX_CACHE_TTL",t),(e==="GET_PARAMETER_NAMES_DEPTH_THRESHOLD"||e==="get-parameter-names-depth-threshold")&&j("GPN_NEXT_LEVEL",t),(e==="TASK_PARAMETERS_BATCH_SIZE"||e==="task-parameters-batch-size")&&j("GPV_BATCH_SIZE",t),(e==="FS_IP"||e==="fs-ip")&&j("FS_HOSTNAME",t);function n(a,i){switch(i){case"int":return Number(a);case"bool":return["true","1"].includes(String(a).trim().toLowerCase());case"string":return String(a);case"path":return a?(0,Ue.resolve)(a):"";default:return null}}let s=null;for(let[a,i]of Object.entries(Cr)){let o=a;if(r&&(o=o.toLowerCase().replace(/_/g,"-")),e===o?(s=n(t,i.type),o=a):e.startsWith(`${o}-`)&&(s=n(t,i.type),o=`${a}-${e.slice(a.length+1)}`),s!=null)return ne[o]=s,process.env[`GENIEACS_${o}`]=s,!0}return!1}var or=process.argv.slice(2);for(;or.length;){let e=or.shift();if(e[0]==="-"){let t=or.shift();j(e.slice(2),t,!0)}}for(let[e,t]of Object.entries(process.env))e.startsWith("GENIEACS_")&&j(e.slice(9),t);var Jr=se?`${se}/config.json`:`${G}/config/config.json`;if((0,xe.existsSync)(Jr)){let e=JSON.parse((0,xe.readFileSync)(Jr).toString());for(let[t,r]of Object.entries(e))j(t,r)||(process.env[`GENIEACS_${t}`]=`${r}`)}se&&j("EXT_DIR",`${se}/ext`);if(["true","1"].includes(cr)){let e=se||`${G}/config`;j("CWMP_SSL_CERT",`${e}/cwmp.crt`),j("CWMP_SSL_KEY",`${e}/cwmp.key`)}if(["true","1"].includes(lr)){let e=se||`${G}/config`;j("NBI_SSL_CERT",`${e}/cwmp.crt`),j("NBI_SSL_KEY",`${e}/cwmp.key`)}if(["true","1"].includes(ur)){let e=se||`${G}/config`;j("FS_SSL_CERT",`${e}/cwmp.crt`),j("FS_SSL_KEY",`${e}/cwmp.key`)}if(["true","1"].includes(fr)){let e=se||`${G}/config`;j("UI_SSL_CERT",`${e}/cwmp.crt`),j("UI_SSL_KEY",`${e}/cwmp.key`)}if(gt){let e=ne.FS_PORT||7567,t=!!ne.FS_SSL_CERT;j("FS_URL_PREFIX",(t?"https":"http")+`://${gt}:${e}/`)}for(let[e,t]of Object.entries(Cr))t.default!=null&&j(e,t.default);function I(e,t){if(!t)return ne[e];e=`${e}-${t}`;let r=ne[e];if(r!=null)return r;let n=e.lastIndexOf("-");return r=ne[e.slice(0,n)],r!=null||(n=e.lastIndexOf("-",n-1),r=ne[e.slice(0,n)],r!=null)||(n=e.lastIndexOf("-",n-1),r=ne[e.slice(0,n)],r!=null)||(n=e.lastIndexOf("-",n-1),n>0&&(r=ne[e.slice(0,n)],r!=null))?r:null}var F=V(require("fs")),_e=V(require("os"));var et=require("ipaddr.js");var mr=require("fs"),Zr=V(require("http")),Qr=V(require("https")),pr=V(require("path"));var W,ht,Yr=!1;function Vs(e,t){if(!W)return void t();setTimeout(()=>{if(!t)return;W.removeListener("request",ht),W.setTimeout(1);let r=t;t=null,setTimeout(r,1e3)},e).unref(),W.close(()=>{if(!t)return;let r=t;t=null,setTimeout(r,50)})}var xr=new WeakMap;function Gs(e){return e.split(":").map(t=>(t=t.trim(),t.startsWith("-----BEGIN ")?Buffer.from(t):(0,mr.readFileSync)(pr.resolve(G,t))))}function qs(e){return e.split(":").map(t=>(t=t.trim(),t.startsWith("-----BEGIN ")?Buffer.from(t):(0,mr.readFileSync)(pr.resolve(G,t))))}function en(e,t){if(ht=(r,n)=>{Yr&&n.setHeader("Connection","close"),t(r,n).catch(s=>{try{n.socket.unref(),n.headersSent&&(n.writeHead(500,{Connection:"close"}),n.end(`${s.name}: ${s.message}`))}catch{}throw s})},e.ssl){let r={key:Gs(e.ssl.key),cert:qs(e.ssl.cert)};W=Qr.createServer(r,ht),e.onConnection&&W.on("secureConnection",e.onConnection)}else W=Zr.createServer(ht),e.onConnection&&W.on("connection",e.onConnection);W.on("connection",r=>{xr.set(r,{localAddress:r.localAddress,localPort:r.localPort,remoteAddress:r.remoteAddress,remotePort:r.remotePort,remoteFamily:r.remoteFamily})}),e.onClientError&&W.on("clientError",(r,n)=>{r.code!=="ECONNRESET"&&n.writable&&n.end(`HTTP/1.1 400 Bad Request\r
Connection: close\r
\r
`),e.onClientError(r,n)}),W.timeout=e.timeout||0,e.keepAliveTimeout!=null&&(W.keepAliveTimeout=e.keepAliveTimeout),e.requestTimeout!=null&&(W.requestTimeout=e.requestTimeout),W.listen({port:e.port,host:e.host})}function vt(e=!0){return Yr=e,new Promise((t,r)=>{setTimeout(()=>{r(new Error("Could not close server in a timely manner"))},3e4).unref(),Vs(2e4,t)})}function Re(e){var t;return xr.get((t=e._parent)!=null?t:e)}var Bs=""+I("FORWARDED_HEADER"),tn=new WeakMap,dr=[];for(let e of Bs.split(",").map(t=>t.trim()))try{dr.push((0,et.parseCIDR)(e))}catch{try{let r=(0,et.parse)(e);dr.push([r,r.toByteArray().length*8])}catch{}}function Hs(e){e=e.toLowerCase();let t={},r=0,n=-1,s;for(let a=0;a<e.length;++a){let i=e.charCodeAt(a);if(i===61)r>=0&&(s=e.slice(r,a).trim(),r=-1,n=a+1);else if(i===59)n>=0&&(t[s]=e.slice(n,a).trim()),n=-1,r=a+1;else{if(i===44)return n>=0&&(t[s]=e.slice(n,a).trim()),t;if(i===34&&n>=0){let o=a;if(!e.slice(n,o).trim())for(a=a+1;a<e.length;++a){let c=e.charCodeAt(a);if(c===92&&++a,c===34){t[s]=JSON.parse(e.slice(o,a+1).trim()),n=-1,r=a+1;break}}}}}return n>=0&&(t[s]=e.slice(n).trim()),t}function x(e){let t=tn.get(e);if(!t){let r=e.socket,n=Re(r);t={localAddress:n.localAddress,localPort:n.localPort,remoteAddress:n.remoteAddress,remotePort:n.remotePort,host:e.headers.host,encrypted:!!e.socket.encrypted};let s=e.headers.forwarded;if(s){let a=(0,et.parse)(n.remoteAddress);if(dr.some(i=>a.kind()===i[0].kind()&&a.match(i))){let i=Hs(s);if(i.proto==="https"?(t.encrypted=!0,t.localPort=443):i.proto==="http"&&(t.encrypted=!1,t.localPort=80),i.host){t.host=i.host;let[,o]=i.host.split(":",2);t.localPort=+o||t.localPort}if(i.for)if(i.for.startsWith("[")){let o=i.for.lastIndexOf("]");o>=0&&(t.remoteAddress=i.for.slice(1,o),t.remotePort=parseInt(i.for.slice(o+2))||t.remotePort)}else{let o=i.for.lastIndexOf(":");o>=0?(t.remoteAddress=i.for.slice(0,o),t.remotePort=parseInt(i.for.slice(o+1))||t.remotePort):t.remoteAddress=i.for}if(i.by)if(i.by.startsWith("[")){let o=i.by.lastIndexOf("]");o>=0&&(t.localAddress=i.by.slice(1,o),t.localPort=parseInt(i.by.slice(o+2))||t.localPort)}else{let o=i.by.lastIndexOf(":");o>=0?(t.localAddress=i.by.slice(0,o),t.localPort=parseInt(i.by.slice(o+1))||t.localPort):t.localAddress=i.by}}}tn.set(e,t)}return t}var ge=6e4,rn=I("LOG_FORMAT"),zs=I("ACCESS_LOG_FORMAT")||rn,Ve={},gr=!1,hr=!1,Te,Pe,le=F.createWriteStream(null,{fd:process.stderr.fd}),Ge=F.fstatSync(le.fd),ue=F.createWriteStream(null,{fd:process.stdout.fd}),qe=F.fstatSync(ue.fd);function bt(){let e=1;Te&&(++e,F.stat(Te,(t,r)=>{if(t&&!t.message.startsWith("ENOENT:"))throw t;r&&r.dev===Ge.dev&&r.ino===Ge.ino||(le.end(),le=F.createWriteStream(null,{fd:F.openSync(Te,"a")}),Ge=F.fstatSync(le.fd)),--e===0&&setTimeout(bt,ge-Date.now()%ge).unref()})),Pe&&(++e,F.stat(Pe,(t,r)=>{if(t&&!t.message.startsWith("ENOENT:"))throw t;r&&r.dev===qe.dev&&r.ino===qe.ino||(ue.end(),ue=F.createWriteStream(null,{fd:F.openSync(Pe,"a")}),qe=F.fstatSync(ue.fd)),--e===0&&setTimeout(bt,ge-Date.now()%ge).unref()})),--e===0&&setTimeout(bt,ge-Date.now()%ge).unref()}function nn(e,t){Ve.hostname=_e.hostname(),Ve.pid=process.pid,Ve.name=`genieacs-${e}`,Ve.version=t,Te=I(`${e.toUpperCase()}_LOG_FILE`),Pe=I(`${e.toUpperCase()}_ACCESS_LOG_FILE`),Te&&(le=F.createWriteStream(null,{fd:F.openSync(Te,"a")}),Ge=F.fstatSync(le.fd)),Pe&&(ue=F.createWriteStream(null,{fd:F.openSync(Pe,"a")}),qe=F.fstatSync(ue.fd));let r=process.env.JOURNAL_STREAM;if(r){let[n,s]=r.split(":").map(parseInt);gr=Ge.dev===n&&Ge.ino===s,hr=qe.dev===n&&qe.ino===s}(Te||Pe)&&setTimeout(bt,ge-Date.now()%ge).unref()}function sn(){ue.end(),le.end()}function vr(e){if(e.sessionContext){let t=e.sessionContext;e.deviceId=t.deviceId,e.remoteAddress=x(t.httpRequest).remoteAddress,delete e.sessionContext}if(e.exception){let t=e.exception;e.exceptionName=t.name,e.exceptionMessage=t.message,e.exceptionStack=t.stack,delete e.exception}if(e.task&&(e.taskId=e.task._id,delete e.task),e.rpc){let t=e.rpc;t.acsRequest?(e.acsRequestId=t.id,e.acsRequestName=t.acsRequest.name,t.acsRequest.commandKey&&(e.acsRequestCommandKey=t.acsRequest.commandKey)):t.cpeRequest?(e.cpeRequestId=t.id,t.cpeRequest.name==="Inform"?(e.informEvent=t.cpeRequest.event.join(","),e.informRetryCount=t.cpeRequest.retryCount):(e.cpeRequestName=t.cpeRequest.name,t.cpeRequest.commandKey&&(e.cpeRequestCommandKey=t.cpeRequest.commandKey))):t.cpeFault&&(e.acsRequestId=t.id,e.cpeFaultCode=t.cpeFault.detail.faultCode,e.cpeFaultString=t.cpeFault.detail.faultString),delete e.rpc}if(e.fault){let t=e.fault;e.faultCode=t.code,e.faultMessage=t.message,delete e.fault}e.context&&(e.remoteAddress=x(e.context.req).remoteAddress,e.context.state.user&&(e.user=e.context.state.user.username),delete e.context);for(let[t,r]of Object.entries(e))r==null&&delete e[t];return e}function an(e,t){if(t){let r="";return e.severity==="info"?r="<6>":e.severity==="warn"?r="<4>":e.severity==="error"&&(r="<3>"),`${r}${JSON.stringify(vr(e))}${_e.EOL}`}return`${JSON.stringify(vr(e))}${_e.EOL}`}function on(e,t){let r={user:!0,remoteAddress:!0,severity:!0,timestamp:!0,message:!0,deviceId:!!e.sessionContext};vr(e);let n="";e.remoteAddress&&(e.deviceId&&r.deviceId?n=`${e.remoteAddress} ${e.deviceId}: `:e.user?n=`${e.user}@${e.remoteAddress}: `:n=`${e.remoteAddress}: `);let s=Object.keys(e),a="",i=[];for(let o of s)r[o]||i.push(`${o}=${JSON.stringify(e[o])}`);if(i.length&&(a=`; ${i.join(" ")}`),t){let o="";return e.severity==="info"?o="<6>":e.severity==="warn"?o="<4>":e.severity==="error"&&(o="<3>"),`${o}${n}${e.message}${a}${_e.EOL}`}return`${e.timestamp} [${e.severity.toUpperCase()}] ${n}${e.message}${a}${_e.EOL}`}function br(e){e.timestamp=new Date().toISOString(),rn==="json"?(e=Object.assign({},Ve,e),le.write(an(e,gr))):le.write(on(e,gr))}function he(e){e.severity="info",br(e)}function We(e){e.severity="warn",br(e)}function tt(e){e.severity="error",br(e)}function Sr(e){e.timestamp=new Date().toISOString(),zs==="json"?(Object.assign(e,Ve),ue.write(an(e,hr))):ue.write(on(e,hr))}function fe(e){e.severity="info",Sr(e)}function B(e){e.severity="warn",Sr(e)}function K(e){e.severity="error",Sr(e)}var ee=V(require("cluster")),cn=require("os");var St=0,wr=[];function yr(){let e=ee.default.fork();return e.on("error",t=>{if(t.code!=="EPIPE")throw t;setTimeout(()=>{if(!e.isDead())throw t},50)}),e}function Er(e,t,r){let n={message:"Worker died",pid:e.process.pid,exitCode:null,signal:null};t!=null&&(n.exitCode=t),r!=null&&(n.signal=r),tt(n);let s=Date.now();wr.push(s);let a=0,i=0,o=0;if(wr=wr.filter(c=>{if(c>s-6e4)++a;else if(c>s-12e4)++i;else if(c>s-18e4)++o;else return!1;return!0}),a>5&&i>5&&o>5){process.exitCode=1,ee.default.removeListener("exit",Er);for(let c in ee.default.workers)ee.default.workers[c].kill();tt({message:"Too many crashes, exiting",pid:process.pid});return}if(St=Math.max(s,St+2e3),St===s){yr();return}setTimeout(()=>{process.exitCode||yr()},St-s)}function ln(e,t,r){ee.default.on("listening",(n,s)=>{(s.addressType===4||s.addressType===6)&&s.address===r&&s.port===t&&he({message:"Worker listening",pid:n.process.pid,address:s.address,port:s.port})}),ee.default.on("exit",Er),e||(e=Math.max(2,(0,cn.cpus)().length));for(let n=0;n<e;++n)yr()}function Ar(){ee.default.removeListener("exit",Er);for(let e in ee.default.workers)ee.default.workers[e].kill()}var Rr=ee.default.worker;var Ae=V(require("zlib")),zr=V(require("crypto")),Br=require("stream"),Kr=require("util"),rr=require("iconv-lite");var De=require("crypto");function Xs(e){let t={},r=e.split(","),n;for(;(n=r.shift())!=null;){let s=n.split("=",1)[0];if(s.length===n.length){if(!n.trim())continue;throw new Error("Unable to parse auth header")}let a=n.slice(s.length+1);if(!/^\s*"/.test(a))a=a.trim();else{for(;!/[^\\]"\s*$/.test(a);){let i=r.shift();if(i==null)throw new Error("Unable to parse auth header");a+=","+i}try{a=JSON.parse(a)}catch{throw new Error("Unable to parse auth header")}}t[s.trim()]=a}return t}function un(e){e=e.trim();let t=e.split(" ",1)[0],r={method:t};if(t==="Basic"){let s=/^([^:]*):(.*)$/.exec(Buffer.from(e.slice(t.length+1),"base64").toString());if(!s)throw new Error("Unable to parse auth header");r.username=s[1],r.password=s[2]}else t==="Digest"&&Object.assign(r,Xs(e.slice(t.length+1)));return r}function fn(e,t,r,n,s,a,i,o,c,l){let u=(0,De.createHash)("md5");u.update(e).update(":").update(t).update(":").update(r);let f=u.digest("hex"),m=(0,De.createHash)("md5");if(m.update(s).update(":").update(a),i==="auth-int"){let b=(0,De.createHash)("md5").update(o||"").digest("hex");m.update(":").update(b)}let p=m.digest("hex"),d=(0,De.createHash)("md5");return d.update(f).update(":").update(n),i&&d.update(":").update(l).update(":").update(c).update(":").update(i),d.update(":").update(p),d.digest("hex")}function mn(e){function t(r){return r.replace(/[^A-Za-z0-9_]/g,n=>{let s=Buffer.from(n,"utf8"),a="";for(let i of s)a+="%"+i.toString(16).toUpperCase();return a})}return e.ProductClass?t(e.OUI)+"-"+t(e.ProductClass)+"-"+t(e.SerialNumber):t(e.OUI)+"-"+t(e.SerialNumber)}function Tr(e){return e.replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&")}function me(e){return encodeURIComponent(e).replace(/[!~*'().]/g,t=>"%"+t.charCodeAt(0).toString(16).toUpperCase()).replace(/0x(?=[0-9A-Z]{2})/g,"0%78").replace(/%/g,"0x")}function wt(e){return decodeURIComponent(e.replace(/0x(?=[0-9A-Z]{2})/g,"%"))}function pn(e,t,r){return new Promise((n,s)=>{let a=setTimeout(()=>{s(new Error(`Event ${t} timed out after ${r} ms`))},r);e.once(t,(...i)=>{clearTimeout(a),n(i)})})}function yt(e,t=!0){return new Promise(r=>{let n=setTimeout(r,e);t||n.unref()})}function dn(e){let t=["utf16le","utf8","latin1","ascii"];for(let r of t){let n=e.toString(r,0,150);if(n.startsWith("<?xml")){n=n.slice(0,n.indexOf("?>"));try{return Et(n.slice(5))}catch{}}}return null}function Et(e){let t=[],r=e.length,n=0,s="",a="",i="",o=0,c=0;for(let u=0;u<r;++u){let f=e.charCodeAt(u);switch(f){case 39:case 34:if(n===f){if(n=0,s){let m=e.slice(o+1,u),p={name:s,namespace:a,localName:i,value:m};t.push(p),s="",o=u+1}}else n=f,o=u;continue;case 58:if(n)continue;o>=c&&(c=u);continue;case 61:if(n)continue;if(s)throw new Error(`Unexpected character at ${u}`);s=e.slice(o,u).trim(),c>o?(a=e.slice(o,c).trim(),i=e.slice(c+1,u).trim()):(a="",i=s)}}if(s)throw new Error(`Attribute must have value at ${o}`);let l=e.slice(o);if(l.trim())throw new Error(`Unexpected string at ${r-l.length}`);return t}function ve(e){return e.replace(/&[0-9a-z#]+;/gi,t=>{switch(t){case"&quot;":return'"';case"&amp;":return"&";case"&apos;":return"'";case"&lt;":return"<";case"&gt;":return">";default:if(t.startsWith("&#x")){let r=t.slice(3,-1).toLowerCase(),n=parseInt(r,16);if(r.endsWith(n.toString(16)))return String.fromCharCode(n)}else if(t.startsWith("&#")){let r=t.slice(2,-1),n=parseInt(r);if(r.endsWith(n.toString()))return String.fromCharCode(n)}}return t})}function X(e){let t={"&":"&amp;",'"':"&quot;","'":"&apos;","<":"&lt;",">":"&gt;"};return e.replace(/[&"'<>]/g,r=>t[r])}function gn(e){let t=e.length,r=0,n=0,s=0,a=0,i={name:"root",namespace:"",localName:"root",attrs:"",text:"",bodyIndex:0,children:[]},o=[i];for(let c=0;c<t;++c)switch(e.charCodeAt(c)){case 39:switch(r&255){case 2:r=s,n=a,s=0;continue;case 1:s=r,a=n,r=2,n=c;continue}continue;case 34:switch(r&255){case 3:r=s,n=a,s=0;continue;case 1:s=r,a=n,r=3,n=c;continue}continue;case 60:r&255||(s=r,a=n,r=1,n=c);continue;case 58:(r&255)===1&&!(r>>8&255)&&(r^=(c-n&255)<<8);continue;case 32:case 9:case 13:case 10:(r&255)===1&&!(r>>16&255)&&(r^=(c-n&255)<<16);continue;case 62:if((r&255)===1){let l=e.charCodeAt(n+1),u=r>>16&255,f,m,p,d,b,w,T;switch(l){case 47:if(p=o.pop(),f=u===0?e.slice(n+2,c):e.slice(n+2,n+u),p.name!==f)throw new Error(`Unmatched closing tag at ${c}`);p.children.length||(p.text=e.slice(p.bodyIndex,n)),r=s,n=a,s=0;continue;case 33:if(e.startsWith("![CDATA[",n+1)){if(e.endsWith("]]",c))throw new Error(`CDATA nodes are not supported at ${c}`)}else e.startsWith("!--",n+1)&&e.endsWith("--",c)&&(r=s,n=a,s=0);continue;case 63:e.charCodeAt(c-1)===63&&(r=s,n=a,s=0);continue;default:b=+(e.charCodeAt(c-1)===47),d=o[o.length-1],m=r>>8&255,f=u===0?e.slice(n+1,c-b):e.slice(n+1,n+u),m&&(!u||m<u)?(w=f.slice(m),T=f.slice(0,m-1)):(w=f,T=""),p={name:f,namespace:T,localName:w,attrs:u?e.slice(n+u+1,c-b):"",text:"",bodyIndex:c+1,children:[]},d.children.push(p),b||o.push(p),r=s,n=a,s=0;continue}}continue}if(r)throw new Error(`Unclosed token at ${n}`);if(o.length>1){let c=o[o.length-1];throw new Error(`Unclosed XML element at ${c.bodyIndex}`)}return i.children.length||(i.text=e),i}var Ie=new Map,At=new Map,hn=new WeakMap;function vn(e){if(e===null)return"null";if(e===void 0)return"undefined";let t=typeof e;if(t==="number"||t==="boolean"||t==="string")return`${t}:${e}`;if(t!=="function"&&t!=="object")throw new Error(`Cannot memoize ${t} arguments`);let r=hn.get(e);if(!r){let n=Math.trunc(Math.random()*Number.MAX_SAFE_INTEGER);r=`${t}:${n.toString(36)}`,hn.set(e,r)}return r}function Rt(e){let t=vn(e);return(...r)=>{let n=JSON.stringify(r.map(vn))+t;if(Ie.has(n))return Ie.get(n);let s;return At.has(n)?Ie.set(n,s=At.get(n)):(Ie.set(n,s=e(...r)),s instanceof Promise&&s.catch(()=>{Ie.delete(n),At.delete(n)})),s}}var bn=setInterval(()=>{At=Ie,Ie=new Map},12e4);bn.unref&&bn.unref();var rt="1.2.13+20240726110109";var te=new Map,nt=new Map,Pr=32,Zs=92,Qs=58,Sn=34,Ys=91,wn=93,xs=42,yn=44,ea=46;function be(e,t){return t>=e.length?0:e.charCodeAt(t)}function ta(e){return e>=97&&e<=122||e>=65&&e<=90||e>=48&&e<=57||e===95||e===45}var g=class e{static parseAliasValue(t,r){let n=r;for(;be(t,n)===Pr;)++n;if(be(t,n)===Sn){for(let s=n+1;s<t.length;++s)if(t.charCodeAt(s)===Sn&&t.charCodeAt(s-1)!==Zs)try{++s;let a=JSON.parse(t.slice(n,s));return{index:s,value:a}}catch{return{index:r,value:null}}return{index:r,value:null}}for(;n<t.length;++n){let s=t.charCodeAt(n);if(s===wn||s===yn)break}return{index:n,value:t.slice(r,n).trim()}}static parseAliasPath(t,r){let n=r;for(;be(t,n)===Pr;)++n;let{index:s,segments:a}=e.parsePath(t,n);if(s===n)return{index:r,path:null};for(n=s;be(t,n)===Pr;)++n;return be(t,n)!==Qs?{index:r,path:null}:{index:n+1,path:new e(a)}}static parseAlias(t,r){let n=[],s=r;for(;;){let a,i;if({index:s,path:a}=e.parseAliasPath(t,s),!a||({index:s,value:i}=e.parseAliasValue(t,s),i==null)||(n.push([a,i]),r=s,be(t,r)!==yn))break;++s}return n.sort((a,i)=>a[0].toString()>i[0].toString()?1:a[0].toString()<i[0].toString()?-1:a[1]>i[1]?1:a[1]<i[1]?-1:0),Object.freeze(n),{index:r,alias:n}}static parsePath(t,r){let n=[],s=r,a=-1;for(let i=r;i<=t.length;++i){let o=be(t,i);if(o===Ys&&i===s){let{index:c,alias:l}=e.parseAlias(t,i+1);if(be(t,c)!==wn)break;n.push(l),r=i=c+1,s=i+1}else if(o===xs&&i===s)a=i+1;else if(!ta(o)||i===a){if(i===s)break;let c=t.slice(s,i);if(n.push(c),r=i,o!==ea)break;s=i+1}}return Object.freeze(n),{index:r,segments:n}}constructor(t){let r=0,n=0,s=t.map((o,c)=>Array.isArray(o)?(r|=1<<c,`[${o.map(u=>`${u[0].toString()}:${JSON.stringify(u[1])}`).join(",")}]`):(o==="*"&&(n|=1<<c),o)),a=0,i=s.map((o,c)=>(a+=o.length)+c);this.segments=t,this.wildcard=n,this.alias=r,this._string=s.join("."),this._stringIndex=i}static parse(t){let r=te.get(t);if(!r){if(r=nt.get(t),!r){let{index:n,segments:s}=e.parsePath(t,0);if(n<t.length)throw new Error("Invalid parameter path");r=new e(s),r.toString()!==t&&te.set(r.toString(),r)}te.set(t,r)}return r}get length(){return this.segments.length}toString(){return this._string}slice(t=0,r=this.segments.length){t<0&&(t=Math.max(0,this.segments.length+t)),r<0&&(r=Math.max(0,this.segments.length+r));let n;if(t>=r)n="";else{let a=t>0?this._stringIndex[t-1]+1:0,i=r<=this.segments.length?this._stringIndex[r-1]:this._string.length;n=this._string.slice(a,i)}let s=te.get(n);if(!s){if(s=nt.get(n),!s){let a=this.segments.slice(t,r);Object.freeze(a),s=new e(a)}te.set(n,s)}return s}concat(t){if(t._string){if(!this._string)return t}else return this;let r=`${this._string}.${t._string}`,n=te.get(r);if(!n){if(n=nt.get(r),!n){let s=this.segments.concat(t.segments);Object.freeze(s),n=new e(s)}te.set(r,n)}return n}stripAlias(){if(!this.alias)return this;let t=this.segments.map(s=>Array.isArray(s)?"*":s),r=t.join("."),n=te.get(r);return n||(n=nt.get(r),n||(Object.freeze(t),n=new e(t)),te.set(r,n)),n}},En=setInterval(()=>{nt=te,te=new Map},12e4);En.unref&&En.unref();var An=`GenieACS/${rt}`,st={"1.0":{"soap-enc":"http://schemas.xmlsoap.org/soap/encoding/","soap-env":"http://schemas.xmlsoap.org/soap/envelope/",xsd:"http://www.w3.org/2001/XMLSchema",xsi:"http://www.w3.org/2001/XMLSchema-instance",cwmp:"urn:dslforum-org:cwmp-1-0"},"1.1":{"soap-enc":"http://schemas.xmlsoap.org/soap/encoding/","soap-env":"http://schemas.xmlsoap.org/soap/envelope/",xsd:"http://www.w3.org/2001/XMLSchema",xsi:"http://www.w3.org/2001/XMLSchema-instance",cwmp:"urn:dslforum-org:cwmp-1-1"},"1.2":{"soap-enc":"http://schemas.xmlsoap.org/soap/encoding/","soap-env":"http://schemas.xmlsoap.org/soap/envelope/",xsd:"http://www.w3.org/2001/XMLSchema",xsi:"http://www.w3.org/2001/XMLSchema-instance",cwmp:"urn:dslforum-org:cwmp-1-2"},"1.3":{"soap-enc":"http://schemas.xmlsoap.org/soap/encoding/","soap-env":"http://schemas.xmlsoap.org/soap/envelope/",xsd:"http://www.w3.org/2001/XMLSchema",xsi:"http://www.w3.org/2001/XMLSchema-instance",cwmp:"urn:dslforum-org:cwmp-1-2"},"1.4":{"soap-enc":"http://schemas.xmlsoap.org/soap/encoding/","soap-env":"http://schemas.xmlsoap.org/soap/envelope/",xsd:"http://www.w3.org/2001/XMLSchema",xsi:"http://www.w3.org/2001/XMLSchema-instance",cwmp:"urn:dslforum-org:cwmp-1-3"}},L,ra=Rt(Et);function Rn(e){return e==="true"||e==="1"?!0:e==="false"||e==="0"?!1:null}function na(e){return e.children.filter(t=>t.localName==="EventStruct").map(t=>t.children.find(r=>r.localName==="EventCode").text)}function sa(e){return e.children.map(t=>{if(t.localName!=="ParameterInfoStruct")return null;let r,n;for(let a of t.children)switch(a.localName){case"Name":r=a.text;break;case"Writable":n=a.text;break}let s=Rn(n);s==null&&(L.push({message:"Missing or invalid XML node",element:"Writable",parameter:r}),s=!1);try{return r&&!r.endsWith(".")?[g.parse(r),!1,s]:[g.parse(r.slice(0,-1)),!0,s]}catch{return L.push({message:"Missing or invalid XML node",element:"Name",parameter:r}),null}}).filter(t=>t!=null)}var aa=Rt(e=>{let t=Et(e);for(let r of t)if(r.localName==="type")return r.value;return null});function Tn(e){return e.children.map(t=>{if(t.localName!=="ParameterValueStruct")return null;let r,n;for(let o of t.children)switch(o.localName){case"Name":n=o.text;break;case"Value":r=o;break}let s=aa(r.attrs);s||(L.push({message:"Missing or invalid XML node",attribute:"type",parameter:n}),s="xsd:string");let a=ve(r.text),i=a;s==="xsd:boolean"?(i=Rn(a),i==null&&(L.push({message:"Missing or invalid XML node",element:"Value",parameter:n}),i=a)):s==="xsd:int"||s==="xsd:unsignedInt"?(i=parseInt(a),isNaN(i)&&(L.push({message:"Missing or invalid XML node",element:"Value",parameter:n}),i=a)):s==="xsd:dateTime"&&(i=Date.parse(a),isNaN(i)&&(L.push({message:"Missing or invalid XML node",element:"Value",parameter:n}),i=a));try{return[g.parse(n),i,s]}catch{return L.push({message:"Missing or invalid XML node",element:"Name",parameter:n}),null}}).filter(t=>t!=null)}function ia(e){return e.children.map(t=>{if(t.localName!=="ParameterAttributeStruct")return null;let r,n,s;for(let o of t.children)switch(o.localName){case"Name":s=o.text;break;case"Notification":r=o;break;case"AccessList":n=o;break}let a=parseInt(r.text);isNaN(a)&&(L.push({message:"Missing or invalid XML node",element:"Notification",parameter:s}),a=0);let i=n.children.filter(o=>o.localName==="string").map(o=>ve(o.text));try{return[g.parse(s),a,i]}catch{return L.push({message:"Missing or invalid XML node",element:"Name",parameter:s}),null}}).filter(t=>t!=null)}function oa(e){return`<cwmp:GetParameterNames><ParameterPath>${e.parameterPath}</ParameterPath><NextLevel>${+e.nextLevel}</NextLevel></cwmp:GetParameterNames>`}function ca(e){return{name:"GetParameterNamesResponse",parameterList:sa(e.children.find(t=>t.localName==="ParameterList"))}}function la(e){return`<cwmp:GetParameterValues><ParameterNames soap-enc:arrayType="xsd:string[${e.parameterNames.length}]">${e.parameterNames.map(t=>`<string>${t}</string>`).join("")}</ParameterNames></cwmp:GetParameterValues>`}function ua(e){return{name:"GetParameterValuesResponse",parameterList:Tn(e.children.find(t=>t.localName==="ParameterList"))}}function fa(e){return`<cwmp:GetParameterAttributes><ParameterNames soap-enc:arrayType="xsd:string[${e.parameterNames.length}]">${e.parameterNames.map(t=>`<string>${t}</string>`).join("")}</ParameterNames></cwmp:GetParameterAttributes>`}function ma(e){return{name:"GetParameterAttributesResponse",parameterList:ia(e.children.find(t=>t.localName==="ParameterList"))}}function pa(e){let t=e.parameterList.map(r=>{let n=r[1];return r[2]==="xsd:dateTime"&&typeof n=="number"&&(n=new Date(n).toISOString(),e.DATETIME_MILLISECONDS===!1&&(n=n.replace(".000",""))),r[2]==="xsd:boolean"&&typeof n=="boolean"&&e.BOOLEAN_LITERAL===!1&&(n=+n),`<ParameterValueStruct><Name>${r[0]}</Name><Value xsi:type="${r[2]}">${X(""+n)}</Value></ParameterValueStruct>`});return`<cwmp:SetParameterValues><ParameterList soap-enc:arrayType="cwmp:ParameterValueStruct[${e.parameterList.length}]">${t.join("")}</ParameterList><ParameterKey>${e.parameterKey||""}</ParameterKey></cwmp:SetParameterValues>`}function da(e){let t;for(let r of e.children)switch(r.localName){case"Status":t=parseInt(r.text);break}return t>=0||(L.push({message:"Missing or invalid XML node",element:"Status"}),t=0),{name:"SetParameterValuesResponse",status:t}}function ga(e){let t=e.parameterList.map(r=>`<SetParameterAttributesStruct><Name>${r[0]}</Name><NotificationChange>${r[1]==null?"false":"true"}</NotificationChange><Notification>${r[1]==null?"":r[1]}</Notification><AccessListChange>${r[2]==null?"false":"true"}</AccessListChange><AccessList soap-enc:arrayType="xsd:string[${(r[2]||[]).length}]">${r[2]==null?"":r[2].map(n=>`<string>${X(n)}</string>`).join("")}</AccessList></SetParameterAttributesStruct>`);return`<cwmp:SetParameterAttributes><ParameterList soap-enc:arrayType="cwmp:SetParameterAttributesStruct[${e.parameterList.length}]">${t.join("")}</ParameterList></cwmp:SetParameterAttributes>`}function ha(){return{name:"SetParameterAttributesResponse"}}function va(e){return`<cwmp:AddObject><ObjectName>${e.objectName}</ObjectName><ParameterKey>${e.parameterKey||""}</ParameterKey></cwmp:AddObject>`}function ba(e){let t,r;for(let n of e.children)switch(n.localName){case"InstanceNumber":t=n.text;break;case"Status":r=parseInt(n.text);break}if(!/^[0-9]+$/.test(t))throw new Error("Missing or invalid instance number");return r>=0||(L.push({message:"Missing or invalid XML node",element:"Status"}),r=0),{name:"AddObjectResponse",instanceNumber:t,status:r}}function Sa(e){return`<cwmp:DeleteObject><ObjectName>${e.objectName}</ObjectName><ParameterKey>${e.parameterKey||""}</ParameterKey></cwmp:DeleteObject>`}function wa(e){let t;for(let r of e.children)switch(r.localName){case"Status":t=parseInt(r.text);break}return t>=0||(L.push({message:"Missing or invalid XML node",element:"Status"}),t=0),{name:"DeleteObjectResponse",status:t}}function ya(e){return`<cwmp:Reboot><CommandKey>${e.commandKey||""}</CommandKey></cwmp:Reboot>`}function Ea(){return{name:"RebootResponse"}}function Aa(){return"<cwmp:FactoryReset></cwmp:FactoryReset>"}function Ra(){return{name:"FactoryResetResponse"}}function Ta(e){return`<cwmp:Download><CommandKey>${e.commandKey||""}</CommandKey><FileType>${e.fileType}</FileType><URL>${e.url}</URL><Username>${X(e.username||"")}</Username><Password>${X(e.password||"")}</Password><FileSize>${e.fileSize||"0"}</FileSize><TargetFileName>${X(e.targetFileName||"")}</TargetFileName><DelaySeconds>${e.delaySeconds||"0"}</DelaySeconds><SuccessURL>${X(e.successUrl||"")}</SuccessURL><FailureURL>${X(e.failureUrl||"")}</FailureURL></cwmp:Download>`}function Pa(e){let t,r,n;for(let s of e.children)switch(s.localName){case"Status":t=parseInt(s.text);break;case"StartTime":r=Date.parse(s.text);break;case"CompleteTime":n=Date.parse(s.text);break}return t>=0||(L.push({message:"Missing or invalid XML node",element:"Status"}),t=0),(r==null||isNaN(r))&&(L.push({message:"Missing or invalid XML node",element:"StartTime"}),r=Date.parse("0001-01-01T00:00:00Z")),(n==null||isNaN(n))&&(L.push({message:"Missing or invalid XML node",element:"CompleteTime"}),n=Date.parse("0001-01-01T00:00:00Z")),{name:"DownloadResponse",status:t,startTime:r,completeTime:n}}function _a(e){let t,r,n,s={Manufacturer:null,OUI:null,ProductClass:null,SerialNumber:null};for(let a of e.children)switch(a.localName){case"ParameterList":n=Tn(a);break;case"DeviceId":for(let i of a.children){let o=i.localName;o in s&&(s[o]=ve(i.text))}break;case"Event":r=na(a);break;case"RetryCount":t=parseInt(a.text);break}if(!s||!s.SerialNumber||!s.OUI)throw new Error("Missing or invalid DeviceId element");return n||(L.push({message:"Missing or invalid XML node",element:"ParameterList"}),n=[]),r||(L.push({message:"Missing or invalid XML node",element:"Event"}),r=[]),(t==null||isNaN(t))&&(L.push({message:"Missing or invalid XML node",element:"RetryCount"}),t=0),{name:"Inform",parameterList:n,deviceId:s,event:r,retryCount:t}}function Oa(){return"<cwmp:InformResponse><MaxEnvelopes>1</MaxEnvelopes></cwmp:InformResponse>"}function Da(){return{name:"GetRPCMethods"}}function Ia(e){return`<cwmp:GetRPCMethodsResponse><MethodList soap-enc:arrayType="xsd:string[${e.methodList.length}]">${e.methodList.map(t=>`<string>${t}</string>`).join("")}</MethodList></cwmp:GetRPCMethodsResponse>`}function ka(e){let t,r,n,s;for(let a of e.children)switch(a.localName){case"CommandKey":t=a.text;break;case"FaultStruct":r=Pn(a);break;case"StartTime":n=Date.parse(a.text);break;case"CompleteTime":s=Date.parse(a.text);break}return t==null&&(L.push({message:"Missing or invalid XML node",element:"CommandKey"}),t=""),r||(L.push({message:"Missing or invalid XML node",element:"FaultStruct"}),r={faultCode:"0",faultString:""}),(n==null||isNaN(n))&&(L.push({message:"Missing or invalid XML node",element:"StartTime"}),n=Date.parse("0001-01-01T00:00:00Z")),(s==null||isNaN(s))&&(L.push({message:"Missing or invalid XML node",element:"CompleteTime"}),s=Date.parse("0001-01-01T00:00:00Z")),{name:"TransferComplete",commandKey:t,faultStruct:r,startTime:n,completeTime:s}}function Na(){return"<cwmp:TransferCompleteResponse></cwmp:TransferCompleteResponse>"}function La(e){return{name:"RequestDownload",fileType:e.children.find(t=>t.localName==="FileType").text}}function $a(){return"<cwmp:RequestDownloadResponse></cwmp:RequestDownloadResponse>"}function Ma(e){return`<soap-env:Body:Fault><faultcode>${X(e.faultCode)}</faultcode><faultstring>${X(e.faultString)}</faultstring><detail><cwmp:Fault><FaultCode>${X(e.detail.faultCode)}</FaultCode><FaultString>${X(e.detail.faultString)}</FaultString></cwmp:Fault></detail></soap-env:Body:Fault>`}function Pn(e){let t,r,n,s,a,i;for(let o of e.children)switch(o.localName){case"FaultCode":t=o.text;break;case"FaultString":r=ve(o.text);break;case"SetParameterValuesFault":n=n||[],s=a=i=null;for(let c of o.children)switch(c.localName){case"ParameterName":s=c.text;break;case"FaultCode":a=c.text;break;case"FaultString":i=ve(c.text);break}n.push({parameterName:s,faultCode:a,faultString:i})}return t==null&&(L.push({message:"Missing or invalid XML node",element:"FaultCode"}),t=""),r==null&&(L.push({message:"Missing or invalid XML node",element:"FaultString"}),r=""),{faultCode:t,faultString:r,setParameterValuesFault:n}}function Fa(e){let t,r,n;for(let s of e.children)switch(s.localName){case"faultcode":t=s.text;break;case"faultstring":r=ve(s.text);break;case"detail":n=Pn(s.children.find(a=>a.localName==="Fault"));break}if(!n)throw new Error("Missing detail element");return t==null&&(L.push({message:"Missing or invalid XML node",element:"faultcode"}),t="Client"),r==null&&(L.push({message:"Missing or invalid XML node",element:"faultstring"}),r="CWMP fault"),{faultCode:t,faultString:r,detail:n}}function _n(e,t){L=t;let r={id:null,cwmpVersion:null,sessionTimeout:null,cpeRequest:null,cpeFault:null,cpeResponse:null,unknownMethod:null};if(!e.length)return r;let n=gn(e);if(!n.children.length)return r;let s=n.children[0],a,i;for(let c of s.children)switch(c.localName){case"Header":a=c;break;case"Body":i=c;break}if(a)for(let c of a.children)switch(c.localName){case"ID":r.id=ve(c.text);break;case"sessionTimeout":r.sessionTimeout=parseInt(c.text);break}let o=i.children[0];if(o.localName==="Inform"){let c,l;for(let u of[o,i,s])if(c=c||u.namespace,u.attrs){let f=ra(u.attrs),m=c?f.find(p=>p.namespace==="xmlns"&&p.localName===c):f.find(p=>p.name==="xmlns");m&&(l=m.value)}switch(l){case"urn:dslforum-org:cwmp-1-0":r.cwmpVersion="1.0";break;case"urn:dslforum-org:cwmp-1-1":r.cwmpVersion="1.1";break;case"urn:dslforum-org:cwmp-1-2":r.sessionTimeout?r.cwmpVersion="1.3":r.cwmpVersion="1.2";break;case"urn:dslforum-org:cwmp-1-3":r.cwmpVersion="1.4";break;default:throw new Error("Unrecognized CWMP version")}}switch(o.localName){case"Inform":r.cpeRequest=_a(o);break;case"GetRPCMethods":r.cpeRequest=Da();break;case"TransferComplete":r.cpeRequest=ka(o);break;case"RequestDownload":r.cpeRequest=La(o);break;case"GetParameterNamesResponse":r.cpeResponse=ca(o);break;case"GetParameterValuesResponse":r.cpeResponse=ua(o);break;case"GetParameterAttributesResponse":r.cpeResponse=ma(o);break;case"SetParameterValuesResponse":r.cpeResponse=da(o);break;case"SetParameterAttributesResponse":r.cpeResponse=ha();break;case"AddObjectResponse":r.cpeResponse=ba(o);break;case"DeleteObjectResponse":r.cpeResponse=wa(o);break;case"RebootResponse":r.cpeResponse=Ea();break;case"FactoryResetResponse":r.cpeResponse=Ra();break;case"DownloadResponse":r.cpeResponse=Pa(o);break;case"Fault":r.cpeFault=Fa(o);break;default:r.unknownMethod=o.localName;break}return r}var ja={"1.0":Object.entries(st["1.0"]).map(([e,t])=>`xmlns:${e}="${t}"`).join(" "),"1.1":Object.entries(st["1.1"]).map(([e,t])=>`xmlns:${e}="${t}"`).join(" "),"1.2":Object.entries(st["1.2"]).map(([e,t])=>`xmlns:${e}="${t}"`).join(" "),"1.3":Object.entries(st["1.3"]).map(([e,t])=>`xmlns:${e}="${t}"`).join(" "),"1.4":Object.entries(st["1.4"]).map(([e,t])=>`xmlns:${e}="${t}"`).join(" ")};function ke(e){let t={Server:An,SOAPServer:An};if(!e)return{code:204,headers:t,data:""};let r;if(e.acsResponse)switch(e.acsResponse.name){case"InformResponse":r=Oa();break;case"GetRPCMethodsResponse":r=Ia(e.acsResponse);break;case"TransferCompleteResponse":r=Na();break;case"RequestDownloadResponse":r=$a();break;default:throw new Error(`Unknown method response type ${e.acsResponse.name}`)}else if(e.acsRequest)switch(e.acsRequest.name){case"GetParameterNames":r=oa(e.acsRequest);break;case"GetParameterValues":r=la(e.acsRequest);break;case"GetParameterAttributes":r=fa(e.acsRequest);break;case"SetParameterValues":r=pa(e.acsRequest);break;case"SetParameterAttributes":r=ga(e.acsRequest);break;case"AddObject":r=va(e.acsRequest);break;case"DeleteObject":r=Sa(e.acsRequest);break;case"Reboot":r=ya(e.acsRequest);break;case"FactoryReset":r=Aa();break;case"Download":r=Ta(e.acsRequest);break;default:throw new Error(`Unknown method request ${e.acsRequest.name}`)}else e.acsFault&&(r=Ma(e.acsFault));return t["Content-Type"]='text/xml; charset="utf-8"',{code:200,headers:t,data:`<?xml version="1.0" encoding="UTF-8"?>
<soap-env:Envelope ${ja[e.cwmpVersion]}><soap-env:Header><cwmp:ID soap-env:mustUnderstand="1">${e.id}</cwmp:ID></soap-env:Header><soap-env:Body>${r}</soap-env:Body></soap-env:Envelope>`}}var at={object:2,writable:4,value:8,notification:16,accessList:32};function Va(e){return e=""+e,e==="true"||e==="TRUE"||e==="True"||e==="1"?!0:e==="false"||e==="FALSE"||e==="False"||e==="0"?!1:null}function Se(e){if(e[0]!=null)switch(e[1]){case"xsd:boolean":if(typeof e[0]!="boolean"){let t=Va(e[0]);t==null?e[0]=""+e[0]:e[0]=t}break;case"xsd:int":case"xsd:unsignedInt":if(typeof e[0]!="number"){let t=parseInt(e[0]);isNaN(t)?e[0]=""+e[0]:e[0]=t}break;case"xsd:dateTime":if(typeof e[0]!="number"){let t=+e[0];isNaN(t)?(t=Date.parse(e[0]),isNaN(t)?e[0]=""+e[0]:e[0]=t):e[0]=t}break;default:e[0]=""+e[0];break}return e}function _r(e,t,r=null){let n=e.stripAlias(),s=[{path:n,pathGet:t,pathSet:null,attrGet:r,attrSet:null,defer:!0}];if(e.alias){for(let[a,i]of e.segments.entries())if(Array.isArray(i)){let o=n.slice(0,a+1);for(let[c]of i)s=s.concat(_r(o.concat(c),t,{value:t}))}}return s}function H(e,t,r){let n=[];if(t.alias){let s=t.stripAlias();for(let a of e.paths.find(s,!1,!0))e.attributes.has(a,r)&&n.push(a);for(let a=t.length-1;a>=0;--a)if(t.alias&1<<a)for(let[i,o]of t.segments[a]){let c=s.slice(0,a+1).concat(i),l=H(e,c,r),u=[];for(let f of l){let m=e.attributes.get(f,r);if(m&&m.value&&m.value[1]&&Se([o,m.value[1][1]])[0]===m.value[1][0])for(let p=0;p<n.length;++p){let d,b=n[p];if(b){for(d=a;d>=0&&b.segments[d]===f.segments[d];--d);d<0&&(u.push(b),n[p]=null)}}}n=u}}else for(let s of e.paths.find(t,!1,!0))e.attributes.has(s,r)&&n.push(s);return n.sort((s,a)=>{for(let i=0;i<s.length;++i){let o=s.segments[i],c=a.segments[i];if(o!==c){let l=parseInt(o),u=parseInt(c);return l===+o&&u===+c?l-u:o<c?-1:1}}return 0}),n}function ae(e,t,r,n,s=0){let a={};r=r||0;let i=r;n!=null&&n.object&&(n.object>i&&(i=n.object),n.object<=n.value||(n.value=n.object));for(let o of e.paths.find(t,!0,!0,i?99:t.length)){let c=e.trackers.get(o);for(let u in c)a[u]|=c[u];let l=e.timestamps.get(o);if(l!==void 0){if(r>l||i>l&&o.length>t.length)e.timestamps.delete(o),e.attributes.delete(o),s|=1;else if(n&&o.length===t.length){let u=e.attributes.get(o);if(u){let f;for(let m in n)m in u&&n[m]>u[m][0]&&(s|=at[m],f||(f=Object.assign({},u),e.attributes.set(o,f)),delete f[m])}}}}for(let o in a)a[o]&s&&e.changes.add(o)}function Ga(e,t){let r=typeof e;return e==null||r==="number"||r==="boolean"||r==="string"||r==="symbol"?e===t:JSON.stringify(e)===JSON.stringify(t)}function _(e,t,r,n,s){t=e.paths.add(t);let a=e.timestamps.get(t),i;t.wildcard?n=void 0:a&&(i=e.attributes.get(t));let o=0;if(n){n.value&&n.value[1]&&n.value[0]>=(n.object?n.object[0]:0)&&(n.object=[n.value[0],0]),n.object&&n.object[1]&&n.object[0]>=(n.value?n.value[0]:0)&&(n.value=[n.object[0],null]);let c=Object.assign({},i,n);if(i)for(let l in n)r=Math.max(r,n[l][0]),l in i?n[l][0]<=i[l][0]?c[l]=i[l]:Ga(n[l][1],i[l][1])||(o|=at[l]):o|=at[l];else o|=1;e.attributes.set(t,c),r<=a||(e.timestamps.set(t,r),t.length>1&&(s=_(e,t.slice(0,t.length-1),r,{object:[r,1]},s)))}else if(!(r<=a)){if(e.timestamps.set(t,r),i)e.attributes.delete(t),o|=1;else if(t.wildcard)for(let c of e.paths.find(t,!1,!0,t.length))r>e.timestamps.get(c)&&(s=s||[],s.push([c,r]))}if(o)if(o&1)s=s||[],s.push([t,r,null,o]);else if(o&at.object)s=s||[],s.push([t,0,{object:n.object[0]},o]);else for(let c of e.paths.find(t,!0,!1,t.length)){let l=e.trackers.get(c);for(let u in l)l[u]&o&&e.changes.add(u)}return s}function Or(e,t,r,n){t=e.paths.add(t);let s=1;if(n)for(let i of n)s|=at[i];let a=e.trackers.get(t);a||(a={},e.trackers.set(t,a)),a[r]|=s}function On(e,t){if(Array.isArray(t)){for(let r of e.trackers.values())for(let n of t)delete r[n];for(let r of t)e.changes.delete(r)}else{for(let r of e.trackers.values())delete r[t];e.changes.delete(t)}}var Nt=V(require("vm")),Mr=V(require("seedrandom"));var Dn=require("child_process"),In=V(require("crypto")),Ir=V(require("readline"));var qa=+I("EXT_TIMEOUT"),re={},it=new Map;function Tt(e){return new Promise(t=>{let r=e[0],n=In.randomBytes(8).toString("hex");if(it.set(n,t),!re[r]){let s=(0,Dn.spawn)(G+"/bin/genieacs-ext",[r],{stdio:["ignore","pipe","pipe","ipc"]});re[r]=s,s.on("error",o=>{re[r]===s&&(it.delete(n)&&t({fault:{code:o.name,message:o.message},value:null}),kn(re[r]),delete re[r])}),s.on("disconnect",()=>{re[r]===s&&delete re[r]}),s.on("message",o=>{let c=it.get(o[0]);c&&(it.delete(o[0]),setTimeout(()=>{c({fault:o[1],value:o[2]})}))}),Ir.default.createInterface(s.stdout).on("line",o=>{he({message:`Ext ${r}(${s.pid}): ${o}`})}),Ir.default.createInterface(s.stderr).on("line",o=>{We({message:`Ext ${r}(${s.pid}): ${o}`})})}return setTimeout(()=>{it.delete(n)&&t({fault:{code:"timeout",message:"Extension timed out"},value:null})},qa),re[r].connected?re[r].send([n,e.slice(1)]):!1})}function kn(e){return new Promise(t=>{let r=Date.now()+5e3;e.kill();let n=setInterval(()=>{e.connected?Date.now()>r&&(e.kill("SIGKILL"),clearInterval(n),t()):(clearInterval(n),t())},100)})}async function kr(){await Promise.all(Object.entries(re).map(([e,t])=>(delete re[e],kn(t))))}var Nn=V(require("crypto")),Pt=V(require("@breejs/later"));function Wa(e){let t=Nn.createHash("md5").update(e).digest();return t.readUInt32LE(0)^t.readUInt32LE(4)^t.readUInt32LE(8)^t.readUInt32LE(12)}function ot(e,t){return(Wa(e)>>>0)%t}function _t(e,t,r=0){return Math.trunc((e+r)/t)*t-r}function Ot(e){let t=e.trim().split(/\s+/);return t.length===5&&t.unshift("*"),Pt.schedule(Pt.parse.cron(t.join(" "),!0))}function Dt(e,t,r=0){let n=[0,0],s=t.prev(1,new Date(e+r));s&&(n[0]=s.setMilliseconds(0)-r);let a=t.next(1,new Date(e+r+1e3));return a&&(n[1]=a.setMilliseconds(0)-r),n}var $n=Symbol(),Mn=Symbol(),kt=void 0,z=Nt.createContext(void 0,{microtaskMode:"afterEvaluate"}),A,Ln=new WeakMap;function Ba(e,t,r){let n=Ln.get(e);n||(n=new Map,Ln.set(e,n));let s=n.get(t);return s==null&&n.set(t,s=new Promise((a,i)=>{Tt(r).then(({fault:o,value:c})=>{n.delete(t),o||(e.extensionsCache[t]=c),a(o)}).catch(i)})),s}var Lr=class{constructor(...t){return t.length?new Date(...t):new Date(A.sessionContext.timestamp)}static now(t,r){let n=A.sessionContext.timestamp;if(typeof t=="number"){r==null&&(r=t);let s=0;r&&(s=ot(A.sessionContext.deviceId,r)),n=_t(n,t,s)}else if(typeof t=="string"){let s=0;r&&(s=ot(A.sessionContext.deviceId,r));let a=Ot(t);n=Dt(n,a,s)[0]}else if(t)throw new Error("Invalid Date.now() argument");return n}static parse(t){return Date.parse(t)}static UTC(...t){return Date.UTC(...t)}};function Fn(){return A.rng||(A.rng=(0,Mr.default)(A.sessionContext.deviceId)),A.rng()}Fn.seed=function(e){A.rng=(0,Mr.default)(e)};var $r=class e{constructor(t,r,n,s){for(let a of r)Object.defineProperty(this,a,{get:function(){if(A.uncommitted&&ct(),A.revision!==s&&(s=A.revision,n=H(A.sessionContext.deviceData,t,A.revision)),!n.length)return kt;let i=A.sessionContext.deviceData.attributes.get(n[0],A.revision)[a];return i?i[1]:kt}});Object.defineProperty(this,"path",{get:function(){return A.uncommitted&&ct(),A.revision!==s&&(s=A.revision,n=H(A.sessionContext.deviceData,t,A.revision)),n.length?n[0].toString():kt}}),Object.defineProperty(this,"size",{get:function(){return A.uncommitted&&ct(),A.revision!==s&&(s=A.revision,n=H(A.sessionContext.deviceData,t,A.revision)),n.length?n.length:kt}}),this[Symbol.iterator]=function*(){A.uncommitted&&ct(),A.revision!==s&&(s=A.revision,n=H(A.sessionContext.deviceData,t,A.revision));for(let a of n)yield new e(a,r,[a],A.revision)}}};function Ha(e,t,r){A.uncommitted=!0,t||(t={}),r||(r={});let n=g.parse(e),s={path:n,pathGet:1,pathSet:null,attrGet:null,attrSet:null,defer:!0},a=new Set;for(let[i,o]of Object.entries(r))i==="path"?s.pathSet=o:(a.add(i),s.attrGet||(s.attrGet={}),s.attrSet||(s.attrSet={}),s.attrGet[i]=1,i==="value"&&!Array.isArray(r.value)?s.attrSet.value=[r.value]:s.attrSet[i]=r[i]);for(let[i,o]of Object.entries(t))o>=1&&(i==="path"?s.pathGet=o:(a.add(i),s.attrGet||(s.attrGet={}),s.attrGet[i]=o));return A.declarations.push(s),new $r(n,a)}function za(e,t,r){A.uncommitted=!0,A.revision===A.maxRevision&&A.clear.push([g.parse(e),t,r])}function ct(){if(++A.revision,A.uncommitted=!1,A.revision===A.maxRevision+1){for(let e of A.declarations)e.defer=!1;throw $n}else if(A.revision>A.maxRevision+1)throw new Error("Declare function should not be called from within a try/catch block")}function Ka(...e){++A.extCounter;let t=e.map(String),r=`${A.revision}: ${JSON.stringify(t)}`;if(r in A.sessionContext.extensionsCache)return A.sessionContext.extensionsCache[r];throw A.extensions[r]=t,Mn}function Xa(e,t){if(A.revision===A.maxRevision&&A.extCounter>=0){let r=Object.assign({},t,{sessionContext:A.sessionContext,message:`Script: ${e}`});delete r.hostname,delete r.pid,delete r.name,delete r.version,delete r.deviceId,delete r.remoteAddress,fe(r)}}Object.defineProperty(z,"Date",{value:Lr});Object.defineProperty(z,"declare",{value:Ha});Object.defineProperty(z,"clear",{value:za});Object.defineProperty(z,"commit",{value:ct});Object.defineProperty(z,"ext",{value:Ka});Object.defineProperty(z,"log",{value:Xa});z.random=Fn;Nt.runInContext("Math.random = random;",z);delete z.random;function Ja(e){if(!e)return null;if(!e.name)return{code:"script",message:`${e}`};let t={code:`script.${e.name}`,message:e.message,detail:{name:e.name,message:e.message}};if(e.stack){t.detail.stack=e.stack;let r=t.detail.stack.match(/\s+at\s[^\s]+\s+at\s[^\s]+\s\(vm\.js.+\)/);r&&(t.detail.stack=t.detail.stack.slice(0,r.index))}return t}async function Lt(e,t,r,n,s,a=0){A={sessionContext:r,revision:n,maxRevision:s,uncommitted:!1,declarations:[],extensions:{},clear:[],rng:null,extCounter:a};for(let u of Object.keys(z))delete z[u];Object.assign(z,t);let i,o;try{i=e.runInContext(z,{displayErrors:!1,timeout:50}),o=0}catch(u){if(u===$n)o=1;else if(u===Mn)o=2;else return{fault:Ja(u),clear:null,declare:null,done:!1,returnValue:null}}let c=A,l;return await Promise.all(Object.entries(c.extensions).map(async([u,f])=>{l=await Ba(c.sessionContext,u,f)||l})),l?{fault:l,clear:null,declare:null,done:!1,returnValue:null}:o===2?Lt(e,t,r,n,s,a-c.extCounter):{fault:null,clear:c.clear,declare:c.declarations,done:o===0,returnValue:i}}var Vr=V(require("vm")),ie=V(require("crypto"));var Mt=require("mongodb");var Za,P={devices:null,presets:null,objects:null,provisions:null,virtualParameters:null,faults:null,tasks:null,files:null,operations:null,permissions:null,users:null,config:null,cache:null,locks:null},$t;async function jn(){$t=Mt.MongoClient.connect(""+I("MONGODB_CONNECTION_URL"));let t=(await $t).db();P.tasks=t.collection("tasks"),P.devices=t.collection("devices"),P.presets=t.collection("presets"),P.objects=t.collection("objects"),P.files=t.collection("fs.files"),P.provisions=t.collection("provisions"),P.virtualParameters=t.collection("virtualParameters"),P.faults=t.collection("faults"),P.operations=t.collection("operations"),P.permissions=t.collection("permissions"),P.users=t.collection("users"),P.config=t.collection("config"),P.cache=t.collection("cache"),P.locks=t.collection("locks"),Za=new Mt.GridFSBucket(t),await Promise.all([P.tasks.createIndex({device:1,timestamp:1}),P.cache.createIndex({expire:1},{expireAfterSeconds:0}),P.locks.createIndex({expire:1},{expireAfterSeconds:0})])}async function Un(){$t!=null&&await(await $t).close()}function Vn(e){if(e[""])return{"":e[""]};let t=Object.keys(e).sort();if(t.length<=1)return e;for(let r=1;r<t.length;++r){let n=t[r-1],s=t[r];s.startsWith(n)&&(s.charAt(n.length)==="."||s.charAt(n.length-1)===".")&&(delete e[s],t.splice(r--,1))}return e}function Gn(e){function t(r){let n=[];for(let[s,a]of Object.entries(r))if(s[0]==="$")if(s==="$and"){let i=["AND"];for(let o of Object.values(a))i.push(t(o));n.push(i)}else if(s==="$or"){let i=["OR"];for(let o of Object.values(a))i.push(t(o));n.push(i)}else throw new Error(`Operator ${s} not supported`);else if(s==="_tags")if(typeof a=="object"){if(Array.isArray(a))throw new Error("Invalid type");let i=[];for(let[o,c]of Object.entries(a))if(o==="$ne"){if(typeof a.$ne!="string")throw new Error("Only string values are allowed for _tags");i.push(["IS NULL",["PARAM",`Tags.${me(c)}`]])}else if(o==="$eq"){if(typeof a.$eq!="string")throw new Error("Only string values are allowed for _tags");i.push(["IS NOT NULL",["PARAM",`Tags.${me(c)}`]])}else throw new Error("Invalid tag query");i.length===1?n.push(i[0]):i.length>1&&n.push(["AND",...i])}else n.push(["IS NOT NULL",["PARAM",`Tags.${me(a)}`]]);else if(s.startsWith("Tags.")){let i;if(typeof a=="boolean")i=a;else if(a.hasOwnProperty("$eq"))i=!!a.$eq;else if(a.hasOwnProperty("$ne"))i=!a.$ne;else if(a.hasOwnProperty("$exists"))i=!!a.$exists;else throw new Error("Invalid tag query");n.push([i?"IS NOT NULL":"IS NULL",["PARAM",s]])}else if(typeof a=="object"){if(Array.isArray(a))throw new Error("Invalid type");let i=[];for(let[o,c]of Object.entries(a)){if(o==="$eq")i.push(["=",["PARAM",s],c]);else if(o==="$ne")i.push(["OR",["<>",["PARAM",s],c],["IS NULL",["PARAM",s]]]);else if(o==="$lt")i.push(["<",["PARAM",s],c]);else if(o==="$lte")i.push(["<=",["PARAM",s],c]);else if(o==="$gt")i.push([">",["PARAM",s],c]);else if(o==="$gte")i.push([">=",["PARAM",s],c]);else throw new Error(`Operator ${o} not supported`);if(!["string","number","boolean"].includes(typeof c))throw new Error(`Invalid value for ${o} operator`)}if(i.length===1)n.push(i[0]);else if(i.length>1){let o=["AND"];n.push(o.concat(i))}}else n.push(["=",["PARAM",s],a]);return n.length===1?n[0]:n.length===0?!0:["AND",...n]}return Object.keys(e).length?t(e):!0}var h=V(require("parsimmon"));function Ya(e){let t={b:"\b",f:"\f",n:`
`,r:"\r",t:"	"};return e.replace(/\\(u[0-9a-fA-F]{4}|[^u])/g,(r,n)=>{let s=n.charAt(0),a=n.slice(1);return s==="u"?String.fromCharCode(parseInt(a,16)):t.hasOwnProperty(s)?t[s]:s})}function Ft(e,t){if(!Array.isArray(e))return t(e);let r;for(let n=1;n<e.length;++n){let s=Ft(e[n],t);s!==e[n]&&(r=r||e.slice(),r[n]=s)}return t(r||e)}async function Fr(e,t){if(!Array.isArray(e))return t(e);let r;for(let n=1;n<e.length;++n){let s=await Fr(e[n],t);s!==e[n]&&(r=r||e.slice(),r[n]=s)}return t(r||e)}function lt(e,t){return h.default.seqMap(t,h.default.seq(e,t).many(),(r,n)=>n.reduce((s,a)=>{let[i,o]=a;return Array.isArray(s)&&i===s[0]?s.concat([o]):[i,s,o]},r))}var xa=h.default.createLanguage({ComparisonOperator:function(){return h.default.alt(h.default.string(">="),h.default.string("<>"),h.default.string("<="),h.default.string("="),h.default.string(">"),h.default.string("<")).skip(h.default.optWhitespace)},LikeOperator:function(){return h.default.alt(h.default.regexp(/like/i).result("LIKE").desc("LIKE"),h.default.regexp(/not\s+like/i).result("NOT LIKE").desc("NOT LIKE")).notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace)},IsNullOperator:function(){return h.default.alt(h.default.regexp(/is\s+null/i).result("IS NULL").desc("IS NULL"),h.default.regexp(/is\s+not\s+null/i).result("IS NOT NULL").desc("IS NOT NULL")).notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace)},NotOperator:function(){return h.default.regexp(/not/i).result("NOT").notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace).desc("NOT")},AndOperator:function(){return h.default.regexp(/and/i).result("AND").notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace).desc("AND")},OrOperator:function(){return h.default.regexp(/or/i).result("OR").notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace).desc("OR")},Parameter:function(e){return h.default.alt(h.default.regexp(/[a-zA-Z0-9_.*-]+/),e.Expression.wrap(h.default.string("{").skip(h.default.optWhitespace),h.default.string("}"))).atLeast(1).map(t=>["PARAM",t.length>1?["||"].concat(t):t[0]]).skip(h.default.optWhitespace).desc("parameter")},StringValueSql:function(){return h.default.regexp(/'([^']*)'/,1).atLeast(1).skip(h.default.optWhitespace).map(e=>e.join("'")).desc("string")},StringValueJs:function(){return h.default.regexp(/"((?:\\.|.)*?)"/,1).skip(h.default.optWhitespace).map(Ya).desc("string")},NumberValue:function(){return h.default.regexp(/-?(0|[1-9][0-9]*)([.][0-9]+)?([eE][+-]?[0-9]+)?/).notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace).map(Number).desc("number")},BooleanValue:function(){return h.default.alt(h.default.regexp(/true/i).result(!0).desc("TRUE"),h.default.regexp(/false/i).result(!1).desc("FALSE")).notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace)},NullValue:function(){return h.default.regexp(/null/i).notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace).result(null).desc("NULL")},FuncValue:function(e){return h.default.seqMap(h.default.regexp(/([a-zA-Z0-9_]+)/,1).skip(h.default.optWhitespace).desc("function"),e.ExpressionList.wrap(h.default.string("(").skip(h.default.optWhitespace),h.default.string(")").skip(h.default.optWhitespace)),(t,r)=>["FUNC",t.toUpperCase()].concat(r))},WhenPair:function(e){return h.default.seq(h.default.regexp(/when/i).notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace).desc("WHEN").then(e.Expression),h.default.regexp(/then/i).notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace).desc("THEN").then(e.Expression))},CaseStatement:function(e){return h.default.seqMap(h.default.regexp(/case/i).result("CASE").notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace).desc("CASE"),e.WhenPair.many(),h.default.regexp(/else/i).notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/)).skip(h.default.optWhitespace).desc("ELSE").then(e.Expression).map(t=>[[!0,t]]).fallback(null).skip(h.default.regex(/end/i).notFollowedBy(h.default.regexp(/[a-zA-Z0-9_]/))).skip(h.default.optWhitespace),(...t)=>t.flat(2))},Value:function(e){return h.default.alt(e.NullValue,e.BooleanValue,e.NumberValue,e.StringValueSql,e.StringValueJs,e.FuncValue,e.CaseStatement)},ValueExpression:function(e){return lt(h.default.string("||").skip(h.default.optWhitespace),lt(h.default.alt(h.default.string("+"),h.default.string("-")).skip(h.default.optWhitespace),lt(h.default.alt(h.default.string("*"),h.default.string("/"),h.default.string("%")).skip(h.default.optWhitespace),h.default.alt(e.Value,e.Parameter,e.Expression.wrap(h.default.string("(").skip(h.default.optWhitespace),h.default.string(")").skip(h.default.optWhitespace))))))},Comparison:function(e){return h.default.alt(h.default.seqMap(e.ValueExpression,e.IsNullOperator,(t,r)=>[r,t]),h.default.seqMap(e.ValueExpression,e.ComparisonOperator,e.ValueExpression,(t,r,n)=>[r,t,n]),h.default.seqMap(e.ValueExpression,e.LikeOperator,e.ValueExpression.skip(h.default.regexp(/escape/i).result("ESCAPE").skip(h.default.whitespace).desc("ESCAPE")),e.ValueExpression,(t,r,n,s)=>[r,t,n,s]),h.default.seqMap(e.ValueExpression,e.LikeOperator,e.ValueExpression,(t,r,n)=>[r,t,n]))},ExpressionList:function(e){return e.Expression.sepBy(h.default.string(",").skip(h.default.optWhitespace))},Expression:function(e){function t(r,n){return h.default.seq(r,n).or(n)}return lt(e.OrOperator,lt(e.AndOperator,t(e.NotOperator,e.Comparison.or(e.ValueExpression)))).trim(h.default.optWhitespace)}});function jr(e){return e?xa.Expression.tryParse(e):null}function qn(e,t){let r=e.split("");for(let n=0;n<r.length;++n){let s=r[n];if(s===t)r[n]=r[n+1]||"",r[n+1]="";else if(s==="_")r[n]="\\_";else if(s==="%")for(r[n]="\\%";r[n+1]==="%";)r[++n]=""}return r.filter(n=>n)}var O=Array.isArray,jt=new WeakMap,Ne={};function Be(e,t){let r=!0;for(;r;){r=!1;for(let n=2;n<e.length;++n){let s=t(e[n-1],e[n],n-2);s!==Ne&&(r=!0,e=e.slice(),e.splice(n-1,2,s))}}return e.length===2?e[1]:e}function Wn(e,t="",r=""){let n={"-":"\\-","/":"\\/","\\":"\\/","^":"\\^",$:"\\$","*":"\\*","+":"\\+","?":"\\?",".":"\\.","(":"\\(",")":"\\)","|":"\\|","[":"\\[","]":"\\]","{":"\\{","}":"\\}","\\%":".*","\\_":"."},s=qn(e,t);if(!s.length)return new RegExp("^$",r);s=s.map(i=>n[i]||i),s[0]=s[0]===".*"?"":"^"+s[0];let a=s.length-1;return s[a]=[".*",""].includes(s[a])?"":s[a]+"$",new RegExp(s.join(""),r)}function He(e,t){return typeof e=="boolean"&&(e=+e),typeof t=="boolean"&&(t=+t),typeof e!=typeof t?typeof e=="string"?1:-1:e>t?1:e<t?-1:0}function J(e){switch(typeof e){case"number":return e;case"boolean":return+e;case"string":return parseFloat(e)||0}}function Ut(e){switch(typeof e){case"string":return e;case"number":return e.toString();case"boolean":return(+e).toString()}}function Bn(e){if(!Array.isArray(e))return e;if(e[0]==="CASE"){for(let t=1;t<e.length;t+=2){if(Array.isArray(e[t]))return e;if(e[t])return e[t+1]}return null}else if(e[0]==="FUNC"){if(e[1]==="COALESCE"){let t=[];for(let r=2;r<e.length;++r){let n=e[r];if(n!=null&&(t.push(n),!Array.isArray(n)))break}return t.length?t.length===1?t[0]:["FUNC","COALESCE",...t]:null}else if(e[1]==="UPPER"){if(e[2]==null)return null;if(!O(e[2]))return Ut(e[2]).toUpperCase()}else if(e[1]==="LOWER"){if(e[2]==null)return null;if(!O(e[2]))return Ut(e[2]).toLowerCase()}else if(e[1]==="ROUND"){let t=e[2],r=e.length>3?e[3]:0;if(t==null||r==null)return null;if(!O(t)&&!O(r)){let n=10**r,s=t*n*(1+Number.EPSILON);return Math.round(s)/n}}}else if(e[0]==="PARAM"){if(e[1]==null)return null}else if(e[0]==="AND"){for(let r=1;r<e.length;++r)if(!Array.isArray(e[r])&&e[r]!=null&&!e[r])return!1;let t=[];for(let r=1;r<e.length;++r){let n=e[r];if(n==null)return null;Array.isArray(n)&&(n[0]==="AND"?t.push(...n.slice(1)):t.push(n))}return t.length?(t.length===1&&t.push(!0),["AND",...t]):!0}else if(e[0]==="OR"){let t=[];for(let r=1;r<e.length;++r){let n=e[r];if(Array.isArray(n))n[0]==="OR"?t.push(...n.slice(1)):t.push(n);else if(n)return!0}return t.length?(t.length===1&&t.push(!1),["OR",...t]):e.some(r=>r==null)?null:!1}else if(e[0]==="NOT"){if(e[1]==null)return null;if(O(e[1])){if(e[1][0]==="NOT")return e[1][1]}else return!e[1]}else{if(e[0]==="IS NULL")return O(e[1])?e:e[1]==null;if(e[0]==="IS NOT NULL")return O(e[1])?e:e[1]!=null;if(e[0]==="LIKE"){if(O(e[1])||O(e[2])||O(e[3]))return e;if(e[1]==null||e[2]==null||e.length>=4&&e[3]==null)return null;let t=jt.get(e);return t||(t=Wn(e[2],e[3]),jt.set(e,t)),t.test(e[1])}else if(e[0]==="NOT LIKE"){if(O(e[1])||O(e[2])||O(e[3]))return e;if(e[1]==null||e[2]==null||e.length>=4&&e[3]==null)return null;let t=jt.get(e);return t||(t=Wn(e[2],e[3]),jt.set(e,t)),!t.test(e[1])}else{if(e[0]==="=")return e[1]==null||e[2]==null?null:O(e[1])||O(e[2])?e:He(e[1],e[2])===0;if(e[0]==="<>")return e[1]==null||e[2]==null?null:O(e[1])||O(e[2])?e:He(e[1],e[2])!==0;if(e[0]===">")return e[1]==null||e[2]==null?null:O(e[1])||O(e[2])?e:He(e[1],e[2])>0;if(e[0]===">=")return e[1]==null||e[2]==null?null:O(e[1])||O(e[2])?e:He(e[1],e[2])>=0;if(e[0]==="<")return e[1]==null||e[2]==null?null:O(e[1])||O(e[2])?e:He(e[1],e[2])<0;if(e[0]==="<=")return e[1]==null||e[2]==null?null:O(e[1])||O(e[2])?e:He(e[1],e[2])<=0;if(e[0]==="*")return Be(e,(t,r)=>t==null||r==null?null:!O(t)&&!O(r)?J(t)*J(r):Ne);if(e[0]==="/")return Be(e,(t,r,n)=>{if(t==null||r==null)return null;if(O(t)||O(r))return Ne;let s=J(t),a=J(r);return n!==0?s*a:a===0?null:s/a});if(e[0]==="+")return Be(e,(t,r)=>t==null||r==null?null:!O(t)&&!O(r)?J(t)+J(r):Ne);if(e[0]==="-")return Be(e,(t,r,n)=>t==null||r==null?null:!O(t)&&!O(r)?n===0?J(t)-J(r):J(t)+J(r):Ne);if(e[0]==="%")return Be(e,(t,r,n)=>{if(t==null||r==null)return null;if(O(t)||O(r)||n!==0)return Ne;let s=J(t),a=Math.trunc(J(r));return a===0?null:s%a});if(e[0]==="||")return Be(e,(t,r)=>t==null||r==null?null:!O(t)&&!O(r)?Ut(t)+Ut(r):Ne)}}return e}function pe(e,t,r,n){return Ft(e,s=>{if(n&&(s=n(s)),!O(s))return s;if(s[0]==="FUNC"&&s[1]==="NOW"){if(r)return r}else if(s[0]==="PARAM"){if(s[1]==null)return null;if(t&&!O(s[1])){let a;return typeof t=="function"?a=t(s[1]):a=t[s[1]],a==null?null:(typeof a=="object"&&(a=a.value?a.value[0]:null),a)}}return Bn(s)})}async function Hn(e,t,r,n){return Fr(e,async s=>{if(n&&(s=await n(s)),!O(s))return s;if(s[0]==="FUNC"){if(s[1]==="NOW"&&r)return r}else if(s[0]==="PARAM"){if(s[1]==null)return null;if(t&&!O(s[1])){let a=t[s[1]];return a==null?null:(typeof a=="object"&&(a=a.value?a.value[0]:null),a)}}return Bn(s)})}function Ur(e){let t=new Set;return Ft(e,r=>(O(r)&&r[0]==="PARAM"&&t.add(r[1]),r)),Array.from(t)}var ti=3e4,ri=+I("MAX_CACHE_TTL");async function Vt(e){let t=await P.cache.findOne({_id:e});return t==null?void 0:t.value}async function Gt(e,t,r=ri){let n=new Date,s=new Date(n.getTime()+ti+r*1e3);await P.cache.replaceOne({_id:e},{value:t,expire:s,timestamp:n},{upsert:!0})}async function qt(e){var r;return(r=(await P.cache.findOneAndDelete({_id:e})).value)==null?void 0:r.value}var zn=3e4;async function ze(e,t,r=0,n=Math.random().toString(36).slice(2)){try{let s=Date.now(),a=await P.locks.findOneAndUpdate({_id:e,value:n},{$set:{expire:new Date(s+t+zn)},$currentDate:{timestamp:!0}},{upsert:!0,returnDocument:"after"});if(Math.abs(a.value.timestamp.getTime()-s)>zn)throw new Error("Database clock skew too great")}catch(s){if(s.code!==11e3)throw s;if(!(r>0))return null;let a=50+Math.random()*50;return await new Promise(i=>setTimeout(i,a)),ze(e,t,r-a,n)}return n}async function Wt(e,t){if((await P.locks.deleteOne({_id:e,value:t})).deletedCount!==1)throw new Error("Lock expired")}var Bt=5e3,ai=12e4,Ht=class{constructor(t,r){this.cacheKey=t;this.callback=r}nextRefresh=1;currentRevision=null;snapshots=new Map;async getRevision(){return Date.now()>this.nextRefresh&&await this.refresh(),this.currentRevision}hasRevision(t){return this.snapshots.has(t)}get(t){let r=this.snapshots.get(t);if(!r)throw new Error("Cache snapshot does not exist");return r}async refresh(){if(!this.nextRefresh){await yt(20),await this.refresh();return}let t=Date.now();if(t<this.nextRefresh)return;this.nextRefresh=0;let r=await Vt(this.cacheKey);if(this.currentRevision&&r===this.currentRevision){this.nextRefresh=t+(Bt-t%Bt);return}let n=await ze(this.cacheKey,5e3),[s,a]=await this.callback();if(this.currentRevision){let i=this.currentRevision,o=this.snapshots.get(i);setTimeout(()=>{this.snapshots.get(i)===o&&this.snapshots.delete(i)},ai).unref()}this.currentRevision=s,this.snapshots.set(s,a),n&&(s!==r&&await Gt(this.cacheKey,s,300),await Wt(this.cacheKey,n)),this.nextRefresh=t+(Bt-t%Bt)}};function Kn(e,t="",r={}){for(let n of Object.keys(e)){let s=e[n];typeof s=="object"&&!Array.isArray(s)?Kn(s,`${t}${n}.`,r):r[`${t}${n}`]=s}return r}async function ii(){let e=await P.presets.find().toArray(),t=await P.objects.find().toArray();e.sort((s,a)=>s._id>a._id?1:-1),t.sort((s,a)=>s._id>a._id?1:-1);let r=ie.createHash("md5").update(JSON.stringify(e)).update(JSON.stringify(t)).digest("hex");t=t.map(s=>{var a;return s=Kn(s),(a=s._keys)!=null&&a.length||(s._keys=Object.keys(s).filter(i=>!i.startsWith("_"))),s}),e.sort((s,a)=>s.weight===a.weight?s._id>a._id?1:s._id<a._id?-1:0:s.weight-a.weight);let n=[];for(let s of e){le